<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 8.0.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="google/css2?family=Lato:ital,wght@0,300;0,400;0,700;1,300;1,400;1,700&family=PingFang+SC:ital,wght@0,300;0,400;0,700;1,300;1,400;1,700&family=Hiragino+Sans+GB:ital,wght@0,300;0,400;0,700;1,300;1,400;1,700&family=Microsoft+YaHei:ital,wght@0,300;0,400;0,700;1,300;1,400;1,700&family=sans-serif:ital,wght@0,300;0,400;0,700;1,300;1,400;1,700&family=Roboto:ital,wght@0,300;0,400;0,700;1,300;1,400;1,700&family='Noto+Serif+SC':ital,wght@0,300;0,400;0,700;1,300;1,400;1,700&family=Georgia:ital,wght@0,300;0,400;0,700;1,300;1,400;1,700&family=serif:ital,wght@0,300;0,400;0,700;1,300;1,400;1,700&family='JetBrains+Mono':ital,wght@0,300;0,400;0,700;1,300;1,400;1,700&family='Fira+Code':ital,wght@0,300;0,400;0,700;1,300;1,400;1,700&family=Consolas:ital,wght@0,300;0,400;0,700;1,300;1,400;1,700&family=Monaco:ital,wght@0,300;0,400;0,700;1,300;1,400;1,700&family=monospace:ital,wght@0,300;0,400;0,700;1,300;1,400;1,700&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" integrity="sha256-VHqXKFhhMxcpubYf9xiWdCiojEbY9NexQ4jh8AxbvcM=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Mist","darkmode":false,"version":"8.25.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"giscus","storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="记录学习过程中的思考、题解与复盘">
<meta property="og:type" content="website">
<meta property="og:title" content="nine19een&#39;s Blog">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="nine19een&#39;s Blog">
<meta property="og:description" content="记录学习过程中的思考、题解与复盘">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="nine19een">
<meta property="article:tag" content="算法, 算法竞赛, C++, 题解&#x2F;复盘">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>nine19een's Blog</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  






  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css" integrity="sha512-fHwaWebuwA7NSF5Qg/af4UeDx9XqUpYpOGgubo3yWu+b2IQR4UeQwbb42Ti7gVAjNtVoI/I9TEoYeu9omwcC6g==" crossorigin="anonymous" referrerpolicy="no-referrer" /><!-- hexo injector head_end end --></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">nine19een's Blog</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">一名大一cs新生的学习记录</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>







</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">nine19een</p>
  <div class="site-description" itemprop="description">记录学习过程中的思考、题解与复盘</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">8</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">22</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/12/11/P1637-INCSEQ-Fenwick-Tree-DP-for-Strictly-Increasing-Subsequences-of-Length-k/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="nine19een">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="nine19een's Blog">
      <meta itemprop="description" content="记录学习过程中的思考、题解与复盘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | nine19een's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/12/11/P1637-INCSEQ-Fenwick-Tree-DP-for-Strictly-Increasing-Subsequences-of-Length-k/" class="post-title-link" itemprop="url">从 洛谷 P1637 三元上升子序列 到 SPOJ INCSEQ —— 长度 k 严格上升子序列的树状数组模板</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2025-12-11 23:40:09" itemprop="dateCreated datePublished" datetime="2025-12-11T23:40:09+08:00">2025-12-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-12-12 00:57:47" itemprop="dateModified" datetime="2025-12-12T00:57:47+08:00">2025-12-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%AE%97%E6%B3%95%E9%A2%98%E8%A7%A3-%E5%A4%8D%E7%9B%98/" itemprop="url" rel="index"><span itemprop="name">算法题解/复盘</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>这篇文章记录我做 <strong>洛谷 P1637 三元上升子序列</strong> 和 <strong>SPOJ INCSEQ Increasing Subsequences</strong> 的过程，以及中途无意间发现的一套可以 <strong>通解“长度为 k 的严格上升子序列计数”</strong> 的模板。</p>
<p>大致路线：</p>
<ol>
<li>先从 P1637 出发，用<strong>两棵树状数组</strong>把“三元上升子序列”写成一个非常自然的过程；</li>
<li>再把这套写法抽象成数学形式，发现它其实已经是一个“按长度分层 + 按值域前缀和”的 DP 框架；</li>
<li>在 SPOJ INCSEQ 上把这个框架推广到「任意 k」，整理成一份可以直接丢进代码库的模板。</li>
</ol>
<hr>
<h2 id="第一部分：P1637-三元上升子序列（k-3）"><a href="#第一部分：P1637-三元上升子序列（k-3）" class="headerlink" title="第一部分：P1637 三元上升子序列（k &#x3D; 3）"></a>第一部分：P1637 三元上升子序列（k &#x3D; 3）</h2><h3 id="1-题面"><a href="#1-题面" class="headerlink" title="1. 题面"></a>1. 题面</h3><p><strong><a target="_blank" rel="noopener" href="https://www.luogu.com.cn/problem/P1637">Luogu P1637 三元上升子序列</a></strong></p>
<img src="/2025/12/11/P1637-INCSEQ-Fenwick-Tree-DP-for-Strictly-Increasing-Subsequences-of-Length-k/1.png" class="" title="P1637题面">

<p>信息提炼：</p>
<ul>
<li><p>目标是统计三元组</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo separator="true">,</mo><mi>k</mi><mo stretchy="false">)</mo><mspace width="1em"/><mtext>s.t. </mtext><mi>i</mi><mo>&lt;</mo><mi>j</mi><mo>&lt;</mo><mi>k</mi><mo separator="true">,</mo><mtext> </mtext><msub><mi>a</mi><mi>i</mi></msub><mo>&lt;</mo><msub><mi>a</mi><mi>j</mi></msub><mo>&lt;</mo><msub><mi>a</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">
  (i, j, k)\quad \text{s.t. } i &lt; j &lt; k,\ a_i &lt; a_j &lt; a_k
  </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose">)</span><span class="mspace" style="margin-right:1em;"></span><span class="mord text"><span class="mord">s.t. </span></span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mpunct">,</span><span class="mspace"> </span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8252em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span>
</li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>≤</mo><mi>n</mi><mo>≤</mo><mn>3</mn><mo>×</mo><msup><mn>10</mn><mn>4</mn></msup></mrow><annotation encoding="application/x-tex">1 \le n \le 3\times 10^4</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7804em;vertical-align:-0.136em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7719em;vertical-align:-0.136em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">3</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">4</span></span></span></span></span></span></span></span></span></span></span>，值域很大，需要离散化；</li>
<li><p>朴素 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><msup><mi>n</mi><mn>3</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n^3)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> 显然不行；</p>
</li>
<li><p>即使是 “枚举中点 j，然后往左往右扫” 的 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><msup><mi>n</mi><mn>2</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n^2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> 也过不了。</p>
</li>
</ul>
<p>所以需要一个 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mi>log</mi><mo>⁡</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n\log n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span> 级别的写法。</p>
<hr>
<h3 id="2-思路：按“长度”分层，而不是按“左右”切"><a href="#2-思路：按“长度”分层，而不是按“左右”切" class="headerlink" title="2. 思路：按“长度”分层，而不是按“左右”切"></a>2. 思路：按“长度”分层，而不是按“左右”切</h3><p>很多三元上升子序列的题解会强调：</p>
<ul>
<li>左边有多少个比 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">a_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> 小（记作 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mo stretchy="false">[</mo><mi>j</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">L[j]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">L</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mclose">]</span></span></span></span>）；</li>
<li>右边有多少个比 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">a_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> 大（记作 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi><mo stretchy="false">[</mo><mi>j</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">R[j]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mclose">]</span></span></span></span>）；</li>
<li>答案 &#x3D; <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mo>∑</mo><mi>j</mi></msub><mi>L</mi><mo stretchy="false">[</mo><mi>j</mi><mo stretchy="false">]</mo><mo>⋅</mo><mi>R</mi><mo stretchy="false">[</mo><mi>j</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">\sum_j L[j]\cdot R[j]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1858em;vertical-align:-0.4358em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.162em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4358em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">L</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mclose">]</span></span></span></span>。</li>
</ul>
<p>我事先并不知道这种题解里的标准做法，没有这么写，而是直接按“<strong>子序列的长度</strong>”来分层维护：</p>
<ul>
<li>长度为 1 的上升子序列：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(i)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mclose">)</span></span></span></span></li>
<li>长度为 2 的上升子序列：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(i, j)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mclose">)</span></span></span></span>，满足 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mo>&lt;</mo><mi>j</mi><mo separator="true">,</mo><mtext> </mtext><msub><mi>a</mi><mi>i</mi></msub><mo>&lt;</mo><msub><mi>a</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">i &lt; j,\ a_i &lt; a_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6986em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mpunct">,</span><span class="mspace"> </span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span></li>
<li>长度为 3 的上升子序列：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo separator="true">,</mo><mi>k</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(i, j, k)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose">)</span></span></span></span>，满足 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mo>&lt;</mo><mi>j</mi><mo>&lt;</mo><mi>k</mi><mo separator="true">,</mo><mtext> </mtext><msub><mi>a</mi><mi>i</mi></msub><mo>&lt;</mo><msub><mi>a</mi><mi>j</mi></msub><mo>&lt;</mo><msub><mi>a</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">i &lt; j &lt; k,\ a_i &lt; a_j &lt; a_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6986em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mpunct">,</span><span class="mspace"> </span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8252em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></li>
</ul>
<p>从左到右扫描下标 <code>pos</code>，当前值为 <code>a[pos] = p</code> 时，分三步：</p>
<ol>
<li>把当前值当成<strong>第三个元素</strong> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span><ul>
<li>统计所有“以前已经形成的、结尾值 &lt; p 的长度为 2 的上升子序列”的数量；</li>
<li>这些序列都可以接上 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span></span></span></span>，变成长度为 3 的上升子序列；</li>
</ul>
</li>
<li>把当前值当成<strong>第二个元素</strong> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span><ul>
<li>统计所有“结尾值 &lt; p 的长度为 1 的上升子序列”的数量；</li>
<li>这些和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span></span></span></span> 组成长度为 2 的上升子序列；</li>
</ul>
</li>
<li>把当前值当成<strong>第一个元素</strong> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span><ul>
<li>自身是一个长度为 1 的上升子序列。</li>
</ul>
</li>
</ol>
<p>这背后的数学形式可以抽象成两组函数：</p>
<ul>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mn>1</mn></msub><mo stretchy="false">(</mo><mi>v</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f_1(v)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mclose">)</span></span></span></span>：长度为 1、结尾值为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>v</mi></mrow><annotation encoding="application/x-tex">v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span></span></span> 的严格上升子序列个数；</li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mn>2</mn></msub><mo stretchy="false">(</mo><mi>v</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f_2(v)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mclose">)</span></span></span></span>：长度为 2、结尾值为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>v</mi></mrow><annotation encoding="application/x-tex">v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span></span></span> 的严格上升子序列个数。</li>
</ul>
<p>对当前值 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span></span></span></span>（离散后下标为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mi>d</mi><mi>x</mi></mrow><annotation encoding="application/x-tex">idx</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">i</span><span class="mord mathnormal">d</span><span class="mord mathnormal">x</span></span></span></span>），有：</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mtext>长度为 3 的新增数量</mtext></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><munder><mo>∑</mo><mrow><mi>u</mi><mo>&lt;</mo><mi>p</mi></mrow></munder><msub><mi>f</mi><mn>2</mn></msub><mo stretchy="false">(</mo><mi>u</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><msub><mi>f</mi><mn>2</mn></msub><mo stretchy="false">(</mo><mi>p</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>+</mo><mo>=</mo><munder><mo>∑</mo><mrow><mi>u</mi><mo>&lt;</mo><mi>p</mi></mrow></munder><msub><mi>f</mi><mn>1</mn></msub><mo stretchy="false">(</mo><mi>u</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><msub><mi>f</mi><mn>1</mn></msub><mo stretchy="false">(</mo><mi>p</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>+</mo><mo>=</mo><mn>1</mn></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{aligned}
\text{长度为 3 的新增数量} &amp;= \sum_{u &lt; p} f_2(u) \\
f_2(p) &amp;\mathrel{+}= \sum_{u &lt; p} f_1(u) \\
f_1(p) &amp;\mathrel{+}= 1
\end{aligned}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:6.9722em;vertical-align:-3.2361em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.7361em;"><span style="top:-5.7361em;"><span class="pstrut" style="height:3.05em;"></span><span class="mord"><span class="mord text"><span class="mord cjk_fallback">长度为</span><span class="mord"> 3 </span><span class="mord cjk_fallback">的新增数量</span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3.05em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">p</span><span class="mclose">)</span></span></span><span style="top:-0.4739em;"><span class="pstrut" style="height:3.05em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">p</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.2361em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.7361em;"><span style="top:-5.7361em;"><span class="pstrut" style="height:3.05em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.05em;"><span style="top:-1.9em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">u</span><span class="mrel mtight">&lt;</span><span class="mord mathnormal mtight">p</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.3861em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">u</span><span class="mclose">)</span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3.05em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel"><span class="mord">+</span></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.05em;"><span style="top:-1.9em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">u</span><span class="mrel mtight">&lt;</span><span class="mord mathnormal mtight">p</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.3861em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">u</span><span class="mclose">)</span></span></span><span style="top:-0.4739em;"><span class="pstrut" style="height:3.05em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel"><span class="mord">+</span></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.2361em;"><span></span></span></span></span></span></span></span></span></span></span></span>

<p>整体答案就是所有“长度为 3 的新增数量”的累加。</p>
<p>问题变成：如何高效支持“按值域求 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mo>∑</mo><mrow><mi>u</mi><mo>&lt;</mo><mi>p</mi></mrow></msub><msub><mi>f</mi><mi mathvariant="normal">ℓ</mi></msub><mo stretchy="false">(</mo><mi>u</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\sum_{u &lt; p} f_\ell(u)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1858em;vertical-align:-0.4358em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.0777em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">u</span><span class="mrel mtight">&lt;</span><span class="mord mathnormal mtight">p</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4358em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">ℓ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">u</span><span class="mclose">)</span></span></span></span>”——典型的前缀和 + 单点更新场景，直接上树状数组。</p>
<hr>
<h3 id="3-离散化-两棵树状数组"><a href="#3-离散化-两棵树状数组" class="headerlink" title="3. 离散化 &amp; 两棵树状数组"></a>3. 离散化 &amp; 两棵树状数组</h3><h4 id="3-1-值域离散化"><a href="#3-1-值域离散化" class="headerlink" title="3.1 值域离散化"></a>3.1 值域离散化</h4><p>因为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">a_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 值域不小，直接拿它做 BIT 下标不稳妥，先做离散化：</p>
<ol>
<li>把所有 <code>a[i]</code> 放进 <code>disperse</code>；</li>
<li>排序 + 去重；</li>
<li>对每个 <code>a[i]</code> 找到它在 <code>disperse</code> 中的下标（从 1 开始），记作 <code>idx</code>。</li>
</ol>
<p>之后所有树状数组下标都用这个 <code>idx</code>。</p>
<h4 id="3-2-两棵-Fenwick-Tree-的含义"><a href="#3-2-两棵-Fenwick-Tree-的含义" class="headerlink" title="3.2 两棵 Fenwick Tree 的含义"></a>3.2 两棵 Fenwick Tree 的含义</h4><p>代码中我开了两棵树：</p>
<ul>
<li><code>cnt_op</code><ul>
<li>维护 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mn>1</mn></msub><mo stretchy="false">(</mo><mi>v</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f_1(v)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mclose">)</span></span></span></span>，即“长度为 1 的上升子序列”的计数；</li>
<li>其实就是当前位置之前值为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>v</mi></mrow><annotation encoding="application/x-tex">v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span></span></span> 的元素出现次数；</li>
</ul>
</li>
<li><code>double_pair</code><ul>
<li>维护 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mn>2</mn></msub><mo stretchy="false">(</mo><mi>v</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f_2(v)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mclose">)</span></span></span></span>，即“长度为 2 的上升子序列”的计数；</li>
<li>记录所有以值 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>v</mi></mrow><annotation encoding="application/x-tex">v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span></span></span> 结尾的长度为 2 的上升子序列有多少个。</li>
</ul>
</li>
</ul>
<p>于是：</p>
<ul>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mo>∑</mo><mrow><mi>u</mi><mo>&lt;</mo><mi>p</mi></mrow></msub><msub><mi>f</mi><mn>1</mn></msub><mo stretchy="false">(</mo><mi>u</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\sum_{u &lt; p} f_1(u)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1858em;vertical-align:-0.4358em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.0777em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">u</span><span class="mrel mtight">&lt;</span><span class="mord mathnormal mtight">p</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4358em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">u</span><span class="mclose">)</span></span></span></span> 可以写成  
<code>query(idx - 1, cnt_op)</code>；</li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mo>∑</mo><mrow><mi>u</mi><mo>&lt;</mo><mi>p</mi></mrow></msub><msub><mi>f</mi><mn>2</mn></msub><mo stretchy="false">(</mo><mi>u</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\sum_{u &lt; p} f_2(u)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1858em;vertical-align:-0.4358em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.0777em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">u</span><span class="mrel mtight">&lt;</span><span class="mord mathnormal mtight">p</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4358em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">u</span><span class="mclose">)</span></span></span></span> 可以写成  
<code>query(idx - 1, double_pair)</code>。</li>
</ul>
<hr>
<h3 id="4-扫描过程-“从前往后滚”的正确性"><a href="#4-扫描过程-“从前往后滚”的正确性" class="headerlink" title="4. 扫描过程 &amp; “从前往后滚”的正确性"></a>4. 扫描过程 &amp; “从前往后滚”的正确性</h3><p>对每个 <code>p</code>，离散下标 <code>idx</code>，按顺序执行：</p>
<ol>
<li><strong>当前作为第三个元素 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span></strong></li>
</ol>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="normal">Δ</mi><mtext>ans</mtext><mo>=</mo><munder><mo>∑</mo><mrow><mi>u</mi><mo>&lt;</mo><mi>p</mi></mrow></munder><msub><mi>f</mi><mn>2</mn></msub><mo stretchy="false">(</mo><mi>u</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">
\Delta \text{ans} = \sum_{u &lt; p} f_2(u)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord">Δ</span><span class="mord text"><span class="mord">ans</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4361em;vertical-align:-1.3861em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.05em;"><span style="top:-1.9em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">u</span><span class="mrel mtight">&lt;</span><span class="mord mathnormal mtight">p</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.3861em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">u</span><span class="mclose">)</span></span></span></span></span>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ans += <span class="built_in">query</span>(idx - <span class="number">1</span>, double_pair);</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><strong>当前作为第二个元素 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span></strong></li>
</ol>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>f</mi><mn>2</mn></msub><mo stretchy="false">(</mo><mi>p</mi><mo stretchy="false">)</mo><mo>+</mo><mo>=</mo><munder><mo>∑</mo><mrow><mi>u</mi><mo>&lt;</mo><mi>p</mi></mrow></munder><msub><mi>f</mi><mn>1</mn></msub><mo stretchy="false">(</mo><mi>u</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">
f_2(p) \mathrel{+}= \sum_{u &lt; p} f_1(u)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">p</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel"><span class="mord">+</span></span></span><span class="base"><span class="strut" style="height:0.3669em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4361em;vertical-align:-1.3861em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.05em;"><span style="top:-1.9em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">u</span><span class="mrel mtight">&lt;</span><span class="mord mathnormal mtight">p</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.3861em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">u</span><span class="mclose">)</span></span></span></span></span>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">update</span>(idx, <span class="built_in">query</span>(idx - <span class="number">1</span>, cnt_op), double_pair, (ll)disperse.<span class="built_in">size</span>());</span><br></pre></td></tr></table></figure>

<ol start="3">
<li><strong>当前作为第一个元素 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span></strong></li>
</ol>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>f</mi><mn>1</mn></msub><mo stretchy="false">(</mo><mi>p</mi><mo stretchy="false">)</mo><mo>+</mo><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">
f_1(p) \mathrel{+}= 1
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">p</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel"><span class="mord">+</span></span></span><span class="base"><span class="strut" style="height:0.3669em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span></span>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">update</span>(idx, <span class="number">1</span>, cnt_op, (ll)disperse.<span class="built_in">size</span>());</span><br></pre></td></tr></table></figure>

<p>整个过程是从左到右扫描、从“长度 2”再到“长度 1”更新，看上去好像会担心“当前元素更新的结果被自己读到”。<br>但注意：</p>
<ul>
<li>所有 <code>query</code> 用的是 <code>idx - 1</code>；</li>
<li>Fenwick 的实现保证 <code>query(idx - 1)</code> <strong>只会访问 index &lt; idx 的位置</strong>；</li>
<li>而 <code>update(idx, ...)</code> 写的是 index ≥ idx 的节点。</li>
</ul>
<p>所以，无论是二维（P1637 的 f1&#x2F;f2）还是推广到 k 维（后文），<strong>从前往后滚完全不会读到当前元素刚写入的那一格</strong>，不存在污染问题。</p>
<hr>
<h3 id="5-P1637-最终-AC-代码"><a href="#5-P1637-最终-AC-代码" class="headerlink" title="5. P1637 最终 AC 代码"></a>5. P1637 最终 AC 代码</h3><blockquote>
<p>代码完全按我自己的写法保留，用 <code>vector + 离散化 + 两棵 Fenwick</code>。</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> ll = <span class="type">long</span> <span class="type">long</span>;</span><br><span class="line"><span class="type">const</span> ll maxn = <span class="number">3e4</span> + <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">ll n, ans;</span><br><span class="line">vector&lt;ll&gt; a, disperse;</span><br><span class="line"></span><br><span class="line"><span class="function">ll <span class="title">lowbit</span><span class="params">(ll x)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> x &amp; -x;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">update</span><span class="params">(ll x, ll add, vector&lt;ll&gt; &amp;tree, ll limit)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (ll i = x; i &lt;= limit; i += <span class="built_in">lowbit</span>(i)) &#123;</span><br><span class="line">        tree[i] += add;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">ll <span class="title">query</span><span class="params">(ll x, vector&lt;ll&gt; &amp;tree)</span> </span>&#123;</span><br><span class="line">    ll sum = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (ll i = x; i; i -= <span class="built_in">lowbit</span>(i)) &#123;</span><br><span class="line">        sum += tree[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ios_base::<span class="built_in">sync_with_stdio</span>(<span class="literal">false</span>);</span><br><span class="line">    cin.<span class="built_in">tie</span>(<span class="literal">nullptr</span>);</span><br><span class="line">    a.<span class="built_in">reserve</span>(maxn);</span><br><span class="line">    disperse.<span class="built_in">reserve</span>(maxn);</span><br><span class="line">    cin &gt;&gt; n;</span><br><span class="line">    <span class="keyword">for</span> (ll i = <span class="number">1</span>; i &lt;= n; ++i) &#123;</span><br><span class="line">        ll num;</span><br><span class="line">        cin &gt;&gt; num;</span><br><span class="line">        a.<span class="built_in">push_back</span>(num);</span><br><span class="line">        disperse.<span class="built_in">push_back</span>(num);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">sort</span>(disperse.<span class="built_in">begin</span>(), disperse.<span class="built_in">end</span>());</span><br><span class="line">    disperse.<span class="built_in">erase</span>(<span class="built_in">unique</span>(disperse.<span class="built_in">begin</span>(), disperse.<span class="built_in">end</span>()), disperse.<span class="built_in">end</span>());</span><br><span class="line">    <span class="function">vector&lt;ll&gt; <span class="title">double_pair</span><span class="params">(disperse.size() + <span class="number">5</span>, <span class="number">0</span>)</span></span>;</span><br><span class="line">    <span class="function">vector&lt;ll&gt; <span class="title">cnt_op</span><span class="params">(disperse.size() + <span class="number">5</span>, <span class="number">0</span>)</span></span>;</span><br><span class="line">    <span class="keyword">for</span> (ll p: a) &#123;</span><br><span class="line">        ll idx = <span class="built_in">lower_bound</span>(disperse.<span class="built_in">begin</span>(), disperse.<span class="built_in">end</span>(), p) - disperse.<span class="built_in">begin</span>() + <span class="number">1</span>;</span><br><span class="line">        ans += <span class="built_in">query</span>(idx - <span class="number">1</span>, double_pair);</span><br><span class="line">        <span class="built_in">update</span>(idx, <span class="built_in">query</span>(idx - <span class="number">1</span>, cnt_op), double_pair, (ll) disperse.<span class="built_in">size</span>());</span><br><span class="line">        <span class="built_in">update</span>(idx, <span class="number">1</span>, cnt_op, (ll) disperse.<span class="built_in">size</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    cout &lt;&lt; ans;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="/2025/12/11/P1637-INCSEQ-Fenwick-Tree-DP-for-Strictly-Increasing-Subsequences-of-Length-k/3.jpg" class="" title="手稿1">
<p>（一些做题时的草稿）</p>
<p>到这里，P1637 这道 k&#x3D;3 的问题就解决了。下面进入本文的重点：<strong>如何把这套写法推广到任意 k，并整理成模板。</strong></p>
<hr>
<h2 id="第二部分：从-P1637-到通用-k-阶模板-——-INCSEQ-实战"><a href="#第二部分：从-P1637-到通用-k-阶模板-——-INCSEQ-实战" class="headerlink" title="第二部分：从 P1637 到通用 k 阶模板 —— INCSEQ 实战"></a>第二部分：从 P1637 到通用 k 阶模板 —— INCSEQ 实战</h2><p>这一部分主要做三件事：</p>
<ol>
<li>用数学形式把上面的 P1637 写法彻底抽象；</li>
<li>在此基础上推广到任意长度 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span>；</li>
<li>用 <strong>SPOJ INCSEQ</strong> 这道典型题来验证模板，并给出最终代码。</li>
</ol>
<hr>
<h3 id="1-抽象-P1637-的-DP-结构"><a href="#1-抽象-P1637-的-DP-结构" class="headerlink" title="1. 抽象 P1637 的 DP 结构"></a>1. 抽象 P1637 的 DP 结构</h3><p>先把 P1637 的写法抽象出来。</p>
<p>对离散后的值域 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mn>1</mn><mo separator="true">,</mo><mi>m</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[1, m]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">m</span><span class="mclose">]</span></span></span></span>，对所有长度 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">ℓ</mi><mo>≥</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">\ell \ge 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8304em;vertical-align:-0.136em;"></span><span class="mord">ℓ</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≥</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span>，定义</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>f</mi><mi mathvariant="normal">ℓ</mi></msub><mo stretchy="false">(</mo><mi>v</mi><mo stretchy="false">)</mo><mo>=</mo><mtext>长度为 </mtext><mi mathvariant="normal">ℓ</mi><mtext>，结尾值离散下标为 </mtext><mi>v</mi><mtext> 的严格上升子序列个数</mtext></mrow><annotation encoding="application/x-tex">
f_\ell(v) = \text{长度为 }\ell\text{，结尾值离散下标为 }v\text{ 的严格上升子序列个数}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">ℓ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord text"><span class="mord cjk_fallback">长度为</span><span class="mord"> </span></span><span class="mord">ℓ</span><span class="mord text"><span class="mord cjk_fallback">，结尾值离散下标为</span><span class="mord"> </span></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord text"><span class="mord"> </span><span class="mord cjk_fallback">的严格上升子序列个数</span></span></span></span></span></span>

<p>在 P1637 中：</p>
<ul>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mn>1</mn></msub><mo stretchy="false">(</mo><mi>v</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f_1(v)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mclose">)</span></span></span></span> 
存放在 <code>cnt_op</code> 这棵树；</li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mn>2</mn></msub><mo stretchy="false">(</mo><mi>v</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f_2(v)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mclose">)</span></span></span></span> 
存放在 <code>double_pair</code> 这棵树；</li>
<li>每一轮扫描时，会新增一部分“长度为 3”的数量并累加到 <code>ans</code>，但不显式存 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mn>3</mn></msub><mo stretchy="false">(</mo><mi>v</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f_3(v)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mclose">)</span></span></span></span>。</li>
</ul>
<p>对当前元素值 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span></span></span></span>（下标 <code>idx</code>），转移可以统一写成：</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><msub><mi>f</mi><mn>1</mn></msub><mo stretchy="false">(</mo><mi>p</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>+</mo><mo>=</mo><mn>1</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><msub><mi>f</mi><mn>2</mn></msub><mo stretchy="false">(</mo><mi>p</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>+</mo><mo>=</mo><munder><mo>∑</mo><mrow><mi>u</mi><mo>&lt;</mo><mi>p</mi></mrow></munder><msub><mi>f</mi><mn>1</mn></msub><mo stretchy="false">(</mo><mi>u</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mtext>Ans</mtext></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>+</mo><mo>=</mo><munder><mo>∑</mo><mrow><mi>u</mi><mo>&lt;</mo><mi>p</mi></mrow></munder><msub><mi>f</mi><mn>2</mn></msub><mo stretchy="false">(</mo><mi>u</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{aligned}
f_1(p) &amp;\mathrel{+}= 1 \\[4pt]
f_2(p) &amp;\mathrel{+}= \sum_{u &lt; p} f_1(u) \\[4pt]
\text{Ans} &amp;\mathrel{+}= \sum_{u &lt; p} f_2(u)
\end{aligned}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:7.3722em;vertical-align:-3.4361em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.9361em;"><span style="top:-6.1461em;"><span class="pstrut" style="height:3.05em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">p</span><span class="mclose">)</span></span></span><span style="top:-4.0361em;"><span class="pstrut" style="height:3.05em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">p</span><span class="mclose">)</span></span></span><span style="top:-1.3em;"><span class="pstrut" style="height:3.05em;"></span><span class="mord"><span class="mord text"><span class="mord">Ans</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.4361em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.9361em;"><span style="top:-6.1461em;"><span class="pstrut" style="height:3.05em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel"><span class="mord">+</span></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord">1</span></span></span><span style="top:-4.0361em;"><span class="pstrut" style="height:3.05em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel"><span class="mord">+</span></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.05em;"><span style="top:-1.9em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">u</span><span class="mrel mtight">&lt;</span><span class="mord mathnormal mtight">p</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.3861em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">u</span><span class="mclose">)</span></span></span><span style="top:-1.3em;"><span class="pstrut" style="height:3.05em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel"><span class="mord">+</span></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.05em;"><span style="top:-1.9em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">u</span><span class="mrel mtight">&lt;</span><span class="mord mathnormal mtight">p</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.3861em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">u</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.4361em;"><span></span></span></span></span></span></span></span></span></span></span></span>

<p>如果我们愿意把 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mn>3</mn></msub></mrow><annotation encoding="application/x-tex">f_3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 也显式地存下来，那么：</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>f</mi><mn>3</mn></msub><mo stretchy="false">(</mo><mi>p</mi><mo stretchy="false">)</mo><mo>+</mo><mo>=</mo><munder><mo>∑</mo><mrow><mi>u</mi><mo>&lt;</mo><mi>p</mi></mrow></munder><msub><mi>f</mi><mn>2</mn></msub><mo stretchy="false">(</mo><mi>u</mi><mo stretchy="false">)</mo><mspace width="1em"/><mo>⇒</mo><mspace width="1em"/><mtext>Ans</mtext><mo>=</mo><munderover><mo>∑</mo><mrow><mi>v</mi><mo>=</mo><mn>1</mn></mrow><mi>m</mi></munderover><msub><mi>f</mi><mn>3</mn></msub><mo stretchy="false">(</mo><mi>v</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">
f_3(p) \mathrel{+}= \sum_{u &lt; p} f_2(u)
\quad\Rightarrow\quad
\text{Ans} = \sum_{v=1}^m f_3(v)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">p</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel"><span class="mord">+</span></span></span><span class="base"><span class="strut" style="height:0.3669em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4361em;vertical-align:-1.3861em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.05em;"><span style="top:-1.9em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">u</span><span class="mrel mtight">&lt;</span><span class="mord mathnormal mtight">p</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.3861em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">u</span><span class="mclose">)</span><span class="mspace" style="margin-right:1em;"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">⇒</span><span class="mspace" style="margin-right:1em;"></span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord text"><span class="mord">Ans</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.9185em;vertical-align:-1.2671em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-1.8829em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2671em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mclose">)</span></span></span></span></span>

<p>于是自然得到一个对于任意 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">ℓ</mi><mo>≥</mo><mn>2</mn></mrow><annotation encoding="application/x-tex">\ell \ge 2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8304em;vertical-align:-0.136em;"></span><span class="mord">ℓ</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≥</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">2</span></span></span></span> 的统一公式：</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>f</mi><mi mathvariant="normal">ℓ</mi></msub><mo stretchy="false">(</mo><mi>p</mi><mo stretchy="false">)</mo><mo>+</mo><mo>=</mo><munder><mo>∑</mo><mrow><mi>u</mi><mo>&lt;</mo><mi>p</mi></mrow></munder><msub><mi>f</mi><mrow><mi mathvariant="normal">ℓ</mi><mo>−</mo><mn>1</mn></mrow></msub><mo stretchy="false">(</mo><mi>u</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">
f_\ell(p) \mathrel{+}= \sum_{u &lt; p} f_{\ell-1}(u)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">ℓ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">p</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel"><span class="mord">+</span></span></span><span class="base"><span class="strut" style="height:0.3669em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4361em;vertical-align:-1.3861em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.05em;"><span style="top:-1.9em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">u</span><span class="mrel mtight">&lt;</span><span class="mord mathnormal mtight">p</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.3861em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">ℓ</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">u</span><span class="mclose">)</span></span></span></span></span>

<p>这就是“按长度分层做 DP，按值域用 Fenwick 求前缀和”的核心结构。</p>
<hr>
<h3 id="2-推广到任意-k：通用递推公式"><a href="#2-推广到任意-k：通用递推公式" class="headerlink" title="2. 推广到任意 k：通用递推公式"></a>2. 推广到任意 k：通用递推公式</h3><p>对于一般的“长度为 k 的严格上升子序列计数”，我们希望在处理完所有元素之后得到：</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>Answer</mtext><mo>=</mo><munderover><mo>∑</mo><mrow><mi>v</mi><mo>=</mo><mn>1</mn></mrow><mi>m</mi></munderover><msub><mi>f</mi><mi>k</mi></msub><mo stretchy="false">(</mo><mi>v</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">
\text{Answer} = \sum_{v=1}^{m} f_k(v)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord text"><span class="mord">Answer</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.9185em;vertical-align:-1.2671em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-1.8829em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2671em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mclose">)</span></span></span></span></span>

<p>转移规则推广为：</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>f</mi><mn>1</mn></msub><mo stretchy="false">(</mo><mi>v</mi><mo stretchy="false">)</mo><mo>+</mo><mo>=</mo><mn>1</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>f</mi><mi mathvariant="normal">ℓ</mi></msub><mo stretchy="false">(</mo><mi>v</mi><mo stretchy="false">)</mo><mo>+</mo><mo>=</mo><mstyle scriptlevel="0" displaystyle="true"><munder><mo>∑</mo><mrow><mi>u</mi><mo>&lt;</mo><mi>v</mi></mrow></munder><msub><mi>f</mi><mrow><mi mathvariant="normal">ℓ</mi><mo>−</mo><mn>1</mn></mrow></msub><mo stretchy="false">(</mo><mi>u</mi><mo stretchy="false">)</mo><mo separator="true">,</mo></mstyle></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>2</mn><mo>≤</mo><mi mathvariant="normal">ℓ</mi><mo>≤</mo><mi>k</mi></mrow></mstyle></mtd></mtr></mtable></mrow><annotation encoding="application/x-tex">
\begin{cases}
f_1(v) \mathrel{+}= 1 \\[4pt]
f_\ell(v) \mathrel{+}= \displaystyle\sum_{u &lt; v} f_{\ell-1}(u), &amp; 2 \le \ell \le k
\end{cases}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:4.2em;vertical-align:-1.85em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.35em;"><span style="top:-2.2em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style="top:-2.192em;"><span class="pstrut" style="height:3.15em;"></span><span style="height:0.316em;width:0.8889em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.8889em" height="0.316em" style="width:0.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0 H504 V316 H384z M384 0 H504 V316 H384z"/></svg></span></span><span style="top:-3.15em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style="top:-4.292em;"><span class="pstrut" style="height:3.15em;"></span><span style="height:0.316em;width:0.8889em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.8889em" height="0.316em" style="width:0.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0 H504 V316 H384z M384 0 H504 V316 H384z"/></svg></span></span><span style="top:-4.6em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.85em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.3337em;"><span style="top:-4.3757em;"><span class="pstrut" style="height:3.05em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel"><span class="mord">+</span></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord">1</span></span></span><span style="top:-2.4937em;"><span class="pstrut" style="height:3.05em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">ℓ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel"><span class="mord">+</span></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.05em;"><span style="top:-1.9em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">u</span><span class="mrel mtight">&lt;</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2774em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">ℓ</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">u</span><span class="mclose">)</span><span class="mpunct">,</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.8337em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.4937em;"><span style="top:-2.4937em;"><span class="pstrut" style="height:3.05em;"></span><span class="mord"><span class="mord">2</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord">ℓ</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.8337em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span>

<p>每一层对应一个 Fenwick 树：</p>
<ul>
<li><p>第 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">ℓ</mi></mrow><annotation encoding="application/x-tex">\ell</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord">ℓ</span></span></span></span> 层的 Fenwick 维护 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi mathvariant="normal">ℓ</mi></msub><mo stretchy="false">(</mo><mi>v</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f_\ell(v)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">ℓ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mclose">)</span></span></span></span> 在值域上的前缀和，因此</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><munder><mo>∑</mo><mrow><mi>u</mi><mo>&lt;</mo><mi>v</mi></mrow></munder><msub><mi>f</mi><mrow><mi mathvariant="normal">ℓ</mi><mo>−</mo><mn>1</mn></mrow></msub><mo stretchy="false">(</mo><mi>u</mi><mo stretchy="false">)</mo><mo>=</mo><mtext>Fenwick</mtext><mi mathvariant="normal">_</mi><mrow><mi mathvariant="normal">ℓ</mi><mo>−</mo><mn>1</mn></mrow><mi mathvariant="normal">.</mi><mi>q</mi><mi>u</mi><mi>e</mi><mi>r</mi><mi>y</mi><mo stretchy="false">(</mo><mtext>idx</mtext><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">
  \sum_{u &lt; v} f_{\ell-1}(u) = \text{Fenwick}\_{\ell-1}.query(\text{idx}-1)
  </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.3274em;vertical-align:-1.2774em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.05em;"><span style="top:-1.9em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">u</span><span class="mrel mtight">&lt;</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2774em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">ℓ</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">u</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"></span><span class="mord text"><span class="mord">Fenwick</span></span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord"><span class="mord">ℓ</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">1</span></span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mord mathnormal">u</span><span class="mord mathnormal" style="margin-right:0.03588em;">ery</span><span class="mopen">(</span><span class="mord text"><span class="mord">idx</span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span></span></li>
</ul>
<p>如果换成“数组写法”的 DP 形式，设</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>dp</mtext><mo stretchy="false">[</mo><mi mathvariant="normal">ℓ</mi><mo stretchy="false">]</mo><mo stretchy="false">[</mo><mi>v</mi><mo stretchy="false">]</mo><mo>=</mo><msub><mi>f</mi><mi mathvariant="normal">ℓ</mi></msub><mo stretchy="false">(</mo><mi>v</mi><mo stretchy="false">)</mo><mo separator="true">,</mo></mrow><annotation encoding="application/x-tex">
\text{dp}[\ell][v] = f_\ell(v),
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">dp</span></span><span class="mopen">[</span><span class="mord">ℓ</span><span class="mclose">]</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">ℓ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mclose">)</span><span class="mpunct">,</span></span></span></span></span>

<p>那么同样的转移可以写成：</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>dp</mtext><mo stretchy="false">[</mo><mn>1</mn><mo stretchy="false">]</mo><mo stretchy="false">[</mo><mi>v</mi><mo stretchy="false">]</mo><mo>+</mo><mo>=</mo><mn>1</mn><mo separator="true">,</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>dp</mtext><mo stretchy="false">[</mo><mi mathvariant="normal">ℓ</mi><mo stretchy="false">]</mo><mo stretchy="false">[</mo><mi>v</mi><mo stretchy="false">]</mo><mo>+</mo><mo>=</mo><mstyle scriptlevel="0" displaystyle="true"><munder><mo>∑</mo><mrow><mi>u</mi><mo>&lt;</mo><mi>v</mi></mrow></munder><mtext>dp</mtext><mo stretchy="false">[</mo><mi mathvariant="normal">ℓ</mi><mo>−</mo><mn>1</mn><mo stretchy="false">]</mo><mo stretchy="false">[</mo><mi>u</mi><mo stretchy="false">]</mo><mo separator="true">,</mo></mstyle></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>2</mn><mo>≤</mo><mi mathvariant="normal">ℓ</mi><mo>≤</mo><mi>k</mi><mi mathvariant="normal">.</mi></mrow></mstyle></mtd></mtr></mtable></mrow><annotation encoding="application/x-tex">
\begin{cases}
\text{dp}[1][v] \mathrel{+}= 1, \\[6pt]
\text{dp}[\ell][v] \mathrel{+}= \displaystyle\sum_{u &lt; v} \text{dp}[\ell-1][u], &amp; 2 \le \ell \le k.
\end{cases}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:4.3674em;vertical-align:-1.9337em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.35em;"><span style="top:-2.2em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style="top:-2.192em;"><span class="pstrut" style="height:3.15em;"></span><span style="height:0.316em;width:0.8889em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.8889em" height="0.316em" style="width:0.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0 H504 V316 H384z M384 0 H504 V316 H384z"/></svg></span></span><span style="top:-3.15em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style="top:-4.292em;"><span class="pstrut" style="height:3.15em;"></span><span style="height:0.316em;width:0.8889em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.8889em" height="0.316em" style="width:0.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0 H504 V316 H384z M384 0 H504 V316 H384z"/></svg></span></span><span style="top:-4.6em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.85em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.4337em;"><span style="top:-4.4757em;"><span class="pstrut" style="height:3.05em;"></span><span class="mord"><span class="mord text"><span class="mord">dp</span></span><span class="mopen">[</span><span class="mord">1</span><span class="mclose">]</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel"><span class="mord">+</span></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord">1</span><span class="mpunct">,</span></span></span><span style="top:-2.3937em;"><span class="pstrut" style="height:3.05em;"></span><span class="mord"><span class="mord text"><span class="mord">dp</span></span><span class="mopen">[</span><span class="mord">ℓ</span><span class="mclose">]</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel"><span class="mord">+</span></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.05em;"><span style="top:-1.9em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">u</span><span class="mrel mtight">&lt;</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2774em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord text"><span class="mord">dp</span></span><span class="mopen">[</span><span class="mord">ℓ</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">1</span><span class="mclose">]</span><span class="mopen">[</span><span class="mord mathnormal">u</span><span class="mclose">]</span><span class="mpunct">,</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.9337em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3937em;"><span style="top:-2.3937em;"><span class="pstrut" style="height:3.05em;"></span><span class="mord"><span class="mord">2</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord">ℓ</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord">.</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.9337em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span>

<p>再用 Fenwick 把右侧的“前缀和”这一项压缩到 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>log</mi><mo>⁡</mo><mi>m</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(\log m)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">m</span><span class="mclose">)</span></span></span></span> 即可。</p>
<hr>
<h3 id="3-这里为什么也可以“从前往后滚”？"><a href="#3-这里为什么也可以“从前往后滚”？" class="headerlink" title="3. 这里为什么也可以“从前往后滚”？"></a>3. 这里为什么也可以“从前往后滚”？</h3><p>注意上面的循环顺序（对应我的 INCSEQ 代码）：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (ll p: a) &#123;</span><br><span class="line">    <span class="type">int</span> idx = ...;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">2</span>; i &lt;= k; ++i) &#123;</span><br><span class="line">        <span class="built_in">update</span>(idx, <span class="built_in">query</span>(idx - <span class="number">1</span>, dp_tree[i - <span class="number">1</span>]), dp_tree[i], size);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">update</span>(idx, <span class="number">1</span>, dp_tree[<span class="number">1</span>], size);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>和很多 DP 不同，这里<strong>完全不需要从 k → 1 逆序</strong>，原因有两点：</p>
<ol>
<li>对固定的 <code>len</code>，我们读取的是上一层 <code>dp_tree[len - 1]</code>，<br>这一层在当前元素 <code>p</code> 的循环中，还没有被更新过；</li>
<li>即使在“长度维度”上有前后依赖（例如 len&#x3D;3 依赖 len&#x3D;2），<br>由于我们只查询 <code>query(idx - 1, dp_tree[len - 1])</code>，<br>而当前元素的新贡献只写在 <code>idx</code> 及其后的节点上，<br>所以这部分新贡献不会被读到。</li>
</ol>
<p>Fenwick 树的结构保证：</p>
<ul>
<li><code>update(idx, ...)</code> 只写 index ≥ idx 的节点；</li>
<li><code>query(idx - 1)</code> 只读 index ≤ idx - 1 的节点。</li>
</ul>
<p>因此：<br><strong>从前往后 len&#x3D;2..k 滚动是绝对安全的</strong>，每一层用到的永远都是“上一层在当前元素之前的状态”。</p>
<hr>
<h3 id="4-把模板落地：SPOJ-INCSEQ"><a href="#4-把模板落地：SPOJ-INCSEQ" class="headerlink" title="4. 把模板落地：SPOJ INCSEQ"></a>4. 把模板落地：SPOJ INCSEQ</h3><p><strong><a target="_blank" rel="noopener" href="https://www.spoj.com/problems/INCSEQ/">SPOJ INCSEQ - Increasing Subsequences</a></strong></p>
<img src="/2025/12/11/P1637-INCSEQ-Fenwick-Tree-DP-for-Strictly-Increasing-Subsequences-of-Length-k/2.png" class="" title="INCSEQ题面">

<p>题目大意：给定 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span>、<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> 和一个长度为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span> 的序列，统计<strong>长度恰好为 k 的严格上升子序列</strong>个数，对 MOD &#x3D; 5,000,000 取模。<br>约束大致为：</p>
<ul>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>≤</mo><mi>n</mi><mo>≤</mo><msup><mn>10</mn><mn>4</mn></msup></mrow><annotation encoding="application/x-tex">1 \le n \le 10^4</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7804em;vertical-align:-0.136em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7719em;vertical-align:-0.136em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">4</span></span></span></span></span></span></span></span></span></span></span></li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>≤</mo><mi>k</mi><mo>≤</mo><mn>50</mn></mrow><annotation encoding="application/x-tex">1 \le k \le 50</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7804em;vertical-align:-0.136em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8304em;vertical-align:-0.136em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">50</span></span></span></span></li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn><mo>≤</mo><msub><mi>a</mi><mi>i</mi></msub><mo>&lt;</mo><mn>100000</mn></mrow><annotation encoding="application/x-tex">0 \le a_i &lt; 100000</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7804em;vertical-align:-0.136em;"></span><span class="mord">0</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6891em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">100000</span></span></span></span></li>
</ul>
<p>与我们抽象出的模型完全一致，非常适合作为模板题。</p>
<hr>
<h3 id="5-实现细节解读"><a href="#5-实现细节解读" class="headerlink" title="5. 实现细节解读"></a>5. 实现细节解读</h3><p>结合我自己的 AC 代码，这里的关键点有几个：</p>
<h4 id="5-1-离散化"><a href="#5-1-离散化" class="headerlink" title="5.1 离散化"></a>5.1 离散化</h4><p>仍然通过 <code>coord</code> 进行排序 + 去重，把原始值映射到 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mn>1</mn><mo separator="true">,</mo><mi>s</mi><mi>i</mi><mi>z</mi><mi>e</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[1, size]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ze</span><span class="mclose">]</span></span></span></span>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sort</span>(coord.<span class="built_in">begin</span>(), coord.<span class="built_in">end</span>());</span><br><span class="line">coord.<span class="built_in">erase</span>(<span class="built_in">unique</span>(coord.<span class="built_in">begin</span>(), coord.<span class="built_in">end</span>()), coord.<span class="built_in">end</span>());</span><br><span class="line"><span class="type">int</span> size = (<span class="type">int</span>) coord.<span class="built_in">size</span>();</span><br><span class="line"><span class="type">int</span> idx = (<span class="type">int</span>) (<span class="built_in">lower_bound</span>(coord.<span class="built_in">begin</span>(), coord.<span class="built_in">end</span>(), p) - coord.<span class="built_in">begin</span>()) + <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>这样 Fenwick 的大小只需与 <code>size</code> 相关，而不受原值域限制。</p>
<h4 id="5-2-k-层-Fenwick-的组织方式"><a href="#5-2-k-层-Fenwick-的组织方式" class="headerlink" title="5.2 k 层 Fenwick 的组织方式"></a>5.2 k 层 Fenwick 的组织方式</h4><p>使用一个二维数组：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vector&lt;vector&lt;ll&gt; &gt; <span class="built_in">dp_tree</span>(k + <span class="number">5</span>, <span class="built_in">vector</span>&lt;ll&gt;(size + <span class="number">5</span>, <span class="number">0</span>));</span><br></pre></td></tr></table></figure>

<p>这里的含义是：</p>
<ul>
<li><code>dp_tree[len]</code> 是“长度为 len 的那一层 Fenwick 树内部数组”；</li>
<li><code>dp_tree[len][pos]</code> 就是 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi mathvariant="normal">ℓ</mi></msub><mo stretchy="false">(</mo><mi>v</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f_\ell(v)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">ℓ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mclose">)</span></span></span></span> 在树状数组上的内部节点。</li>
</ul>
<p>配合 <code>update</code> &#x2F; <code>query</code> 函数，这就形成了 k 层树状数组结构。</p>
<h4 id="5-3-模运算"><a href="#5-3-模运算" class="headerlink" title="5.3 模运算"></a>5.3 模运算</h4><p>代码里所有加法都通过</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tree[i] = (tree[i] + val) % MOD;</span><br><span class="line">sum = (sum + tree[i]) % MOD;</span><br></pre></td></tr></table></figure>

<p>保持在 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mtext>MOD</mtext><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">[0, \text{MOD})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord text"><span class="mord">MOD</span></span><span class="mclose">)</span></span></span></span> 内，防止溢出；<br>同时题目需要对 5,000,000 取模，这里直接在 Fenwick 的每一步更新里处理掉。</p>
<h4 id="5-4-复杂度"><a href="#5-4-复杂度" class="headerlink" title="5.4 复杂度"></a>5.4 复杂度</h4><p>对于每个元素 <code>p</code>：</p>
<ul>
<li>需要对 <code>len = 2..k</code> 做一次 <code>query + update</code>，每次是 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>log</mi><mo>⁡</mo><mi>s</mi><mi>i</mi><mi>z</mi><mi>e</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(\log size)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ze</span><span class="mclose">)</span></span></span></span>；</li>
<li>再对 <code>len = 1</code> 做一次 <code>update</code>。</li>
</ul>
<p>整体时间复杂度：</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>O</mi><mrow><mo fence="true">(</mo><mi>n</mi><mo>⋅</mo><mi>k</mi><mo>⋅</mo><mi>log</mi><mo>⁡</mo><mi>n</mi><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">
O\left(n \cdot k \cdot \log n\right)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">n</span><span class="mclose delimcenter" style="top:0em;">)</span></span></span></span></span></span>

<p>在 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>=</mo><msup><mn>10</mn><mn>4</mn></msup><mo separator="true">,</mo><mi>k</mi><mo>≤</mo><mn>50</mn></mrow><annotation encoding="application/x-tex">n = 10^4, k \le 50</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0085em;vertical-align:-0.1944em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">4</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">50</span></span></span></span> 的条件下是完全没压力的。</p>
<hr>
<h3 id="6-INCSEQ-最终-AC-代码"><a href="#6-INCSEQ-最终-AC-代码" class="headerlink" title="6. INCSEQ 最终 AC 代码"></a>6. INCSEQ 最终 AC 代码</h3><blockquote>
<p>这份代码是我在 SPOJ 上 AC 的版本，用的正是上面抽象出的模板思想。</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> ll = <span class="type">long</span> <span class="type">long</span>;</span><br><span class="line"><span class="type">const</span> ll maxn = <span class="number">1e4</span> + <span class="number">5</span>, MOD = <span class="number">5000000</span>;</span><br><span class="line"></span><br><span class="line">ll n, k;</span><br><span class="line">vector&lt;ll&gt; a, coord;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">lowbit</span><span class="params">(<span class="type">int</span> x)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> x &amp; -x;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">update</span><span class="params">(<span class="type">int</span> idx, ll val, vector&lt;ll&gt; &amp;tree, <span class="type">int</span> limit)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = idx; i &lt;= limit; i += <span class="built_in">lowbit</span>(i)) &#123;</span><br><span class="line">        tree[i] = (tree[i] + val) % MOD;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">ll <span class="title">query</span><span class="params">(<span class="type">int</span> idx, <span class="type">const</span> vector&lt;ll&gt; &amp;tree)</span> </span>&#123;</span><br><span class="line">    ll sum = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = idx; i; i -= <span class="built_in">lowbit</span>(i)) &#123;</span><br><span class="line">        sum = (sum + tree[i]) % MOD;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ios_base::<span class="built_in">sync_with_stdio</span>(<span class="literal">false</span>);</span><br><span class="line">    cin.<span class="built_in">tie</span>(<span class="literal">nullptr</span>);</span><br><span class="line">    a.<span class="built_in">reserve</span>(maxn);</span><br><span class="line">    coord.<span class="built_in">reserve</span>(maxn);</span><br><span class="line">    cin &gt;&gt; n &gt;&gt; k;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt;= n; ++i) &#123;</span><br><span class="line">        ll num;</span><br><span class="line">        cin &gt;&gt; num;</span><br><span class="line">        a.<span class="built_in">push_back</span>(num);</span><br><span class="line">        coord.<span class="built_in">push_back</span>(num);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">sort</span>(coord.<span class="built_in">begin</span>(), coord.<span class="built_in">end</span>());</span><br><span class="line">    coord.<span class="built_in">erase</span>(<span class="built_in">unique</span>(coord.<span class="built_in">begin</span>(), coord.<span class="built_in">end</span>()), coord.<span class="built_in">end</span>());</span><br><span class="line">    <span class="type">int</span> size = (<span class="type">int</span>) coord.<span class="built_in">size</span>();</span><br><span class="line">    vector&lt;vector&lt;ll&gt; &gt; <span class="built_in">dp_tree</span>(k + <span class="number">5</span>, <span class="built_in">vector</span>&lt;ll&gt;(size + <span class="number">5</span>, <span class="number">0</span>));</span><br><span class="line">    <span class="keyword">for</span> (ll p: a) &#123;</span><br><span class="line">        <span class="type">int</span> idx = (<span class="type">int</span>) (<span class="built_in">lower_bound</span>(coord.<span class="built_in">begin</span>(), coord.<span class="built_in">end</span>(), p) - coord.<span class="built_in">begin</span>()) + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">2</span>; i &lt;= k; ++i) &#123;</span><br><span class="line">            <span class="built_in">update</span>(idx, <span class="built_in">query</span>(idx - <span class="number">1</span>, dp_tree[i - <span class="number">1</span>]), dp_tree[i], size);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">update</span>(idx, <span class="number">1</span>, dp_tree[<span class="number">1</span>], size);</span><br><span class="line">    &#125;</span><br><span class="line">    cout &lt;&lt; <span class="built_in">query</span>(size, dp_tree[k]);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="/2025/12/11/P1637-INCSEQ-Fenwick-Tree-DP-for-Strictly-Increasing-Subsequences-of-Length-k/4.jpg" class="" title="手稿2">
<p>（另一些做题时的草稿）</p>
<hr>
<h2 id="总结：可以直接收进代码库的结论"><a href="#总结：可以直接收进代码库的结论" class="headerlink" title="总结：可以直接收进代码库的结论"></a>总结：可以直接收进代码库的结论</h2><p>用一句话概括这篇文章要留下的东西，就是这组状态转移：</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>f</mi><mn>1</mn></msub><mo stretchy="false">(</mo><mi>v</mi><mo stretchy="false">)</mo><mo>+</mo><mo>=</mo><mn>1</mn><mo separator="true">,</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>f</mi><mi mathvariant="normal">ℓ</mi></msub><mo stretchy="false">(</mo><mi>v</mi><mo stretchy="false">)</mo><mo>+</mo><mo>=</mo><mstyle scriptlevel="0" displaystyle="true"><munder><mo>∑</mo><mrow><mi>u</mi><mo>&lt;</mo><mi>v</mi></mrow></munder><msub><mi>f</mi><mrow><mi mathvariant="normal">ℓ</mi><mo>−</mo><mn>1</mn></mrow></msub><mo stretchy="false">(</mo><mi>u</mi><mo stretchy="false">)</mo><mo separator="true">,</mo></mstyle></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>2</mn><mo>≤</mo><mi mathvariant="normal">ℓ</mi><mo>≤</mo><mi>k</mi><mi mathvariant="normal">.</mi></mrow></mstyle></mtd></mtr></mtable></mrow><annotation encoding="application/x-tex">
\begin{cases}
f_1(v) \mathrel{+}= 1, \\[6pt]
f_\ell(v) \mathrel{+}= \displaystyle\sum_{u &lt; v} f_{\ell-1}(u), &amp; 2 \le \ell \le k.
\end{cases}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:4.3674em;vertical-align:-1.9337em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.35em;"><span style="top:-2.2em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style="top:-2.192em;"><span class="pstrut" style="height:3.15em;"></span><span style="height:0.316em;width:0.8889em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.8889em" height="0.316em" style="width:0.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0 H504 V316 H384z M384 0 H504 V316 H384z"/></svg></span></span><span style="top:-3.15em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style="top:-4.292em;"><span class="pstrut" style="height:3.15em;"></span><span style="height:0.316em;width:0.8889em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.8889em" height="0.316em" style="width:0.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0 H504 V316 H384z M384 0 H504 V316 H384z"/></svg></span></span><span style="top:-4.6em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.85em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.4337em;"><span style="top:-4.4757em;"><span class="pstrut" style="height:3.05em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel"><span class="mord">+</span></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord">1</span><span class="mpunct">,</span></span></span><span style="top:-2.3937em;"><span class="pstrut" style="height:3.05em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">ℓ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel"><span class="mord">+</span></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.05em;"><span style="top:-1.9em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">u</span><span class="mrel mtight">&lt;</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2774em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">ℓ</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">u</span><span class="mclose">)</span><span class="mpunct">,</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.9337em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3937em;"><span style="top:-2.3937em;"><span class="pstrut" style="height:3.05em;"></span><span class="mord"><span class="mord">2</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord">ℓ</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord">.</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.9337em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span>

<p>如果换成数组写法，设</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>dp</mtext><mo stretchy="false">[</mo><mi mathvariant="normal">ℓ</mi><mo stretchy="false">]</mo><mo stretchy="false">[</mo><mi>v</mi><mo stretchy="false">]</mo><mo>=</mo><msub><mi>f</mi><mi mathvariant="normal">ℓ</mi></msub><mo stretchy="false">(</mo><mi>v</mi><mo stretchy="false">)</mo><mo separator="true">,</mo></mrow><annotation encoding="application/x-tex">
\text{dp}[\ell][v] = f_\ell(v),
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">dp</span></span><span class="mopen">[</span><span class="mord">ℓ</span><span class="mclose">]</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">ℓ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mclose">)</span><span class="mpunct">,</span></span></span></span></span>

<p>则等价的 DP 形式是：</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>dp</mtext><mo stretchy="false">[</mo><mn>1</mn><mo stretchy="false">]</mo><mo stretchy="false">[</mo><mi>v</mi><mo stretchy="false">]</mo><mo>+</mo><mo>=</mo><mn>1</mn><mo separator="true">,</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>dp</mtext><mo stretchy="false">[</mo><mi mathvariant="normal">ℓ</mi><mo stretchy="false">]</mo><mo stretchy="false">[</mo><mi>v</mi><mo stretchy="false">]</mo><mo>+</mo><mo>=</mo><mstyle scriptlevel="0" displaystyle="true"><munder><mo>∑</mo><mrow><mi>u</mi><mo>&lt;</mo><mi>v</mi></mrow></munder><mtext>dp</mtext><mo stretchy="false">[</mo><mi mathvariant="normal">ℓ</mi><mo>−</mo><mn>1</mn><mo stretchy="false">]</mo><mo stretchy="false">[</mo><mi>u</mi><mo stretchy="false">]</mo><mo separator="true">,</mo></mstyle></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>2</mn><mo>≤</mo><mi mathvariant="normal">ℓ</mi><mo>≤</mo><mi>k</mi><mi mathvariant="normal">.</mi></mrow></mstyle></mtd></mtr></mtable></mrow><annotation encoding="application/x-tex">
\begin{cases}
\text{dp}[1][v] \mathrel{+}= 1, \\[6pt]
\text{dp}[\ell][v] \mathrel{+}= \displaystyle\sum_{u &lt; v} \text{dp}[\ell-1][u], &amp; 2 \le \ell \le k.
\end{cases}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:4.3674em;vertical-align:-1.9337em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.35em;"><span style="top:-2.2em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style="top:-2.192em;"><span class="pstrut" style="height:3.15em;"></span><span style="height:0.316em;width:0.8889em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.8889em" height="0.316em" style="width:0.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0 H504 V316 H384z M384 0 H504 V316 H384z"/></svg></span></span><span style="top:-3.15em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style="top:-4.292em;"><span class="pstrut" style="height:3.15em;"></span><span style="height:0.316em;width:0.8889em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.8889em" height="0.316em" style="width:0.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0 H504 V316 H384z M384 0 H504 V316 H384z"/></svg></span></span><span style="top:-4.6em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.85em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.4337em;"><span style="top:-4.4757em;"><span class="pstrut" style="height:3.05em;"></span><span class="mord"><span class="mord text"><span class="mord">dp</span></span><span class="mopen">[</span><span class="mord">1</span><span class="mclose">]</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel"><span class="mord">+</span></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord">1</span><span class="mpunct">,</span></span></span><span style="top:-2.3937em;"><span class="pstrut" style="height:3.05em;"></span><span class="mord"><span class="mord text"><span class="mord">dp</span></span><span class="mopen">[</span><span class="mord">ℓ</span><span class="mclose">]</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel"><span class="mord">+</span></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.05em;"><span style="top:-1.9em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">u</span><span class="mrel mtight">&lt;</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2774em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord text"><span class="mord">dp</span></span><span class="mopen">[</span><span class="mord">ℓ</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">1</span><span class="mclose">]</span><span class="mopen">[</span><span class="mord mathnormal">u</span><span class="mclose">]</span><span class="mpunct">,</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.9337em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3937em;"><span style="top:-2.3937em;"><span class="pstrut" style="height:3.05em;"></span><span class="mord"><span class="mord">2</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord">ℓ</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord">.</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.9337em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span>

<p>再用 Fenwick 把右侧的「前缀和」这一项压缩到 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>log</mi><mo>⁡</mo><mi>m</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(\log m)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">m</span><span class="mclose">)</span></span></span></span>，就得到一套：</p>
<ul>
<li>时间复杂度 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo>⋅</mo><mi>k</mi><mo>⋅</mo><mi>log</mi><mo>⁡</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n\cdot k \cdot \log n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span>；</li>
<li>支持任意 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> 的严格上升子序列计数；</li>
<li>可以轻松套在不同题目上的<strong>通用模板</strong>。</li>
</ul>
<p>P1637 是这套模板在 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mo>=</mo><mn>3</mn></mrow><annotation encoding="application/x-tex">k=3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">3</span></span></span></span> 情况下的“特例写法”；<br>INCSEQ 则是把这个结构完整展开的一道标准模板题。</p>
<p>后面如果再遇到“长度为 k 的严格上升子序列”相关题目，可以直接在这份代码基础上做修改和扩展，而不需要重新从头推思路。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/11/21/cf1065-xor/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="nine19een">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="nine19een's Blog">
      <meta itemprop="description" content="记录学习过程中的思考、题解与复盘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | nine19een's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/11/21/cf1065-xor/" class="post-title-link" itemprop="url">CF1065-C1/C2·复盘——浅谈 XOR 与博弈中的最高有效位</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2025-11-21 22:00:00" itemprop="dateCreated datePublished" datetime="2025-11-21T22:00:00+08:00">2025-11-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-11-22 00:19:00" itemprop="dateModified" datetime="2025-11-22T00:19:00+08:00">2025-11-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%AE%97%E6%B3%95%E9%A2%98%E8%A7%A3-%E5%A4%8D%E7%9B%98/" itemprop="url" rel="index"><span itemprop="name">算法题解/复盘</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <img src="/2025/11/21/cf1065-xor/3.gif" class="" title="XOR 博弈封面图">


<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>这一次的 CF1065 C1&#x2F;C2，是一对非常具有代表性的 XOR 博弈题。</p>
<p>在比赛当时，这两题看上去像是在操作数组、模拟交换，但真正的本质来自一个非常稳定的结构：</p>
<ul>
<li>一个在整个游戏过程中保持不变的整体异或 <code>T</code></li>
<li>一个决定双方 XOR 大小关系的最高有效位（msb）</li>
<li>以及一个能改变局势的“最后的关键下标”</li>
</ul>
<p>C1 是单 bit 游戏，C2 是多 bit 游戏，但二者的本质高度统一，甚至 C2 可以视为 C1 的自然推广。</p>
<p>文章会以“复盘 + 结构化分析”的方式来讲：</p>
<ul>
<li><strong>C1：理解最简 XOR 博弈</strong>（0&#x2F;1）</li>
<li><strong>C2：推广到 general XOR 博弈</strong>（≤10⁶）</li>
<li><strong>最后给出整个 XOR 博弈体系的总结</strong></li>
</ul>
<p>期间也会穿插 ASCII 示意图，帮助理解<strong>关键下标</strong>、<strong>最高有效位</strong>等结构。</p>
<p>下面进入正文。</p>
<hr>
<h2 id="C1-Renako-Amaori-and-XOR-Game-Easy-Version"><a href="#C1-Renako-Amaori-and-XOR-Game-Easy-Version" class="headerlink" title="C1. Renako Amaori and XOR Game (Easy Version)"></a><a target="_blank" rel="noopener" href="https://codeforces.com/contest/2171/problem/C1">C1. Renako Amaori and XOR Game (Easy Version)</a></h2><h3 id="题面"><a href="#题面" class="headerlink" title="题面"></a>题面</h3><img src="/2025/11/21/cf1065-xor/1.jpeg" class="" title="C1题面">

<h3 id="题目翻译"><a href="#题目翻译" class="headerlink" title="题目翻译"></a>题目翻译</h3><p>给定两个长度为 <code>n</code> 的数组 <code>a</code> 与 <code>b</code>，其中所有元素均为 <code>0</code> 或 <code>1</code>。<br>游戏共进行 <code>n</code> 回合：</p>
<ul>
<li>若 <code>i</code> 为奇数，则由 Ajisai 操作；</li>
<li>若 <code>i</code> 为偶数，则由 Mai 操作。</li>
</ul>
<p>在第 <code>i</code> 回合，操作者可以选择：</p>
<ul>
<li>交换 <code>a[i]</code> 与 <code>b[i]</code>，或</li>
<li>什么也不做（pass）</li>
</ul>
<p>游戏结束后，评分如下：</p>
<ul>
<li>Ajisai 的分数为：<code>a[1] ⊕ a[2] ⊕ ... ⊕ a[n]</code></li>
<li>Mai 的分数为：<code>b[1] ⊕ b[2] ⊕ ... ⊕ b[n]</code></li>
</ul>
<p>若分数不同，分数大的获胜；若分数相同，则为平局。</p>
<h3 id="整体异或不变量"><a href="#整体异或不变量" class="headerlink" title="整体异或不变量"></a>整体异或不变量</h3><p>任何一次交换都只是在同一个下标 <code>i</code> 位置交换 <code>a[i]</code> 与 <code>b[i]</code>。<br>这种操作不会改变 <code>a</code> 与 <code>b</code> 这两个序列中全部元素的集合，因此：</p>
<p><code>T = a 全体 ⊕ b 全体</code></p>
<p>在整个游戏过程中保持不变（这是整个 C1&#x2F;C2 的基础结构）。</p>
<p>同时还成立：</p>
<p><code>T = Ajisai_score ⊕ Mai_score</code></p>
<p>这意味着最终的胜负情况只由 <code>T</code> 决定。</p>
<ul>
<li><p>若 <code>T = 0</code><br>→ 两人的最终 XOR 完全相同<br>→ 游戏必为平局</p>
</li>
<li><p>若 <code>T = 1</code><br>→ 两人的最终 XOR 不可能相同<br>→ 必然分出胜负</p>
</li>
</ul>
<p>这一步是 C1 的基础，也是后续 C2 的关键出发点。</p>
<p>接下来进入 C1 的错误思路复盘。</p>
<h3 id="错误解法复盘：误以为“奇偶位置数量”决定胜负"><a href="#错误解法复盘：误以为“奇偶位置数量”决定胜负" class="headerlink" title="错误解法复盘：误以为“奇偶位置数量”决定胜负"></a>错误解法复盘：误以为“奇偶位置数量”决定胜负</h3><p>比赛时我最初写出的思路，是基于“统计差异所在的奇数位和偶数位数量”来判断谁能获胜：</p>
<ul>
<li><p>如果在 <strong>奇数位</strong>（Ajisai 能操作的位置）出现更多 <code>a[i] != b[i]</code> 的情况<br>→ Ajisai 更能“影响局势”，认为 Ajisai 会赢</p>
</li>
<li><p>如果在 <strong>偶数位</strong>（Mai 的回合）出现更多差异<br>→ Mai 会赢</p>
</li>
<li><p>如果数量相同，则认为是平局</p>
</li>
</ul>
<p>这是一个看似合理、实际上完全错误的判断。</p>
<h4 id="C1-WA-code（我当时的版本）"><a href="#C1-WA-code（我当时的版本）" class="headerlink" title="C1 WA code（我当时的版本）"></a>C1 WA code（我当时的版本）</h4><details>
<summary>C1 WA code</summary>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="type">int</span> <span class="type">const</span> maxn = <span class="number">2e5</span> + <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> t, a[maxn], b[maxn];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">op</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="type">int</span> n, cnt_odd = <span class="number">0</span>, cnt_even = <span class="number">0</span>;</span><br><span class="line">    cin &gt;&gt; n;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>; i &lt;= n; ++i)&#123;</span><br><span class="line">        cin &gt;&gt; a[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>; i &lt;= n; i++)&#123;</span><br><span class="line">        cin &gt;&gt; b[i];</span><br><span class="line">        <span class="keyword">if</span>(a[i] != b[i])&#123;</span><br><span class="line">            <span class="keyword">if</span>(i &amp; <span class="number">1</span>)&#123;</span><br><span class="line">                cnt_odd++;</span><br><span class="line">            &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">                cnt_even++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(cnt_odd &gt; cnt_even)&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Ajisai&quot;</span> &lt;&lt; <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(cnt_odd &lt; cnt_even)&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Mai&quot;</span> &lt;&lt; <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Tie&quot;</span> &lt;&lt; <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    ios_base::<span class="built_in">sync_with_stdio</span>(<span class="literal">false</span>);</span><br><span class="line">    cin.<span class="built_in">tie</span>(<span class="literal">nullptr</span>);</span><br><span class="line">    cin &gt;&gt; t;</span><br><span class="line">    <span class="keyword">while</span>(t--)&#123;</span><br><span class="line">        <span class="built_in">op</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</details>

<h3 id="错误原因分析"><a href="#错误原因分析" class="headerlink" title="错误原因分析"></a>错误原因分析</h3><p>根本问题在于：<br><strong>XOR 的胜负由唯一的关键下标决定，不由“数量”决定。</strong></p>
<p>在 C1 中，所有元素都是 <code>0/1</code>，若整体异或 <code>T = 1</code>，说明最终两人的分数一高一低，而大小关系由“最后一个能翻转该位的下标”决定。</p>
<p>也就是说：</p>
<blockquote>
<p>XOR 的比较不是累计效应，而是“最后一手效果”。</p>
</blockquote>
<p>为了更直观地说明问题，我们加入 ASCII 示意图。</p>
<h4 id="示意图（差异位置从后往前扫描）"><a href="#示意图（差异位置从后往前扫描）" class="headerlink" title="示意图（差异位置从后往前扫描）"></a>示意图（差异位置从后往前扫描）</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">i = 9   a=1 b=1</span><br><span class="line">i = 8   a=0 b=0</span><br><span class="line">i = 7   a=1 b=0   ← 最后一个差异，决定胜负</span><br><span class="line">i = 6   a=0 b=0</span><br><span class="line">i = 5   a=1 b=1</span><br><span class="line">i = 4   a=0 b=0</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>可以看到：</p>
<ul>
<li>下标越靠后，越决定最终的异或结果</li>
<li>只要在 <code>i = 7</code> 这里能动手，后面已无下标能覆盖它</li>
</ul>
<p>因此：</p>
<ul>
<li>若 <strong>最后的差异位</strong> 是奇数 → Ajisai 操作 → Ajisai 赢 （如示意图所示）</li>
<li>若 <strong>最后的差异位</strong> 是偶数 → Mai 操作 → Mai 赢</li>
</ul>
<p>无论前面有多少差异位，都被这个 <strong>最后的差异位</strong> 所覆盖。</p>
<h4 id="为什么统计数量会产生误导？"><a href="#为什么统计数量会产生误导？" class="headerlink" title="为什么统计数量会产生误导？"></a>为什么统计数量会产生误导？</h4><p>因为 <code>a[i] != b[i]</code> 是否出现多次完全不重要。<br>决定 XOR 大小关系的不是次数，而是：</p>
<blockquote>
<p>最后一个能改变哪一位的人是谁。</p>
</blockquote>
<p>在 C1 中，这个最后位置就是“最后一个差异点”。<br>由于 XOR 是按位运算，且 C1 只有一位（只有 <code>0/1</code>），因此：</p>
<ul>
<li>若 <code>a[i] != b[i]</code> 在 <code>i = k</code> 处是最后一次出现</li>
<li>那么 k 的操作者可以决定自己的最终 XOR 是 <code>1</code> 还是 <code>0</code></li>
</ul>
<p>从而直接确定胜负。</p>
<h4 id="错误点总结"><a href="#错误点总结" class="headerlink" title="错误点总结"></a>错误点总结</h4><ol>
<li>XOR 的大小不累加，受最后关键位影响</li>
<li>C1 只有一个 bit，所以只需找“最后一个差异位置”</li>
<li>差异出现次数完全不影响胜负</li>
<li>正确策略必须基于“顺序博弈 + 最后一手控制权”</li>
</ol>
<p>接下来进入 C1 的正确解法。</p>
<h3 id="C1-正确解法：最后一个差异下标的操作者获胜"><a href="#C1-正确解法：最后一个差异下标的操作者获胜" class="headerlink" title="C1 正确解法：最后一个差异下标的操作者获胜"></a>C1 正确解法：最后一个差异下标的操作者获胜</h3><p>C1 的核心在于：<br>当整体异或 <code>T = 1</code> 时，最终异或的大小完全由 <strong>最后一个能翻转该位的位置</strong> 决定。</p>
<p>我们已经在错误分析中看到：<br>只要知道差异的“最后一个下标”，就能判断胜负。</p>
<p>现在来严格说明这一结构。</p>
<h3 id="1-当-T-1-时，胜负由最后一个差异下标决定"><a href="#1-当-T-1-时，胜负由最后一个差异下标决定" class="headerlink" title="1. 当 T &#x3D; 1 时，胜负由最后一个差异下标决定"></a>1. 当 T &#x3D; 1 时，胜负由最后一个差异下标决定</h3><p>在 C1 中，所有元素都是 <code>0</code> 或 <code>1</code>。<br>最终的分数为：</p>
<ul>
<li><code>Ajisai_score = a[1] ⊕ ... ⊕ a[n]</code></li>
<li><code>Mai_score = b[1] ⊕ ... ⊕ b[n]</code></li>
</ul>
<p>因为 <code>T = Ajisai_score ⊕ Mai_score</code> 且 <code>T = 1</code>，<br>两者的分数必然一为 <code>0</code>、一为 <code>1</code>。</p>
<p>问题变为：</p>
<blockquote>
<p>谁能决定某个位置的值在最终 XOR 中是否被计为 <code>1</code>？</p>
</blockquote>
<h4 id="XOR-的按位独立性使得“顺序”变得关键"><a href="#XOR-的按位独立性使得“顺序”变得关键" class="headerlink" title="XOR 的按位独立性使得“顺序”变得关键"></a>XOR 的按位独立性使得“顺序”变得关键</h4><p>对于序列 <code>a</code>：</p>
<p><code>最终 a 的 XOR = (((a[1] ⊕ a[2]) ⊕ a[3]) ... ⊕ a[n])</code></p>
<p>如果我们从左到右分析：</p>
<ul>
<li>一个靠后的元素，其取值变化会覆盖所有更前面元素的影响</li>
<li>若前面某个差异位曾试图翻转结果，只要后面存在新的差异位，就可以再次翻转回来</li>
</ul>
<p>于是结论自然形成：</p>
<blockquote>
<p>在 C1 中，最后一个 <code>a[i] != b[i]</code> 的位置，是唯一有决定权的位置。</p>
</blockquote>
<h3 id="2-ASCII-示意图"><a href="#2-ASCII-示意图" class="headerlink" title="2. ASCII 示意图"></a>2. ASCII 示意图</h3><p>下面是完整示意图（同上，但放在正确解法体系中）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">i = 9   a=1 b=1</span><br><span class="line">i = 8   a=0 b=0</span><br><span class="line">i = 7   a=1 b=0   ← 决胜点（最末一个差异）</span><br><span class="line">i = 6   a=0 b=0</span><br><span class="line">i = 5   a=1 b=1</span><br><span class="line">i = 4   a=0 b=0</span><br><span class="line">i = 3   a=1 b=1</span><br><span class="line">i = 2   a=0 b=0</span><br><span class="line">i = 1   a=1 b=1</span><br></pre></td></tr></table></figure>

<ul>
<li>因为下标 <code>7</code> 是最后一个差异点</li>
<li>7 是奇数 → 该回合由 Ajisai 操作</li>
<li>Ajisai 可以通过“交换 &#x2F; 不交换”来决定 <code>a[7]</code> 是否变为 <code>1</code> 或 <code>0</code></li>
</ul>
<p>从而决定最终自己的 XOR 是否为 <code>1</code><br>→ 决定胜负。</p>
<p>若最后的差异下标是偶数，则由 Mai 控制。</p>
<h3 id="3-正确解法结论化"><a href="#3-正确解法结论化" class="headerlink" title="3. 正确解法结论化"></a>3. 正确解法结论化</h3><p>所以，在 C1 中：</p>
<ul>
<li>扫描从后往前找最后一个 <code>a[i] != b[i]</code> 的下标 <code>i</code></li>
<li>若不存在，则 <code>T = 0</code> → 平局</li>
<li>若存在：<ul>
<li><code>i</code> 为奇数 → Ajisai 胜</li>
<li><code>i</code> 为偶数 → Mai 胜</li>
</ul>
</li>
</ul>
<p>这是 C1 的完整正确解法。</p>
<h3 id="4-C1-AC-code"><a href="#4-C1-AC-code" class="headerlink" title="4. C1 AC code"></a>4. C1 AC code</h3><p><strong>说明</strong>：</p>
<p>下方给出的 AC 代码是我在比赛现场写出的实现方式：<br>逻辑正确，但偏向个人习惯，与本文推导出的理论模型略有差异。<br>在后续 C2 中，我会给出完全按本文结构写出的“规范解法版本”。</p>
<details>
<summary>C1 AC Code</summary>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="type">int</span> <span class="type">const</span> maxn = <span class="number">2e5</span> + <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> t, a[maxn], b[maxn];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">op</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> n, cnt_odd = <span class="number">0</span>, cnt_even = <span class="number">0</span>, cnt_1 = <span class="number">0</span>;</span><br><span class="line">    cin &gt;&gt; n;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt;= n; ++i) &#123;</span><br><span class="line">        cin &gt;&gt; a[i];</span><br><span class="line">        cnt_1 += a[i] ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt;= n; ++i) &#123;</span><br><span class="line">        cin &gt;&gt; b[i];</span><br><span class="line">        cnt_1 += b[i] ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (!(cnt_1 &amp; <span class="number">1</span>)) &#123;</span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;Tie&quot;</span> &lt;&lt; <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">bool</span> last_person; <span class="comment">//1-&gt;odd 0-&gt;even</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = n; i &gt;= <span class="number">1</span>; --i) &#123;</span><br><span class="line">            <span class="keyword">if</span> (a[i] != b[i]) &#123;</span><br><span class="line">                last_person = (i &amp; <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (last_person) &#123;</span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;Ajisai&quot;</span> &lt;&lt; <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;Mai&quot;</span> &lt;&lt; <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ios_base::<span class="built_in">sync_with_stdio</span>(<span class="literal">false</span>);</span><br><span class="line">    cin.<span class="built_in">tie</span>(<span class="literal">nullptr</span>);</span><br><span class="line">    cin &gt;&gt; t;</span><br><span class="line">    <span class="keyword">while</span> (t--) &#123;</span><br><span class="line">        <span class="built_in">op</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</details>

<hr>
<h2 id="C2-Renako-Amaori-and-XOR-Game-hard-version"><a href="#C2-Renako-Amaori-and-XOR-Game-hard-version" class="headerlink" title="C2. Renako Amaori and XOR Game (hard version)"></a><a target="_blank" rel="noopener" href="https://codeforces.com/contest/2171/problem/C2">C2. Renako Amaori and XOR Game (hard version)</a></h2><h3 id="题面-1"><a href="#题面-1" class="headerlink" title="题面"></a>题面</h3><img src="/2025/11/21/cf1065-xor/2.jpeg" class="" title="C2题面">

<h3 id="题目翻译-1"><a href="#题目翻译-1" class="headerlink" title="题目翻译"></a>题目翻译</h3><p>这一题是 C1 的加强版。<br>给定两个长度为 <code>n</code> 的数组 <code>a</code> 与 <code>b</code>，满足 <code>0 ≤ a[i], b[i] ≤ 10^6</code>。</p>
<p>游戏仍然进行 <code>n</code> 回合：</p>
<ul>
<li>若 <code>i</code> 为奇数，则该回合由 Ajisai 操作；</li>
<li>若 <code>i</code> 为偶数，则该回合由 Mai 操作。</li>
</ul>
<p>在第 <code>i</code> 回合，轮到的玩家可以选择：</p>
<ul>
<li>交换 <code>a[i]</code> 与 <code>b[i]</code>，或者</li>
<li>什么也不做（pass）</li>
</ul>
<p>游戏结束后，得分为：</p>
<ul>
<li>Ajisai 的分数：<code>a[1] ⊕ a[2] ⊕ ... ⊕ a[n]</code></li>
<li>Mai 的分数：<code>b[1] ⊕ b[2] ⊕ ... ⊕ b[n]</code></li>
</ul>
<p>分数更大者获胜，若分数相同则为平局。</p>
<p>与 C1 不同之处在于，这里 <code>a[i]</code> 和 <code>b[i]</code> 不再局限于 <code>0/1</code>，而是可以达到 <code>10^6</code>，也就是包含了更多二进制位，<code>T</code> 不再只可能是 <code>0</code> 或 <code>1</code>，而是一个多 bit 的整数。</p>
<h3 id="整体异或不变量（与-C1-相同的骨架）"><a href="#整体异或不变量（与-C1-相同的骨架）" class="headerlink" title="整体异或不变量（与 C1 相同的骨架）"></a>整体异或不变量（与 C1 相同的骨架）</h3><p>和 C1 完全一样，所有操作只在同一位置的 <code>a[i]</code> 与 <code>b[i]</code> 之间做交换，不会引入新数或删除旧数，因此：</p>
<p><code>T = a 全体 ⊕ b 全体</code></p>
<p>在整个游戏过程中仍然是一个不变量。</p>
<p>并且依然有：</p>
<p><code>T = Ajisai_score ⊕ Mai_score</code></p>
<p>所以：</p>
<ul>
<li><p>若 <code>T = 0</code><br>→ 两人的最终得分完全相同<br>→ 游戏必为 <code>Tie</code></p>
</li>
<li><p>若 <code>T ≠ 0</code><br>→ 两人的最终得分一定不同<br>→ 必分胜负</p>
</li>
</ul>
<p>到这里为止，C2 与 C1 的结构是同一套骨架：<br>只要整体异或为 <code>0</code>，游戏就没有悬念，直接平局。<br>当整体异或不为 <code>0</code>，问题就变成：<strong>谁能把最终的数值拉大到对自己有利</strong>。</p>
<p>区别在于：C1 中我们只需要处理一个 bit（0&#x2F;1），而 C2 中要面对的是一个多 bit 整数。</p>
<h3 id="为什么只看最高有效位（msb）"><a href="#为什么只看最高有效位（msb）" class="headerlink" title="为什么只看最高有效位（msb）"></a>为什么只看最高有效位（msb）</h3><p>当 <code>T ≠ 0</code> 时，<code>T</code> 是一个多 bit 的整数，例如：</p>
<p><code>T = 0010 1000 0100₂</code></p>
<p>这意味着在多个 bit 上，Ajisai 与 Mai 的最终结果存在差异。</p>
<p>但是，对于两个整数的比较，有一个非常重要的事实：</p>
<blockquote>
<p>两个整数的大小，只由它们在“最高一个不同的二进制位”上的值决定。</p>
</blockquote>
<p>也就是说：</p>
<ul>
<li>找到 <code>Ajisai_score</code> 与 <code>Mai_score</code> 在最高一个不同的 bit</li>
<li>在这个 bit 上谁是 <code>1</code>、谁是 <code>0</code>，谁就赢</li>
<li>在此之下的所有更低位，统一统统不重要</li>
</ul>
<p>而由于：</p>
<p><code>Ajisai_score ⊕ Mai_score = T</code></p>
<p>那么 <code>T</code> 在某一 bit 上为 <code>1</code>，就说明双方在这一位上必然不同。<br>特别地，在 <code>T</code> 的最高有效位（记作 <code>msb</code>）上，两人的得分在该位必然一高一低，并且这一位决定最终大小。</p>
<p>用一个 ASCII 示意图表示 <code>T</code> 的 bit 分布（示意）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bit11 bit10 bit9 ... bit3 bit2 bit1 bit0</span><br><span class="line">  1     0    1        0    1    0    0</span><br><span class="line">  ↑</span><br><span class="line">  msb（最高有效位）</span><br></pre></td></tr></table></figure>

<p>在 <code>bit11</code> 这个位置上，<code>T</code> 为 <code>1</code>，代表：</p>
<ul>
<li><code>Ajisai_score</code> 与 <code>Mai_score</code> 在 <code>bit11</code> 这一位上不相同</li>
<li>并且 <code>bit11</code> 是它们“从高到低第一个不相同的位”</li>
</ul>
<p>因此：</p>
<ul>
<li>谁能控制最终在 <code>bit11</code> 上取 <code>1</code>，谁就拥有整个数值比较上的优势</li>
<li>低位的翻转（<code>bit10</code> 以下）不会推翻这条结论</li>
</ul>
<p>换句话说，C2 虽然是多 bit 情况，但在博弈结构上 <strong>仍然退化成对 <code>msb</code> 这一位的控制问题</strong>：</p>
<blockquote>
<p>C2 的本质是：在最高有效位 <code>msb</code> 上进行一场 C1 风格的博弈。</p>
</blockquote>
<p>后面的分析要做的，就是精确刻画：<br><strong>谁拥有对这一位的“最后一次操作权”，也就是谁能在这一位上做出最终决策。</strong></p>
<h3 id="寻找能影响-msb-的最大下标-i-max"><a href="#寻找能影响-msb-的最大下标-i-max" class="headerlink" title="寻找能影响 msb 的最大下标 i_max"></a>寻找能影响 msb 的最大下标 <code>i_max</code></h3><p>我们已经知道：</p>
<ul>
<li>胜负由 <code>T</code> 的最高有效位 <code>msb</code> 决定</li>
<li>双方的 XOR 在这一位上必然不同</li>
<li>谁能控制最终这一位取值为 <code>1</code>，谁就赢</li>
</ul>
<p>现在的问题是：</p>
<blockquote>
<p>哪些下标 <code>i</code> 能影响 <code>msb</code> 这一位？<br>谁是最后一个能影响它的人？</p>
</blockquote>
<h4 id="关键判定条件"><a href="#关键判定条件" class="headerlink" title="关键判定条件"></a>关键判定条件</h4><p>在下标 <code>i</code>，交换与否会造成 <code>msb</code> 这一位的翻转，当且仅当：</p>
<p><code>((a[i] ⊕ b[i]) &gt;&gt; msb) &amp; 1 == 1</code></p>
<p>这句话的含义是：</p>
<ul>
<li><code>a[i] ⊕ b[i]</code> 在 <code>msb</code> 位上为 1</li>
<li>表示如果交换 <code>a[i]</code> 与 <code>b[i]</code>，那么这一位的贡献会发生改变</li>
<li>因此该下标可以真实影响最终比分的最高位</li>
</ul>
<p>我们称这样的下标为：</p>
<blockquote>
<p>“影响 msb 的有效下标”</p>
</blockquote>
<h4 id="为什么必须找“最大”的这样的下标？"><a href="#为什么必须找“最大”的这样的下标？" class="headerlink" title="为什么必须找“最大”的这样的下标？"></a>为什么必须找“最大”的这样的下标？</h4><p>因为游戏从 1 到 n 顺序进行，越靠后的回合越晚出现。<br>假设有下面五个可能影响 msb 的下标：</p>
<p><code>i = 2, 5, 8, 11, 14</code></p>
<p>真正能决定胜负的只有：</p>
<ul>
<li><strong>最后一个</strong>（即 <code>14</code>）</li>
<li>因为它会覆盖前面所有的决策效果</li>
<li>前面的影响都会被“后继修改”覆盖掉（同 C1）</li>
</ul>
<p>换句话说：</p>
<blockquote>
<p><code>i_max = 最后一个能影响 msb 的下标</code><br>是本题的唯一关键点。</p>
</blockquote>
<h3 id="ASCII-示意图（图示-3）"><a href="#ASCII-示意图（图示-3）" class="headerlink" title="ASCII 示意图（图示 #3）"></a>ASCII 示意图（图示 #3）</h3><p>下面以一个示例说明：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">i = 12   (a⊕b 在 msb 位为 1)</span><br><span class="line">i = 11   (a⊕b 在 msb 位为 0)</span><br><span class="line">i = 10   (a⊕b 在 msb 位为 1)</span><br><span class="line">i =  9   (a⊕b 在 msb 位为 1)   ← i_max（最后一个能影响 msb 的位置）</span><br><span class="line">i =  8   (a⊕b 在 msb 位为 0)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>即使 <code>i = 12</code> 和 <code>i = 10</code> 也能影响 <code>msb</code> 位，<br>但它们最终都被 <code>i = 9</code> 的操作“覆盖”了：</p>
<ul>
<li>游戏在第 9 回合有最后一次能够改变 msb 的机会</li>
<li>之后再没有任何下标能影响 msb</li>
<li>所以 <code>i = 9</code> 的操作者可以决定胜负</li>
</ul>
<h3 id="与-C1-的对应关系"><a href="#与-C1-的对应关系" class="headerlink" title="与 C1 的对应关系"></a>与 C1 的对应关系</h3><p>到这里可以看到，C2 的结构与 C1 完全对应：</p>
<table>
<thead>
<tr>
<th>C1 （0&#x2F;1）</th>
<th>C2（多 bit）</th>
</tr>
</thead>
<tbody><tr>
<td>最后一个 <code>a[i] != b[i]</code></td>
<td>最后一个 <code>(a[i] ⊕ b[i])</code> 在 <code>msb</code> 位上为 1</td>
</tr>
<tr>
<td>决定 XOR 的唯一位置</td>
<td>决定最高有效位的唯一位置</td>
</tr>
<tr>
<td>该位置的操作者获胜</td>
<td>该位置的操作者获胜</td>
</tr>
</tbody></table>
<p>可以理解为：</p>
<ul>
<li>C1 是一个“一维博弈”</li>
<li>C2 是一个“按 bit 拆开的多维博弈”，但胜负只看最高一维</li>
</ul>
<h3 id="如何根据-i-max-决定胜负"><a href="#如何根据-i-max-决定胜负" class="headerlink" title="如何根据 i_max 决定胜负"></a>如何根据 <code>i_max</code> 决定胜负</h3><p>规则非常简单：</p>
<ul>
<li><p>若 <code>i_max</code> 为奇数<br>→ Ajisai 操作<br>→ Ajisai 可以控制 msb 位置取 <code>1</code><br>→ <strong>Ajisai 获胜</strong></p>
</li>
<li><p>若 <code>i_max</code> 为偶数<br>→ Mai 操作<br>→ Mai 可以控制 msb 位置取 <code>1</code><br>→ <strong>Mai 获胜</strong></p>
</li>
</ul>
<p>这就是 C2 的最终结论。</p>
<h3 id="C2-算法流程与复杂度分析"><a href="#C2-算法流程与复杂度分析" class="headerlink" title="C2 算法流程与复杂度分析"></a>C2 算法流程与复杂度分析</h3><p>把前面的分析收束成一个完整的实现流程，大致可以写成如下步骤：</p>
<ol>
<li>读入 <code>n</code>，以及数组 <code>a</code>、<code>b</code></li>
<li>计算整体异或 <code>T</code>：<ul>
<li><code>T ^= a[i]</code></li>
<li><code>T ^= b[i]</code></li>
</ul>
</li>
<li>若 <code>T = 0</code>：<ul>
<li>直接输出 <code>Tie</code>，因为此时两人的最终分数必然相等</li>
</ul>
</li>
<li>若 <code>T ≠ 0</code>：<ul>
<li>在 <code>0 ~ 20</code> 的 bit 范围内，找到 <code>T</code> 的最高有效位 <code>msb</code></li>
<li>这一位是唯一决定胜负的关键 bit</li>
</ul>
</li>
<li>从后往前扫下标 <code>i = n ... 1</code>：<ul>
<li>判断 <code>(a[i] ⊕ b[i])</code> 的 <code>msb</code> 位是否为 <code>1</code></li>
<li>若是，则记录该 <code>i</code> 为 <code>i_max</code>，并停止扫描</li>
</ul>
</li>
<li>根据 <code>i_max</code> 的奇偶性输出胜负：<ul>
<li>若 <code>i_max</code> 为奇数 → Ajisai</li>
<li>若 <code>i_max</code> 为偶数 → Mai</li>
</ul>
</li>
</ol>
<h4 id="复杂度分析"><a href="#复杂度分析" class="headerlink" title="复杂度分析"></a>复杂度分析</h4><ul>
<li>计算整体异或 <code>T</code>：<code>O(n)</code></li>
<li>找 <code>msb</code>：bit 扫描，<code>O(log T)</code>，在本题中约为常数（约 20）</li>
<li>从后往前找 <code>i_max</code>：<code>O(n)</code></li>
<li>总体时间复杂度：<code>O(n)</code></li>
<li>空间复杂度：<code>O(n)</code>（存下 <code>a</code>、<code>b</code>）</li>
</ul>
<p>在 <code>n</code> 最多 <code>2 * 10^5</code> 的条件下，这个复杂度完全可以通过所有测试。</p>
<h3 id="C2-AC-code"><a href="#C2-AC-code" class="headerlink" title="C2 AC code"></a>C2 AC code</h3><details>
<summary>C2 AC Code</summary>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> t;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">op</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> n, xor_sum = <span class="number">0</span>, msb;</span><br><span class="line">    cin &gt;&gt; n;</span><br><span class="line">    <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">a</span><span class="params">(n + <span class="number">5</span>)</span>, <span class="title">b</span><span class="params">(n + <span class="number">5</span>)</span></span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt;= n; ++i) &#123;</span><br><span class="line">        cin &gt;&gt; a[i];</span><br><span class="line">        xor_sum ^= a[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt;= n; ++i) &#123;</span><br><span class="line">        cin &gt;&gt; b[i];</span><br><span class="line">        xor_sum ^= b[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!xor_sum) &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Tie&quot;</span> &lt;&lt; <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">20</span>; i &gt;= <span class="number">0</span>; --i) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="number">1</span> &amp; (xor_sum &gt;&gt; i)) &#123;</span><br><span class="line">            msb = i;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = n; i &gt; <span class="number">0</span>; --i) &#123;</span><br><span class="line">        <span class="keyword">if</span> (((a[i] ^ b[i]) &gt;&gt; msb) &amp; <span class="number">1</span>) &#123;</span><br><span class="line">            cout &lt;&lt; ((i &amp; <span class="number">1</span>) ? <span class="string">&quot;Ajisai&quot;</span> : <span class="string">&quot;Mai&quot;</span>) &lt;&lt; <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ios_base::<span class="built_in">sync_with_stdio</span>(<span class="literal">false</span>);</span><br><span class="line">    cin.<span class="built_in">tie</span>(<span class="literal">nullptr</span>);</span><br><span class="line">    cin &gt;&gt; t;</span><br><span class="line">    <span class="keyword">while</span> (t--) &#123;</span><br><span class="line">        <span class="built_in">op</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</details>

<hr>
<h2 id="XOR-小结与博弈结构回顾（总结）"><a href="#XOR-小结与博弈结构回顾（总结）" class="headerlink" title="XOR 小结与博弈结构回顾（总结）"></a>XOR 小结与博弈结构回顾（总结）</h2><p>整篇文章从 C1（0&#x2F;1 情况）到 C2（多 bit 情况），实际上围绕的是同一个中心主题：</p>
<blockquote>
<p>XOR 的结构性 —— 不变量、按位独立性、最高有效位的决定性<br>以及顺序博弈中“最后一个能改变关键位的人获胜”。</p>
</blockquote>
<p>下面将这套结构完整收束，作为本文的最终总结。</p>
<h3 id="1-XOR-的三个核心性质"><a href="#1-XOR-的三个核心性质" class="headerlink" title="1. XOR 的三个核心性质"></a>1. XOR 的三个核心性质</h3><p>在这两题中，真正起作用的只有 XOR 的三个基础性质：</p>
<ul>
<li><strong>按位独立性</strong>：高位与低位互不影响</li>
<li><strong>异或不变量</strong>：只交换位置不改变整体 XOR</li>
<li><strong>整数大小由最高不同位决定</strong>：这保证了 C2 只需处理 <code>msb</code> 一个 bit</li>
</ul>
<p>其中最关键的，是<strong>第三条</strong>：<br><strong>只要最高有效位差异已定，低位就无法影响最终大小</strong>。</p>
<p>因此，XOR 博弈的核心往往是：</p>
<blockquote>
<p>找到决定关键 bit 的最后一个位置。</p>
</blockquote>
<h3 id="2-C1：单-bit-游戏的“最后一手控制权”"><a href="#2-C1：单-bit-游戏的“最后一手控制权”" class="headerlink" title="2. C1：单 bit 游戏的“最后一手控制权”"></a>2. C1：单 bit 游戏的“最后一手控制权”</h3><p>在 C1 中：</p>
<ul>
<li>所有元素均为 <code>0</code> 或 <code>1</code></li>
<li>最终 XOR 只有一位</li>
<li>胜负完全由最后一个 <code>a[i] != b[i]</code> 的下标决定</li>
</ul>
<p>这是典型的“顺序博弈 + 最后一手胜”的结构。</p>
<h3 id="3-C2：多-bit-游戏，但仍然只需处理最高-bit"><a href="#3-C2：多-bit-游戏，但仍然只需处理最高-bit" class="headerlink" title="3. C2：多 bit 游戏，但仍然只需处理最高 bit"></a>3. C2：多 bit 游戏，但仍然只需处理最高 bit</h3><p>在 C2 中：</p>
<ul>
<li>元素的 bit 数更多</li>
<li>整体 XOR <code>T</code> 是一个多 bit 整数</li>
<li>但最终大小仍然只由 <code>T</code> 的最高有效位 <code>msb</code> 决定</li>
</ul>
<p>因此 C2 的实质是：</p>
<blockquote>
<p>在 <code>msb</code> 位上跑一遍 C1 的逻辑。</p>
</blockquote>
<p>具体表现为：</p>
<ul>
<li>寻找 <code>(a[i] ⊕ b[i])</code> 在 <code>msb</code> 位上为 <code>1</code> 的最后一个 <code>i</code></li>
<li>该 <code>i</code> 的操作者拥有决定权</li>
<li>奇数位 → Ajisai</li>
<li>偶数位 → Mai</li>
</ul>
<p>和 C1 完全平行。</p>
<h3 id="4-一类-XOR-博弈题的通用做法"><a href="#4-一类-XOR-博弈题的通用做法" class="headerlink" title="4. 一类 XOR 博弈题的通用做法"></a>4. 一类 XOR 博弈题的通用做法</h3><p>通过这两题，我们可以抽象出一类常见 XOR 博弈题的解法框架：</p>
<ol>
<li><strong>找不变量</strong>：整体 XOR 是否为固定？</li>
<li><strong>判断平局条件</strong>：如果整体 XOR 为 0，一般直接平局</li>
<li><strong>找关键 bit</strong>：通常是 <code>msb</code></li>
<li><strong>定位关键下标</strong>：最后一个能影响关键 bit 的地方</li>
<li><strong>按回合归属输出胜负</strong></li>
</ol>
<p>许多看似复杂的 XOR 博弈，其实都可以被拆解成这种结构。</p>
<h3 id="5-本文的意义与后续思考"><a href="#5-本文的意义与后续思考" class="headerlink" title="5. 本文的意义与后续思考"></a>5. 本文的意义与后续思考</h3><p>这篇文章不仅解决了 C1 &#x2F; C2，也为之后处理此类问题奠定了统一视角：</p>
<ul>
<li>遇到异或类博弈时，先看是否有“不变量”</li>
<li>再看是否能按 bit 拆分</li>
<li>若能拆分，最高有效位通常是核心</li>
<li>判断回合顺序是否决定胜负</li>
<li>是否存在“最后一个能翻转关键位的位置”</li>
</ul>
<p>XOR 本身的逻辑并不复杂，但要真正理解它在博弈中的作用，需要对<br>“按位独立 + 顺序控制” 有清晰认识。</p>
<p>以上便是本篇的全部内容。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/11/03/Luogu-P1121-CircularTwoSegmentSum/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="nine19een">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="nine19een's Blog">
      <meta itemprop="description" content="记录学习过程中的思考、题解与复盘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | nine19een's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/11/03/Luogu-P1121-CircularTwoSegmentSum/" class="post-title-link" itemprop="url">洛谷-P1121-环状最大两段子段和·复盘——续谈环形DP</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2025-11-03 15:00:00" itemprop="dateCreated datePublished" datetime="2025-11-03T15:00:00+08:00">2025-11-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-11-21 22:00:42" itemprop="dateModified" datetime="2025-11-21T22:00:42+08:00">2025-11-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%AE%97%E6%B3%95%E9%A2%98%E8%A7%A3-%E5%A4%8D%E7%9B%98/" itemprop="url" rel="index"><span itemprop="name">算法题解/复盘</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>本文复盘洛谷 <strong><a target="_blank" rel="noopener" href="https://www.luogu.com.cn/problem/P1121">P1121 环状最大两段子段和</a></strong> 的解题过程。本次复盘的核心算法思路，即 <strong>分类讨论</strong> 结合 <strong>对偶思想</strong>，在初版实现中就是正确的。然而，一个由 <strong>非空</strong> 约束导致的边界情况，使得初版代码无法通过全部测试点。本文将详细分析该边界情况的触发机理，并展示如何通过一行代码进行修复，将<code>80</code>分的实现修正为<code>100</code>分的最终解。</p>
<hr>
<h3 id="题目分析"><a href="#题目分析" class="headerlink" title="题目分析"></a>题目分析</h3><img src="/2025/11/03/Luogu-P1121-CircularTwoSegmentSum/1.png" class="" title="题面">

<p>提炼题目要素：</p>
<ol>
<li><strong>布局</strong>：<strong>环形</strong> 排列。<code>a[1]</code> 和 <code>a[n]</code> 相邻。这意味着一个连续子段可以从数组尾部跨越到头部。</li>
<li><strong>目标</strong>：选出 <strong>两段</strong> <strong>不重叠</strong> 且 <strong>非空</strong> 的连续子段，使其和最大。<strong>非空</strong> 约束是处理边界情况的关键。</li>
<li><strong>约束</strong>：<code>N</code>最大为<code>2e5</code>，算法的时间复杂度必须是<code>O(N)</code>或<code>O(N log N)</code>。</li>
</ol>
<p>此问题需要在环形结构上求解两段子段的和的最大值。重点在于设计一个线性时间复杂度的算法，以处理 <strong>环形结构</strong> 和 <strong>两段选择</strong> 的双重约束。</p>
<hr>
<h3 id="算法设计及实现"><a href="#算法设计及实现" class="headerlink" title="算法设计及实现"></a>算法设计及实现</h3><h4 id="V1-0-初版实现-80分"><a href="#V1-0-初版实现-80分" class="headerlink" title="V1.0 初版实现 (80分)"></a>V1.0 初版实现 (80分)</h4><h5 id="设计"><a href="#设计" class="headerlink" title="设计"></a>设计</h5><p>在环形结构上直接进行动态规划，因其缺少固定起终点而难以定义状态。因此，采用标准方法，将环形问题分解为线性问题进行处理。</p>
<p>对所有可能的两段子段的选择，按其是否跨越 <code>a[1]</code> 和 <code>a[n]</code> 的连接点，可分为两种情况：</p>
<ol>
<li><strong>情况一：选择的两段不跨越 <code>a[1]</code>-<code>a[n]</code> 的连接点。</strong><ul>
<li><strong>问题转化</strong>: 此情况等价于在 <strong>链</strong> <code>a[1...n]</code> 上寻找最大两段子段和。</li>
<li><strong>解决方案</strong>: 通过枚举分割点来解决。链上的两段最优解 <code>S1</code> 和 <code>S2</code> 之间必定存在一个分割点。<br>a.  通过动态规划预处理计算两个辅助数组：<ul>
<li><code>max_L_to_R[i]</code>：存储 <strong>前缀区间 <code>a[1...i]</code> 内的最大单段子段和</strong>。</li>
<li><code>max_R_to_L[i]</code>：存储 <strong>后缀区间 <code>a[i...n]</code> 内的最大单段子段和</strong>。<br>b.  遍历所有可能的分割点 <code>i</code> (<code>1</code> 到 <code>n-1</code>)，计算 <code>max_L_to_R[i] + max_R_to_L[i+1]</code>。<br>c.  这些和中的最大值，即为情况一的解。</li>
</ul>
</li>
</ul>
</li>
</ol>
<img src="/2025/11/03/Luogu-P1121-CircularTwoSegmentSum/2.jpg" class="" title="手稿1">

<ol start="2">
<li><strong>情况二：选择的两段跨越 <code>a[1]</code>-<code>a[n]</code> 的连接点。</strong><ul>
<li><strong>问题转化</strong>: 此情况指一段位于数组尾部，另一段位于头部。为简化计算，采用对偶思想。</li>
<li><strong>逻辑原理</strong>: <code>(选中元素的和) = (数组总和) - (未选中元素的和)</code>。</li>
<li><strong>核心观察</strong>: 若选中的部分是 <strong>跨界</strong> 的，则未选中的部分必然是 <strong>不跨界</strong> 的。</li>
<li><strong>再次转化</strong>: 最大化 <strong>选中元素的和</strong>，等价于最小化 <strong>未选中元素的和</strong>。</li>
<li><strong>解决方案</strong>:<br>a.  问题转化为：在 <strong>链</strong> <code>a[1...n]</code> 上，寻找 <strong>最小两段子段和</strong>。<br>b.  采用与情况一对称的方法，计算 <code>min_L_to_R</code> 和 <code>min_R_to_L</code> 数组，求出链上的最小两段和。<br>c.  用 <code>数组总和</code> 减去此值，即为情况二的解。</li>
</ul>
</li>
</ol>
<img src="/2025/11/03/Luogu-P1121-CircularTwoSegmentSum/3.jpg" class="" title="手稿2">

<p>最终答案为 <code>max(情况一的解, 情况二的解)</code>。该算法的时间复杂度为<code>O(N)</code>。</p>
<h5 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h5><img src="/2025/11/03/Luogu-P1121-CircularTwoSegmentSum/4.png" class="" title="80分提交记录">

<p><a target="_blank" rel="noopener" href="https://www.luogu.com.cn/record/244799120">80分提交记录</a></p>
<details>
<summary>点击展开/折叠 V1.0 80分代码</summary>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> ll = <span class="type">long</span> <span class="type">long</span>;</span><br><span class="line">ll <span class="type">const</span> maxn = <span class="number">2e5</span> + <span class="number">5</span>, minn = <span class="number">-1e9</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> n;</span><br><span class="line">ll total_a, a[maxn], max_L_to_R[maxn], dp_max_L_to_R[maxn], max_R_to_L[maxn], dp_max_R_to_L[maxn], min_L_to_R[maxn], dp_min_L_to_R[maxn], min_R_to_L[maxn], dp_min_R_to_L[maxn];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">find_L_to_R</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ll max_val = minn, min_val = maxn;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt;= n; ++i) &#123;</span><br><span class="line">        dp_max_L_to_R[i] = <span class="built_in">max</span>(dp_max_L_to_R[i - <span class="number">1</span>] + a[i], a[i]);</span><br><span class="line">        max_val = <span class="built_in">max</span>(max_val, dp_max_L_to_R[i]);</span><br><span class="line">        max_L_to_R[i] = max_val;</span><br><span class="line">        dp_min_L_to_R[i] = <span class="built_in">min</span>(dp_min_L_to_R[i - <span class="number">1</span>] + a[i], a[i]);</span><br><span class="line">        min_val = <span class="built_in">min</span>(min_val, dp_min_L_to_R[i]);</span><br><span class="line">        min_L_to_R[i] = min_val;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">find_R_to_L</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ll max_val = minn, min_val = maxn;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = n; i &gt;= <span class="number">1</span>; --i) &#123;</span><br><span class="line">        dp_max_R_to_L[i] = <span class="built_in">max</span>(dp_max_R_to_L[i + <span class="number">1</span>] + a[i], a[i]);</span><br><span class="line">        max_val = <span class="built_in">max</span>(max_val, dp_max_R_to_L[i]);</span><br><span class="line">        max_R_to_L[i] = max_val;</span><br><span class="line">        dp_min_R_to_L[i] = <span class="built_in">min</span>(dp_min_R_to_L[i + <span class="number">1</span>] + a[i], a[i]);</span><br><span class="line">        min_val = <span class="built_in">min</span>(min_val, dp_min_R_to_L[i]);</span><br><span class="line">        min_R_to_L[i] = min_val;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">ll <span class="title">case_1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ll max_val = minn;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt; n; ++i) &#123;</span><br><span class="line">        max_val = <span class="built_in">max</span>(max_val, max_L_to_R[i] + max_R_to_L[i + <span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> max_val;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">ll <span class="title">case_2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ll min_val = maxn;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt; n; ++i) &#123;</span><br><span class="line">        min_val = <span class="built_in">min</span>(min_val, min_L_to_R[i] + min_R_to_L[i + <span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> total_a - min_val;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ios_base::<span class="built_in">sync_with_stdio</span>(<span class="literal">false</span>);</span><br><span class="line">    cin.<span class="built_in">tie</span>(<span class="literal">NULL</span>);</span><br><span class="line">    cin &gt;&gt; n;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt;= n; ++i) &#123;</span><br><span class="line">        cin &gt;&gt; a[i];</span><br><span class="line">        total_a += a[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">find_L_to_R</span>();</span><br><span class="line">    <span class="built_in">find_R_to_L</span>();</span><br><span class="line">    cout &lt;&lt; <span class="built_in">max</span>(<span class="built_in">case_1</span>(), <span class="built_in">case_2</span>());</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</details>

<h5 id="错误分析"><a href="#错误分析" class="headerlink" title="错误分析"></a>错误分析</h5><ul>
<li><p><strong>问题根源：</strong><br>算法的理论模型正确，但代码实现未处理一个由 <strong>非空</strong> 约束引发的特殊情况。该问题在输入数组 <strong>全为负数</strong> 的测试点上触发。</p>
</li>
<li><p><strong>错误原因：</strong></p>
<ol>
<li>当数组全为负数时，为使和最小，算法会选择尽可能多的元素。因此，计算出的 <strong>链上最小两段和</strong> 等于 <strong>数组总和</strong>。</li>
<li>此时，<code>case_2()</code> 函数的计算 <code>total_a - min_val</code> 变为 <code>total_a - total_a</code>，结果为 <code>0</code>。</li>
<li>根据 <strong>非空</strong> 约束，对于全负数组，任意两段非空子段的和必须为负数。<code>case_1()</code> 会正确计算出这个负数的最优解。</li>
<li>最终，<code>main</code> 函数在 <code>max(一个正确的负数, 0)</code> 的比较中，会错误地选择 <code>0</code>。</li>
<li>这个结果 <code>0</code> 对应于 <strong>未选中全部元素</strong> 的情况，即 <strong>选中了空集</strong>，这与题目的 <strong>非空</strong> 约束相悖。</li>
</ol>
</li>
</ul>
<h4 id="V2-0-修正实现-AC"><a href="#V2-0-修正实现-AC" class="headerlink" title="V2.0 修正实现 (AC)"></a>V2.0 修正实现 (AC)</h4><h5 id="设计-1"><a href="#设计-1" class="headerlink" title="设计"></a>设计</h5><p>问题已明确：当 <strong>链上最小两段和 &#x3D;&#x3D; 数组总和</strong> 时，<code>case_2()</code> 会产生一个违反约束的无效解 <code>0</code>。</p>
<p>修正的目标是：识别此情况，并确保该无效解不被选为最终答案。</p>
<ul>
<li><strong>解决方案</strong>: 修改 <code>case_2()</code> 函数的返回值。当 <code>total_a == min_val</code> 的条件成立时，函数不返回 <code>0</code>，而是返回一个理论上的极小值 <code>LLONG_MIN</code>。</li>
<li><strong>效果</strong>: 任何合法的解（即使是负数）都必然大于 <code>LLONG_MIN</code>。因此，在最终的 <code>max</code> 比较中，<code>case_1()</code> 计算出的合法解会自动取代 <code>case_2()</code> 返回的 <code>LLONG_MIN</code>，从而保证结果的正确性。</li>
</ul>
<h5 id="实现-1"><a href="#实现-1" class="headerlink" title="实现"></a>实现</h5><img src="/2025/11/03/Luogu-P1121-CircularTwoSegmentSum/5.png" class="" title="AC提交记录">

<p><a target="_blank" rel="noopener" href="https://www.luogu.com.cn/record/244799731">AC提交记录</a></p>
<details>
<summary>点击展开/折叠 V2.0 AC代码</summary>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> ll = <span class="type">long</span> <span class="type">long</span>;</span><br><span class="line">ll <span class="type">const</span> maxn = <span class="number">2e5</span> + <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> n;</span><br><span class="line">ll total_a, a[maxn], max_L_to_R[maxn], dp_max_L_to_R[maxn], max_R_to_L[maxn], dp_max_R_to_L[maxn], min_L_to_R[maxn], dp_min_L_to_R[maxn], min_R_to_L[maxn], dp_min_R_to_L[maxn];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">find_L_to_R</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ll max_val = LLONG_MIN, min_val = LLONG_MAX;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt;= n; ++i) &#123;</span><br><span class="line">        dp_max_L_to_R[i] = <span class="built_in">max</span>(dp_max_L_to_R[i - <span class="number">1</span>] + a[i], a[i]);</span><br><span class="line">        max_val = <span class="built_in">max</span>(max_val, dp_max_L_to_R[i]);</span><br><span class="line">        max_L_to_R[i] = max_val;</span><br><span class="line">        dp_min_L_to_R[i] = <span class="built_in">min</span>(dp_min_L_to_R[i - <span class="number">1</span>] + a[i], a[i]);</span><br><span class="line">        min_val = <span class="built_in">min</span>(min_val, dp_min_L_to_R[i]);</span><br><span class="line">        min_L_to_R[i] = min_val;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">find_R_to_L</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ll max_val = LLONG_MIN, min_val = LLONG_MAX;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = n; i &gt;= <span class="number">1</span>; --i) &#123;</span><br><span class="line">        dp_max_R_to_L[i] = <span class="built_in">max</span>(dp_max_R_to_L[i + <span class="number">1</span>] + a[i], a[i]);</span><br><span class="line">        max_val = <span class="built_in">max</span>(max_val, dp_max_R_to_L[i]);</span><br><span class="line">        max_R_to_L[i] = max_val;</span><br><span class="line">        dp_min_R_to_L[i] = <span class="built_in">min</span>(dp_min_R_to_L[i + <span class="number">1</span>] + a[i], a[i]);</span><br><span class="line">        min_val = <span class="built_in">min</span>(min_val, dp_min_R_to_L[i]);</span><br><span class="line">        min_R_to_L[i] = min_val;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">ll <span class="title">case_1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ll max_val = LLONG_MIN;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt; n; ++i) &#123;</span><br><span class="line">        max_val = <span class="built_in">max</span>(max_val, max_L_to_R[i] + max_R_to_L[i + <span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> max_val;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">ll <span class="title">case_2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ll min_val = LLONG_MAX;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt; n; ++i) &#123;</span><br><span class="line">        min_val = <span class="built_in">min</span>(min_val, min_L_to_R[i] + min_R_to_L[i + <span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> total_a == min_val ? LLONG_MIN : total_a - min_val;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ios_base::<span class="built_in">sync_with_stdio</span>(<span class="literal">false</span>);</span><br><span class="line">    cin.<span class="built_in">tie</span>(<span class="literal">NULL</span>);</span><br><span class="line">    cin &gt;&gt; n;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt;= n; ++i) &#123;</span><br><span class="line">        cin &gt;&gt; a[i];</span><br><span class="line">        total_a += a[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">find_L_to_R</span>();</span><br><span class="line">    <span class="built_in">find_R_to_L</span>();</span><br><span class="line">    cout &lt;&lt; <span class="built_in">max</span>(<span class="built_in">case_1</span>(), <span class="built_in">case_2</span>());</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</details>

<ul>
<li><p><strong>实现细节剖析</strong><br>核心改动位于 <code>case_2()</code> 函数的返回语句：<br><code>return total_a == min_val ? LLONG_MIN : total_a - min_val;</code><br>该行代码使用三元运算符，将对特殊情况的判断和处理封装在函数内部，解决了问题。</p>
</li>
<li><p><strong>健壮性提升</strong><br><code>AC</code>代码将所有用于初始化的极大&#x2F;极小值，从硬编码的数值（如<code>1e9</code>）替换为标准库 <code>&lt;climits&gt;</code> 中定义的 <code>LLONG_MAX</code> 和 <code>LLONG_MIN</code>。这使代码不依赖于对题目数据范围的假设，提高了通用性和健壮性。</p>
</li>
</ul>
<hr>
<p><strong>P.S.</strong> 完整手稿</p>
<img src="/2025/11/03/Luogu-P1121-CircularTwoSegmentSum/6.jpg" class="" title="手稿">

<hr>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ol>
<li><strong>环形问题处理方法</strong>：<strong>分类讨论</strong> 结合 <strong>对偶思想</strong> 是处理此类环形数组问题的有效方法，可将问题转化为线性空间下的计算。</li>
<li><strong>边界情况的重要性</strong>：必须分析 <strong>全正</strong>、<strong>全负</strong> 等特殊数据集。题目的 <strong>非空</strong> 等约束，在这些边界情况下是决定算法正确性的关键。</li>
<li><strong>一种处理无效解的技巧</strong>：当算法的一个分支可能产生逻辑上无效的解时，可以使其返回一个在最终聚合操作（如<code>max</code>或<code>min</code>）中必定会被淘汰的值（如<code>LLONG_MIN</code>或<code>LLONG_MAX</code>），从而避免复杂的外部逻辑判断。</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/10/25/Luogu-P1133-FlowerGardenDP/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="nine19een">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="nine19een's Blog">
      <meta itemprop="description" content="记录学习过程中的思考、题解与复盘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | nine19een's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/10/25/Luogu-P1133-FlowerGardenDP/" class="post-title-link" itemprop="url">洛谷-P1133-教主的花园·复盘——从线性DP到环形DP</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-10-25 02:00:00 / 修改时间：02:14:04" itemprop="dateCreated datePublished" datetime="2025-10-25T02:00:00+08:00">2025-10-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%AE%97%E6%B3%95%E9%A2%98%E8%A7%A3-%E5%A4%8D%E7%9B%98/" itemprop="url" rel="index"><span itemprop="name">算法题解/复盘</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最近，我解决了一道经典的 <strong>环形DP</strong> 问题。该问题具有较强的迷惑性，我设计了一个看似正确的线性DP模型，实际上忽略了问题最核心的 <strong>环形</strong> 约束。本文旨在完整复盘从一个70分的线性解，到一个90分的 <strong>错误补丁</strong> 解，最终到100分AC的 <strong>破环成链</strong> 正解的全过程，深入剖析每一步的思维误区与正确建模的关键。</p>
<hr>
<h2 id="题目分析"><a href="#题目分析" class="headerlink" title="题目分析"></a>题目分析</h2><p><strong><a target="_blank" rel="noopener" href="https://www.luogu.com.cn/problem/P1133">P1133 教主的花园</a></strong></p>
<img src="/2025/10/25/Luogu-P1133-FlowerGardenDP/1.png" class="" title="题面">

<p>提炼题目要素：</p>
<ol>
<li><strong>布局</strong>：<strong>环形</strong> 排列。</li>
<li><strong>约束</strong>：任何一棵树必须比其左右相邻的树 <strong>同时更高或更矮</strong>，形成 <strong>波峰</strong> 或 <strong>波谷</strong>。</li>
<li><strong>目标</strong>：观赏价值总和最大。</li>
</ol>
<p>这是一个动态规划问题。核心在于状态的设计。为了存储输入的观赏价值，我使用了一个 <code>Plant_Position</code> 结构体，其中 <code>pos[i].ten</code>, <code>pos[i].twenty</code>, <code>pos[i].thirty</code> 持有位置 <code>i</code> 的相应价值。</p>
<p>为了判断位置 <code>i</code> 的种植是否合法，不仅需要知道位置 <code>i-1</code> 的高度，还需要知道 <code>i-1</code> 相对于 <code>i-2</code> 的趋势，这样才能决定 <code>i</code> 的合法走向。因此，一个三维状态是必要的：<code>dp[i][j][k]</code>。</p>
<ul>
<li><code>i</code>：表示正在考虑第 <code>i</code> 棵树。</li>
<li><code>j</code>：表示第 <code>i</code> 棵树的高度。我们用 <code>1, 2, 3</code> 分别代表高度 <code>10, 20, 30</code>。</li>
<li><code>k</code>：表示第 <code>i</code> 棵树的形态。<ul>
<li><code>k=0</code>：第 <code>i</code> 棵树是 <strong>波谷</strong>，即 <code>H[i-1] &gt; H[i]</code>，从 <code>i-1</code> 到 <code>i</code> 是 <strong>下降</strong> 趋势。</li>
<li><code>k=1</code>：第 <code>i</code> 棵树是 <strong>波峰</strong>，即 <code>H[i-1] &lt; H[i]</code>，从 <code>i-1</code> 到 <code>i</code> 是 <strong>上升</strong> 趋势。</li>
</ul>
</li>
</ul>
<p><code>dp[i][j][k]</code> 的值，就代表满足以上定义时的最大观赏价值。</p>
<hr>
<h2 id="算法设计及实现"><a href="#算法设计及实现" class="headerlink" title="算法设计及实现"></a>算法设计及实现</h2><h3 id="V1-0-线性DP的初步尝试-70分"><a href="#V1-0-线性DP的初步尝试-70分" class="headerlink" title="V1.0 线性DP的初步尝试 (70分)"></a><strong>V1.0 线性DP的初步尝试 (70分)</strong></h3><h4 id="设计"><a href="#设计" class="headerlink" title="设计"></a><strong>设计</strong></h4><p>最初的方案完全忽略了 <strong>环形</strong> 约束，将花园视为一个从 <code>1</code> 到 <code>n</code> 的 <strong>线性序列</strong>。基于上述 <code>dp[i][j][k]</code> 状态，可以推导出所有合法的状态转移方程。</p>
<p><strong>状态转移方程详解：</strong></p>
<ol>
<li><p><strong>目标状态: <code>dp[i][1][0]</code> (高度 <code>10</code> , 波谷&#x2F;下降)</strong></p>
<ul>
<li><strong>逻辑</strong>: 要下降到高度 <code>10</code> ，前一个位置 <code>i-1</code> 的高度必须是 <code>20</code> 或 <code>30</code> 。同时，为了形成波谷，前一个位置 <code>i-1</code> 必须是波峰（上升趋势，<code>k=1</code>）。</li>
<li><strong>方程</strong>: <code>dp[i][1][0] = max(dp[i-1][2][1], dp[i-1][3][1]) + pos[i].ten</code></li>
</ul>
</li>
<li><p><strong>目标状态: <code>dp[i][2][0]</code> (高度 <code>20</code> , 波谷&#x2F;下降)</strong></p>
<ul>
<li><strong>逻辑</strong>: 要下降到高度 <code>20</code> ，前一个位置 <code>i-1</code> 的高度必须是 <code>30</code> 。前一个位置 <code>i-1</code> 必须是波峰（上升趋势，<code>k=1</code>）。</li>
<li><strong>方程</strong>: <code>dp[i][2][0] = dp[i-1][3][1] + pos[i].twenty</code></li>
</ul>
</li>
<li><p><strong>目标状态: <code>dp[i][2][1]</code> (高度 <code>20</code> , 波峰&#x2F;上升)</strong></p>
<ul>
<li><strong>逻辑</strong>: 要上升到高度 <code>20</code> ，前一个位置 <code>i-1</code> 的高度必须是 <code>10</code> 。前一个位置 <code>i-1</code> 必须是波谷（下降趋势，<code>k=0</code>）。</li>
<li><strong>方程</strong>: <code>dp[i][2][1] = dp[i-1][1][0] + pos[i].twenty</code></li>
</ul>
</li>
<li><p><strong>目标状态: <code>dp[i][3][1]</code> (高度 <code>30</code> , 波峰&#x2F;上升)</strong></p>
<ul>
<li><strong>逻辑</strong>: 要上升到高度 <code>30</code> ，前一个位置 <code>i-1</code> 的高度可以是 <code>10</code> 或 <code>20</code> 。前一个位置 <code>i-1</code> 必须是波谷（下降趋势，<code>k=0</code>）。</li>
<li><strong>方程</strong>: <code>dp[i][3][1] = max(dp[i-1][1][0], dp[i-1][2][0]) + pos[i].thirty</code></li>
</ul>
</li>
</ol>
<p><strong>不可达状态</strong>:</p>
<ul>
<li><code>dp[i][1][1]</code> (上升到最低点) 和 <code>dp[i][3][0]</code> (下降到最高点) 是不可能出现的。这些状态的值应保持为极小值，不参与计算。</li>
</ul>
<img src="/2025/10/25/Luogu-P1133-FlowerGardenDP/2.jpg" class="" title="手稿1">

<h4 id="实现"><a href="#实现" class="headerlink" title="实现"></a><strong>实现</strong></h4><p>该方案的实现直接从 <code>i=1</code> 循环到 <code>n</code>，并在最后取 <code>dp[n]</code> 所有合法状态的最大值作为结果。</p>
<img src="/2025/10/25/Luogu-P1133-FlowerGardenDP/3.png" class="" title="70分提交记录">

<p><a target="_blank" rel="noopener" href="https://www.luogu.com.cn/record/242568689">70分提交记录</a></p>
<details>
<summary>点击展开/折叠 V1.0 70分代码</summary>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> ll = <span class="type">long</span> <span class="type">long</span>;</span><br><span class="line">ll <span class="type">const</span> maxn = <span class="number">1e5</span> + <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Plant_Position</span> &#123;</span><br><span class="line">    ll ten, twenty, thirty;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">ll n, dp[maxn][<span class="number">8</span>][<span class="number">7</span>];</span><br><span class="line">Plant_Position pos[maxn];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">dp_10_0</span><span class="params">(<span class="type">int</span> idx)</span> </span>&#123;</span><br><span class="line">    dp[idx][<span class="number">1</span>][<span class="number">0</span>] = <span class="built_in">max</span>(dp[idx - <span class="number">1</span>][<span class="number">2</span>][<span class="number">1</span>], dp[idx - <span class="number">1</span>][<span class="number">3</span>][<span class="number">1</span>]) + pos[idx].ten;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">dp_20_0</span><span class="params">(<span class="type">int</span> idx)</span> </span>&#123;</span><br><span class="line">    dp[idx][<span class="number">2</span>][<span class="number">0</span>] = dp[idx - <span class="number">1</span>][<span class="number">3</span>][<span class="number">1</span>] + pos[idx].twenty;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">dp_20_1</span><span class="params">(<span class="type">int</span> idx)</span> </span>&#123;</span><br><span class="line">    dp[idx][<span class="number">2</span>][<span class="number">1</span>] = dp[idx - <span class="number">1</span>][<span class="number">1</span>][<span class="number">0</span>] + pos[idx].twenty;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">dp_30_1</span><span class="params">(<span class="type">int</span> idx)</span> </span>&#123;</span><br><span class="line">    dp[idx][<span class="number">3</span>][<span class="number">1</span>] = <span class="built_in">max</span>(dp[idx - <span class="number">1</span>][<span class="number">1</span>][<span class="number">0</span>], dp[idx - <span class="number">1</span>][<span class="number">2</span>][<span class="number">0</span>]) + pos[idx].thirty;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">ll <span class="title">DP</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</span><br><span class="line">        <span class="built_in">dp_10_0</span>(i);</span><br><span class="line">        <span class="built_in">dp_20_0</span>(i);</span><br><span class="line">        <span class="built_in">dp_20_1</span>(i);</span><br><span class="line">        <span class="built_in">dp_30_1</span>(i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">max</span>(<span class="built_in">max</span>(dp[n][<span class="number">1</span>][<span class="number">0</span>], dp[n][<span class="number">3</span>][<span class="number">1</span>]), <span class="built_in">max</span>(dp[n][<span class="number">2</span>][<span class="number">0</span>], dp[n][<span class="number">2</span>][<span class="number">1</span>]));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ios_base::<span class="built_in">sync_with_stdio</span>(<span class="literal">false</span>);</span><br><span class="line">    cin.<span class="built_in">tie</span>(<span class="literal">NULL</span>);</span><br><span class="line">    cin &gt;&gt; n;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</span><br><span class="line">        cin &gt;&gt; pos[i].ten &gt;&gt; pos[i].twenty &gt;&gt; pos[i].thirty;</span><br><span class="line">    &#125;</span><br><span class="line">    cout &lt;&lt; <span class="built_in">DP</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</details>

<h4 id="错误分析"><a href="#错误分析" class="headerlink" title="错误分析"></a><strong>错误分析</strong></h4><ul>
<li><strong>问题根源：</strong><br>该方案计算出的结果是 <strong>线性排列</strong> 下的最优解。但题目要求的是 <strong>环形排列</strong>。线性最优解的第 <code>n</code> 个位置和第 <code>1</code> 个位置的状态，很可能不满足高低交错的约束，因此该解对于环形问题是 <strong>非法的</strong>。</li>
</ul>
<h3 id="V2-0-“打补丁”的错误修正-90分"><a href="#V2-0-“打补丁”的错误修正-90分" class="headerlink" title="V2.0 “打补丁”的错误修正 (90分)"></a><strong>V2.0 “打补丁”的错误修正 (90分)</strong></h3><h4 id="设计-1"><a href="#设计-1" class="headerlink" title="设计"></a><strong>设计</strong></h4><p>在提交V1.0后，我意识到了环形约束的问题。此时产生了一个错误的修正思路：<strong>先算出线性最优，再检查它是否满足环形约束</strong>。</p>
<p>这个思路最初的实现是一个复杂且繁琐的 <code>while</code> 循环：</p>
<details>
<summary>点击展开/折叠 while“补丁”</summary>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">ans.<span class="built_in">push_back</span>(dp[n][<span class="number">1</span>][<span class="number">0</span>]);</span><br><span class="line">ans.<span class="built_in">push_back</span>(dp[n][<span class="number">2</span>][<span class="number">0</span>]);</span><br><span class="line">ans.<span class="built_in">push_back</span>(dp[n][<span class="number">2</span>][<span class="number">1</span>]);</span><br><span class="line">ans.<span class="built_in">push_back</span>(dp[n][<span class="number">3</span>][<span class="number">1</span>]);</span><br><span class="line"><span class="built_in">sort</span>(ans.<span class="built_in">begin</span>(), ans.<span class="built_in">end</span>());</span><br><span class="line"><span class="type">bool</span> y[<span class="number">5</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (ans.<span class="built_in">back</span>() == dp[n][<span class="number">2</span>][<span class="number">0</span>] &amp;&amp; !y[<span class="number">0</span>]) &#123;</span><br><span class="line">        <span class="keyword">if</span> (pos[<span class="number">1</span>].twenty &lt; pos[<span class="number">1</span>].thirty) &#123;</span><br><span class="line">            cout &lt;&lt; ans.<span class="built_in">back</span>();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            y[<span class="number">0</span>] = <span class="literal">true</span>;</span><br><span class="line">            ans.<span class="built_in">pop_back</span>();</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (ans.<span class="built_in">back</span>() == dp[n][<span class="number">2</span>][<span class="number">1</span>] &amp;&amp; !y[<span class="number">1</span>]) &#123;</span><br><span class="line">        <span class="keyword">if</span> (pos[<span class="number">1</span>].twenty &lt; pos[<span class="number">1</span>].ten) &#123;</span><br><span class="line">            cout &lt;&lt; ans.<span class="built_in">back</span>();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            y[<span class="number">1</span>] = <span class="literal">true</span>;</span><br><span class="line">            ans.<span class="built_in">pop_back</span>();</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    cout &lt;&lt; ans.<span class="built_in">back</span>();</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</details>

<p>这个复杂的 <code>while</code> 最终被我精简为两个 <code>if</code> 语句：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (pos[<span class="number">1</span>].twenty &gt; pos[<span class="number">1</span>].ten) &#123;</span><br><span class="line">    dp[n][<span class="number">2</span>][<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (pos[<span class="number">1</span>].twenty &gt; pos[<span class="number">1</span>].thirty) &#123;</span><br><span class="line">    dp[n][<span class="number">2</span>][<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">cout &lt;&lt; <span class="built_in">max</span>(<span class="built_in">max</span>(dp[n][<span class="number">1</span>][<span class="number">0</span>], dp[n][<span class="number">3</span>][<span class="number">1</span>]), <span class="built_in">max</span>(dp[n][<span class="number">2</span>][<span class="number">0</span>], dp[n][<span class="number">2</span>][<span class="number">1</span>]));</span><br></pre></td></tr></table></figure>

<p><code>if</code> 虽比 <code>while</code> 精简了很多，其内在的错误逻辑是相同的。这个 <strong>“补丁”</strong> 的意图是，从线性DP算出的几个最优候选解中，通过一套逻辑来 <strong>推断</strong> 并 <strong>验证</strong> 起点是否合法。</p>
<p>其验证逻辑如下：</p>
<ol>
<li><p><strong>无约束情况</strong>：如果线性最优解的终点是 <code>dp[n][1][0]</code> ( <code>H=10</code> , 下降) 或 <code>dp[n][3][1]</code> ( <code>H=30</code> , 上升)，则直接接受。</p>
<ul>
<li><strong>推断</strong>: 如果 <code>H[n]=10</code>，则环要求 <code>H[1] &gt; 10</code>，即 <code>H[1]</code> 可以是 <code>20</code> 或 <code>30</code> 。因为有两个选择，代码便假设总能找到一个合法的起点，无需干预。<code>H[n]=30</code> 同理。</li>
</ul>
</li>
<li><p><strong>约束情况 1</strong>: 当考虑终点为 <code>dp[n][2][1]</code> ( <code>H=20</code> , 上升) 的路径时。</p>
<ul>
<li><strong>推断</strong>: 这个终点状态意味着 <code>H[n-1]=10</code>。为了构成环，<code>H[1]</code> 必须小于 <code>H[n]=20</code>，所以 <code>H[1]</code> <strong>必须是 <code>10</code></strong>。</li>
<li><strong>验证</strong>: 此时，代码进行一次 <strong>贪心</strong> 检查：<code>if (pos[1].twenty &gt; pos[1].ten)</code>。这个判断的逻辑是：“如果在起点上，种 <code>20</code> 的观赏价值比种 <code>10</code> 要高，那么一个真正最优的路径，当初在起点时就 <strong>不可能</strong> 选择种 <code>10</code> ”。基于这个贪心假设，如果条件成立，就认为这条要求起点为 <code>10</code> 的路径不可能是最优解，于是通过 <code>dp[n][2][1] = 0</code> 将其作废。</li>
</ul>
</li>
<li><p><strong>约束情况 2</strong>: 当考虑终点为 <code>dp[n][2][0]</code> ( <code>H=20</code> , 下降) 的路径时。</p>
<ul>
<li><strong>推断</strong>: 这个终点状态意味着 <code>H[n-1]=30</code>。为了构成环，<code>H[1]</code> 必须大于 <code>H[n]=20</code>，所以 <code>H[1]</code> <strong>必须是 <code>30</code></strong>。</li>
<li><strong>验证</strong>: 类似地，代码进行贪心检查 <code>if (pos[1].twenty &gt; pos[1].thirty)</code>。如果种 <code>20</code> 的价值更高，就认为这条要求起点为 <code>30</code> 的路径不可能是最优解，将其作废。</li>
</ul>
</li>
</ol>
<img src="/2025/10/25/Luogu-P1133-FlowerGardenDP/4.jpg" class="" title="手稿2">

<h4 id="实现-1"><a href="#实现-1" class="headerlink" title="实现"></a><strong>实现</strong></h4><img src="/2025/10/25/Luogu-P1133-FlowerGardenDP/5.png" class="" title="90分提交记录">

<p><a target="_blank" rel="noopener" href="https://www.luogu.com.cn/record/242583553">90分提交记录</a></p>
<details>
<summary>点击展开/折叠 V2.0 代码 (90分)</summary>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> ll = <span class="type">long</span> <span class="type">long</span>;</span><br><span class="line">ll <span class="type">const</span> maxn = <span class="number">1e5</span> + <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Plant_Position</span> &#123;</span><br><span class="line">    ll ten, twenty, thirty;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">ll n, dp[maxn][<span class="number">8</span>][<span class="number">7</span>];</span><br><span class="line">Plant_Position pos[maxn];</span><br><span class="line">vector&lt;ll&gt; ans;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">dp_10_0</span><span class="params">(<span class="type">int</span> idx)</span> </span>&#123;</span><br><span class="line">    dp[idx][<span class="number">1</span>][<span class="number">0</span>] = <span class="built_in">max</span>(dp[idx - <span class="number">1</span>][<span class="number">2</span>][<span class="number">1</span>], dp[idx - <span class="number">1</span>][<span class="number">3</span>][<span class="number">1</span>]) + pos[idx].ten;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">dp_20_0</span><span class="params">(<span class="type">int</span> idx)</span> </span>&#123;</span><br><span class="line">    dp[idx][<span class="number">2</span>][<span class="number">0</span>] = dp[idx - <span class="number">1</span>][<span class="number">3</span>][<span class="number">1</span>] + pos[idx].twenty;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">dp_20_1</span><span class="params">(<span class="type">int</span> idx)</span> </span>&#123;</span><br><span class="line">    dp[idx][<span class="number">2</span>][<span class="number">1</span>] = dp[idx - <span class="number">1</span>][<span class="number">1</span>][<span class="number">0</span>] + pos[idx].twenty;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">dp_30_1</span><span class="params">(<span class="type">int</span> idx)</span> </span>&#123;</span><br><span class="line">    dp[idx][<span class="number">3</span>][<span class="number">1</span>] = <span class="built_in">max</span>(dp[idx - <span class="number">1</span>][<span class="number">1</span>][<span class="number">0</span>], dp[idx - <span class="number">1</span>][<span class="number">2</span>][<span class="number">0</span>]) + pos[idx].thirty;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DP</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</span><br><span class="line">        <span class="built_in">dp_10_0</span>(i);</span><br><span class="line">        <span class="built_in">dp_20_0</span>(i);</span><br><span class="line">        <span class="built_in">dp_20_1</span>(i);</span><br><span class="line">        <span class="built_in">dp_30_1</span>(i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (pos[<span class="number">1</span>].twenty &gt; pos[<span class="number">1</span>].ten) &#123;</span><br><span class="line">        dp[n][<span class="number">2</span>][<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (pos[<span class="number">1</span>].twenty &gt; pos[<span class="number">1</span>].thirty) &#123;</span><br><span class="line">        dp[n][<span class="number">2</span>][<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    cout &lt;&lt; <span class="built_in">max</span>(<span class="built_in">max</span>(dp[n][<span class="number">1</span>][<span class="number">0</span>], dp[n][<span class="number">3</span>][<span class="number">1</span>]), <span class="built_in">max</span>(dp[n][<span class="number">2</span>][<span class="number">0</span>], dp[n][<span class="number">2</span>][<span class="number">1</span>]));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ios_base::<span class="built_in">sync_with_stdio</span>(<span class="literal">false</span>);</span><br><span class="line">    cin.<span class="built_in">tie</span>(<span class="literal">NULL</span>);</span><br><span class="line">    cin &gt;&gt; n;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</span><br><span class="line">        cin &gt;&gt; pos[i].ten &gt;&gt; pos[i].twenty &gt;&gt; pos[i].thirty;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">DP</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

</details>

<h4 id="错误分析-1"><a href="#错误分析-1" class="headerlink" title="错误分析"></a><strong>错误分析</strong></h4><ul>
<li><p><strong>根本性缺陷：</strong><br>此方案的失败，并非因为 <code>if</code> 语句这个 <strong>补丁</strong> 本身不够精巧。恰恰相反，它很好地浓缩了前一版 <code>while</code> 循环的意图，是一个逻辑上很优质的补丁。</p>
<p>真正的错误出在算法的 <strong>根本设计</strong> 上。这种 <strong>事后补救</strong> 的方法，就相当于把一条通往错误方向的道路修得非常漂亮，但道路再好，也无法到达正确的终点。</p>
<p>其核心谬误在于，它错误地假设了 <strong>环形最优解一定包含在线性最优解之中</strong>。而事实上，真正的环形最优解，其线性部分可能根本不是最优的。代码只检查了少数几个 <strong>线性最优</strong> 的候选者，而真正的答案可能在第一次DP时，就因为在线性排列上得分不够高而被直接淘汰，永远没有机会被最后的 <code>if</code> 语句检查。这是一种典型的 <strong>局部最优陷阱</strong>。</p>
</li>
</ul>
<h3 id="V3-0-“破环成链”的正确解法-AC"><a href="#V3-0-“破环成链”的正确解法-AC" class="headerlink" title="V3.0 “破环成链”的正确解法 (AC)"></a><strong>V3.0 “破环成链”的正确解法 (AC)</strong></h3><h4 id="设计-2"><a href="#设计-2" class="headerlink" title="设计"></a><strong>设计</strong></h4><p>正确的做法是放弃 <strong>事后补救</strong>，采用处理环形问题的 <strong>标准范式——破环成链</strong>。</p>
<p>其核心思想是，将一个复杂的环形问题，分解为几个独立的、<strong>带有明确起始和结束约束</strong> 的线性问题。</p>
<p>具体方案是，通过一个外层循环，<strong>强制指定 <code>第 1 棵树</code> 的高度</strong>（分三种情况： <code>H=10</code> ,  <code>H=20</code> ,  <code>H=30</code> ）。对每种情况独立进行一次从2到n的线性DP，并在最后根据固定的起点，对终点 <code>dp[n]</code> 的状态进行合法性筛选。</p>
<img src="/2025/10/25/Luogu-P1133-FlowerGardenDP/6.jpg" class="" title="手稿3">

<h4 id="可行性分析"><a href="#可行性分析" class="headerlink" title="可行性分析"></a><strong>可行性分析</strong></h4><ul>
<li><strong>时间复杂度</strong>: 每次DP的计算量是 <code>O(n)</code>。总共进行3次独立的DP，所以总时间复杂度依然是 <code>O(n)</code>。</li>
<li><strong>空间复杂度</strong>: <code>O(n)</code>。</li>
<li><strong>结论</strong>: 方案高效可行。</li>
</ul>
<h4 id="实现-2"><a href="#实现-2" class="headerlink" title="实现"></a><strong>实现</strong></h4><img src="/2025/10/25/Luogu-P1133-FlowerGardenDP/7.png" class="" title="AC提交记录">

<p><a target="_blank" rel="noopener" href="https://www.luogu.com.cn/record/242678415">AC提交记录</a></p>
<details>
<summary>点击展开/折叠 V3.0 AC代码</summary>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> ll = <span class="type">long</span> <span class="type">long</span>;</span><br><span class="line">ll <span class="type">const</span> maxn = <span class="number">1e5</span> + <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Plant_Position</span> &#123;</span><br><span class="line">    ll ten, twenty, thirty;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">ll n, dp[maxn][<span class="number">5</span>][<span class="number">5</span>], ans;</span><br><span class="line">Plant_Position pos[maxn];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DP</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ll ans = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">3</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (i == <span class="number">1</span>) &#123;</span><br><span class="line">            dp[<span class="number">1</span>][<span class="number">1</span>][<span class="number">0</span>] = pos[<span class="number">1</span>].ten;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (i == <span class="number">2</span>) &#123;</span><br><span class="line">            dp[<span class="number">1</span>][<span class="number">2</span>][<span class="number">0</span>] = pos[<span class="number">1</span>].twenty, dp[<span class="number">1</span>][<span class="number">2</span>][<span class="number">1</span>] = pos[<span class="number">1</span>].twenty;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (i == <span class="number">3</span>) &#123;</span><br><span class="line">            dp[<span class="number">1</span>][<span class="number">3</span>][<span class="number">1</span>] = pos[<span class="number">1</span>].thirty;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">2</span>; i &lt;= n; i++) &#123;</span><br><span class="line">            dp[i][<span class="number">1</span>][<span class="number">0</span>] = <span class="built_in">max</span>(dp[i - <span class="number">1</span>][<span class="number">2</span>][<span class="number">1</span>], dp[i - <span class="number">1</span>][<span class="number">3</span>][<span class="number">1</span>]) + pos[i].ten;</span><br><span class="line">            dp[i][<span class="number">2</span>][<span class="number">0</span>] = dp[i - <span class="number">1</span>][<span class="number">3</span>][<span class="number">1</span>] + pos[i].twenty;</span><br><span class="line">            dp[i][<span class="number">2</span>][<span class="number">1</span>] = dp[i - <span class="number">1</span>][<span class="number">1</span>][<span class="number">0</span>] + pos[i].twenty;</span><br><span class="line">            dp[i][<span class="number">3</span>][<span class="number">1</span>] = <span class="built_in">max</span>(dp[i - <span class="number">1</span>][<span class="number">1</span>][<span class="number">0</span>], dp[i - <span class="number">1</span>][<span class="number">2</span>][<span class="number">0</span>]) + pos[i].thirty;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (i == <span class="number">1</span>) &#123;</span><br><span class="line">            ans = <span class="built_in">max</span>(ans, <span class="built_in">max</span>(dp[n][<span class="number">2</span>][<span class="number">1</span>], dp[n][<span class="number">3</span>][<span class="number">1</span>]));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (i == <span class="number">2</span>) &#123;</span><br><span class="line">            ans = <span class="built_in">max</span>(ans, <span class="built_in">max</span>(dp[n][<span class="number">1</span>][<span class="number">0</span>], dp[n][<span class="number">3</span>][<span class="number">1</span>]));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (i == <span class="number">3</span>) &#123;</span><br><span class="line">            ans = <span class="built_in">max</span>(ans, <span class="built_in">max</span>(dp[n][<span class="number">1</span>][<span class="number">0</span>], dp[n][<span class="number">2</span>][<span class="number">0</span>]));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">memset</span>(dp, <span class="number">0</span>, <span class="built_in">sizeof</span>(dp));</span><br><span class="line">    &#125;</span><br><span class="line">    cout &lt;&lt; ans;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ios_base::<span class="built_in">sync_with_stdio</span>(<span class="literal">false</span>);</span><br><span class="line">    cin.<span class="built_in">tie</span>(<span class="literal">NULL</span>);</span><br><span class="line">    cin &gt;&gt; n;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</span><br><span class="line">        cin &gt;&gt; pos[i].ten &gt;&gt; pos[i].twenty &gt;&gt; pos[i].thirty;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">DP</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</details>

<ul>
<li><p><strong>实现细节剖析</strong><br>该方案的精髓在于，将环形约束从一个 <strong>事后检查</strong> 的难题，转化为了一个 <strong>顶层设计</strong> 的分类讨论。在固定了起点后，最后结算时对终点的筛选逻辑如下：</p>
<ol>
<li><p><strong>若起点  <code>H[1]=10</code>  (波谷)</strong>:</p>
<ul>
<li>为构成环，终点 <code>H[n]</code> 必须是波峰，且 <code>H[n] &gt; H[1]</code>。</li>
<li>合法终点状态：<code>dp[n][2][1]</code> ( <code>H=20</code> , 上升) 和 <code>dp[n][3][1]</code> ( <code>H=30</code> , 上升)。</li>
<li>候选答案: <code>max(dp[n][2][1], dp[n][3][1])</code></li>
</ul>
</li>
<li><p><strong>若起点  <code>H[1]=20</code>  (波峰或波谷)</strong>:</p>
<ul>
<li>为构成环，若 <code>H[n]</code> 是波峰，则 <code>H[n] &gt; H[1]</code>；若 <code>H[n]</code> 是波谷，则 <code>H[n] &lt; H[1]</code>。</li>
<li>合法终点状态：<code>dp[n][3][1]</code> ( <code>H=30</code> , 上升) 和 <code>dp[n][1][0]</code> ( <code>H=10</code> , 下降)。</li>
<li>候选答案: <code>max(dp[n][3][1], dp[n][1][0])</code></li>
</ul>
</li>
<li><p><strong>若起点  <code>H[1]=30</code>  (波峰)</strong>:</p>
<ul>
<li>为构成环，终点 <code>H[n]</code> 必须是波谷，且 <code>H[n] &lt; H[1]</code>。</li>
<li>合法终点状态：<code>dp[n][1][0]</code> ( <code>H=10</code> , 下降) 和 <code>dp[n][2][0]</code> ( <code>H=20</code> , 下降)。</li>
<li>候选答案: <code>max(dp[n][1][0], dp[n][2][0])</code></li>
</ul>
</li>
</ol>
<p>最终答案就是这三个候选答案中的最大值。这种精确的筛选保证了最终解的合法性。</p>
</li>
</ul>
<hr>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol>
<li><strong>问题建模是关键</strong>：正确识别并处理 <strong>环形</strong> 这一核心模型，是解决本题的钥匙。直接套用线性模型会导致从根本上偏离题意。</li>
<li><strong>警惕“打补丁”式的修正</strong>：当发现算法有漏洞时，复杂的 <strong>事后检查</strong> 逻辑往往是错误或不完备的。正确的做法是回到设计的起点，思考如何将约束从一开始就融入算法模型。</li>
<li><strong>掌握标准范式</strong>：<strong>破环成链</strong> 是解决几乎所有环形DP、环形数组问题的通用且强大的思想，必须熟练掌握。</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/10/13/K-InversePairs/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="nine19een">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="nine19een's Blog">
      <meta itemprop="description" content="记录学习过程中的思考、题解与复盘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | nine19een's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/10/13/K-InversePairs/" class="post-title-link" itemprop="url">逆序k倍对·复盘</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-10-13 01:49:00 / 修改时间：03:38:12" itemprop="dateCreated datePublished" datetime="2025-10-13T01:49:00+08:00">2025-10-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%AE%97%E6%B3%95%E9%A2%98%E8%A7%A3-%E5%A4%8D%E7%9B%98/" itemprop="url" rel="index"><span itemprop="name">算法题解/复盘</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本题同样由那位BUAA大佬分享。</p>
<p>不久前，我用<strong>树状数组</strong>解决了洛谷上的<a target="_blank" rel="noopener" href="https://www.luogu.com.cn/problem/P1908">逆序对模板题</a> 。因此，当我初见这道 <strong>逆序 k 倍对</strong> 时，第一反应便是：这一定是模板的变体，核心工具依然是那个熟悉的树状数组。然而，从模板代码到这道题的AC，并非简单的复制粘贴，而是一段充满思考的<strong>魔改</strong>之旅。本文旨在完整复盘，我是如何基于逆序对模板的思路，一步步识别问题差异、调整关键逻辑，最终将一份模板代码成功改造为本题的解答。</p>
<hr>
<h2 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h2><h3 id="题目描述"><a href="#题目描述" class="headerlink" title="题目描述"></a>题目描述</h3><p>给定一个序列 a₁, a₂, …, aₙ 和一个正整数 k，如果 <code>1 ≤ i &lt; j ≤ n</code> 且 <code>aᵢ &gt; k · aⱼ</code>，我们就将 <code>(i, j)</code> 称作一个<strong>逆序 k 倍对</strong>。请你计算序列中逆序 k 倍对的个数。</p>
<h3 id="输入格式"><a href="#输入格式" class="headerlink" title="输入格式"></a>输入格式</h3><p>第一行两个正整数 n, k (1 ≤ n ≤ 10⁵, 1 ≤ k ≤ 10)。<br>第二行 n 个正整数 a₁, a₂, …, aₙ (1 ≤ aᵢ &lt; 2³¹)。<br>为了提高区分度，对于得分占比 10% 的测试点，我们保证 1 ≤ n ≤ 100。</p>
<h3 id="输出格式"><a href="#输出格式" class="headerlink" title="输出格式"></a>输出格式</h3><p>一行一个非负整数，表示序列中逆序 k 倍对的个数。</p>
<h3 id="输入样例"><a href="#输入样例" class="headerlink" title="输入样例"></a>输入样例</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">5 2</span><br><span class="line">5 4 3 2 1</span><br></pre></td></tr></table></figure>

<h3 id="输出样例"><a href="#输出样例" class="headerlink" title="输出样例"></a>输出样例</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">4</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="题目分析"><a href="#题目分析" class="headerlink" title="题目分析"></a>题目分析</h2><p>首先肯定要从那道经典的<strong>逆序对</strong>模板题开始分析。它的问题是统计 <code>i &lt; j</code> 且 <code>a[i] &gt; a[j]</code> 的数对。我当时AC的思路是：</p>
<ul>
<li>从左到右遍历数组，对于每个数 <code>a[j]</code>。</li>
<li>利用树状数组，查询在它<strong>之前</strong>已经出现过的数中，有多少个<strong>大于</strong> <code>a[j]</code>。</li>
<li>将这些查询结果累加，就是答案。</li>
<li>查询结束后，再将 <code>a[j]</code> 本身的信息更新到树状数组中。</li>
</ul>
<p>当时的AC代码如下：</p>
<details>
<summary>点击展开/折叠 逆序对模板题AC代码</summary>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> ll = <span class="type">long</span> <span class="type">long</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> n;</span><br><span class="line">vector&lt;<span class="type">int</span>&gt;a, b;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Lowbit</span><span class="params">(<span class="type">int</span> x)</span></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> x &amp; -x;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">ll <span class="title">Sum</span><span class="params">(<span class="type">int</span> x, ll arr[])</span></span>&#123;</span><br><span class="line">	ll ansSUM = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> i = x; i != <span class="number">0</span>; i -= <span class="built_in">Lowbit</span>(i))&#123;</span><br><span class="line">		ansSUM += arr[i];</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> ansSUM;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Update</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> add, <span class="type">int</span> size, ll arr[])</span></span>&#123;</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> i = x; i &lt;= size; i += <span class="built_in">Lowbit</span>(i))&#123;</span><br><span class="line">		arr[i] += add;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	cin &gt;&gt; n;</span><br><span class="line">	a.<span class="built_in">reserve</span>(n + <span class="number">5</span>);</span><br><span class="line">	b.<span class="built_in">reserve</span>(n + <span class="number">5</span>);</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>; i &lt;= n; i++)&#123;</span><br><span class="line">		<span class="type">int</span> num;</span><br><span class="line">		cin &gt;&gt; num;</span><br><span class="line">		a.<span class="built_in">push_back</span>(num);</span><br><span class="line">		b.<span class="built_in">push_back</span>(num);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">sort</span>(b.<span class="built_in">begin</span>(), b.<span class="built_in">end</span>());</span><br><span class="line">	b.<span class="built_in">erase</span>(<span class="built_in">unique</span>(b.<span class="built_in">begin</span>(), b.<span class="built_in">end</span>()), b.<span class="built_in">end</span>());</span><br><span class="line">	<span class="type">int</span> size = b.<span class="built_in">size</span>();</span><br><span class="line">	ll c[size + <span class="number">5</span>] = &#123;<span class="number">0</span>&#125;, ans[size + <span class="number">5</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	<span class="type">int</span> cnt = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> p : a)&#123;</span><br><span class="line">		cnt++;</span><br><span class="line">		<span class="type">int</span> idx = <span class="built_in">lower_bound</span>(b.<span class="built_in">begin</span>(), b.<span class="built_in">end</span>(), p) - b.<span class="built_in">begin</span>() + <span class="number">1</span>;</span><br><span class="line">		<span class="built_in">Update</span>(idx, <span class="number">1</span>, size, c);</span><br><span class="line">		<span class="built_in">Update</span>(idx, cnt - <span class="built_in">Sum</span>(idx, c), size, ans);</span><br><span class="line">	&#125;</span><br><span class="line">	cout &lt;&lt; <span class="built_in">Sum</span>(size, ans);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</details>

<p>这个框架非常清晰。现在，面对<strong>k倍逆序对</strong>，唯一的不同点，就是判断条件从 <code>a[i] &gt; a[j]</code> 变成了 <code>a[i] &gt; k * a[j]</code>。</p>
<p>这意味着，我的改造也必须围绕这个变化点展开。当我遍历到 <code>a[j]</code> 时，我需要查询的不再是<strong>比 <code>a[j]</code> 大的数</strong>，而是<strong>比 <code>k * a[j]</code> 大的数</strong>。</p>
<p>这个看似微小的变化，却直接影响了算法的基石——<strong>离散化</strong>。在原模板中，我们只需要对数组 <code>a</code> 中的值进行离散化。但现在，为了能查询 <code>k * a[j]</code> 的相关信息，我们必须将所有可能作为查询边界的 <code>k * a[j]</code> 也一并纳入离散化的范围。</p>
<p>这就是从模板到AC的关键一步：<strong>识别出查询目标的变化，并相应地扩大离散化的集合</strong>。</p>
<hr>
<h2 id="算法设计及实现"><a href="#算法设计及实现" class="headerlink" title="算法设计及实现"></a><strong>算法设计及实现</strong></h2><p>我的整个解题过程，可以看作是对逆序对模板代码的一次<strong>定向升级</strong>。</p>
<h3 id="核心思路：模板的演进"><a href="#核心思路：模板的演进" class="headerlink" title="核心思路：模板的演进"></a><strong>核心思路：模板的演进</strong></h3><ol>
<li><p><strong>继承模板框架：</strong></p>
<ul>
<li>整体的算法流程完全继承自逆序对模板：<strong>遍历数组 -&gt; 查询贡献 -&gt; 更新数据 -&gt; 累加结果</strong>。</li>
<li>核心数据结构依然锁定为<strong>树状数组</strong>，因为它能高效地完成我们需要的<strong>单点更新</strong>和<strong>前缀和查询</strong>。</li>
<li>由于 <code>a[i]</code> 的值域依然很大，<strong>离散化</strong>这一前置步骤也必须保留。</li>
</ul>
</li>
<li><p><strong>定位改造核心：查询目标的变化</strong></p>
<ul>
<li>模板的查询逻辑是：<code>贡献 = 总数 - 小于等于a[j]的个数</code>。</li>
<li>本题的查询逻辑变为：<code>贡献 = 总数 - 小于等于k*a[j]的个数</code>。</li>
<li>这个<code>k*a[j]</code>就是本次改造需要处理的<strong>新元素</strong>。</li>
</ul>
</li>
<li><p><strong>升级离散化：</strong></p>
<ul>
<li><strong>模板</strong>：离散化集合仅包含 <code>&#123; a[1], a[2], ..., a[n] &#125;</code>。</li>
<li><strong>本题</strong>：离散化集合必须扩大，同时包含 <code>&#123; a[1], ..., a[n] &#125;</code> 和 <code>&#123; k*a[1], ..., k*a[n] &#125;</code>。因为树状数组的下标是基于离散化后的排名，我们既需要能<strong>更新</strong> <code>a[j]</code> 对应的排名，也需要能<strong>查询</strong> <code>k*a[j]</code> 对应的排名。将它们全部放入一个集合中进行离散化，才能建立统一的“度量衡”。</li>
</ul>
</li>
<li><p><strong>微调主逻辑</strong></p>
<ul>
<li>在主循环中，对于当前元素 <code>p</code> (即<code>a[j]</code>)：<ul>
<li>首先，找到 <code>p</code> 离散化后的排名 <code>idx</code>。</li>
<li>然后，找到 <code>k*p</code> 离散化后的排名 <code>idx2</code>。</li>
<li>计算贡献值：<code>ans += cnt - Sum(idx2, c)</code>。这里的 <code>cnt</code> 是已处理元素个数，<code>Sum(idx2, c)</code> 则是利用树状数组查到的、前面出现过且值小于等于 <code>k*p</code> 的元素个数。</li>
<li>最后，执行和模板完全一样的更新操作：<code>Update(idx, 1, size, c)</code>，将 <code>p</code> 的出现次数记录到树状数组中。</li>
</ul>
</li>
</ul>
</li>
</ol>
<h3 id="可行性分析"><a href="#可行性分析" class="headerlink" title="可行性分析"></a><strong>可行性分析</strong></h3><p>这次“魔改”并没有改变算法的根本结构。</p>
<ul>
<li><p><strong>时间复杂度:</strong></p>
<ul>
<li>离散化集合的大小最多变为 <code>2n</code>。排序的复杂度依然是 <code>O(n log n)</code>。</li>
<li>主循环中，树状数组和 <code>lower_bound</code> 的操作复杂度仍为 <code>O(log n)</code>。</li>
<li>总时间复杂度保持在 <strong><code>O(n log n)</code></strong>，完全可以通过。</li>
</ul>
</li>
<li><p><strong>空间复杂度:</strong></p>
<ul>
<li>辅助数组 <code>b</code> 和树状数组 <code>c</code> 的大小变为原来的两倍左右，空间复杂度依然是 <strong><code>O(n)</code></strong>。</li>
</ul>
</li>
<li><p><strong>结论：</strong><br>通过精准地定位差异并对离散化这一关键步骤进行升级，我们成功地将逆序对模板适配到了新问题上，<strong>方案高效可行</strong>。</p>
</li>
</ul>
<h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a><strong>实现</strong></h3><p>最终的AC代码，清晰地保留了逆序对模板的骨架，但在离散化的部分，能明显看到为了适应新规则而做的扩展。</p>
<details>
<summary>点击展开/折叠 最终AC代码</summary>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> ll = <span class="type">long</span> <span class="type">long</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> n, k;</span><br><span class="line">ll ans;</span><br><span class="line">vector&lt;<span class="type">int</span>&gt;a, b;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Lowbit</span><span class="params">(<span class="type">int</span> x)</span></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> x &amp; -x;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">ll <span class="title">Sum</span><span class="params">(<span class="type">int</span> x, ll arr[])</span></span>&#123;</span><br><span class="line">	ll ansSUM = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> i = x; i != <span class="number">0</span>; i -= <span class="built_in">Lowbit</span>(i))&#123;</span><br><span class="line">		ansSUM += arr[i];</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> ansSUM;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Update</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> add, <span class="type">int</span> size, ll arr[])</span></span>&#123;</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> i = x; i &lt;= size; i += <span class="built_in">Lowbit</span>(i))&#123;</span><br><span class="line">		arr[i] += add;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	ios_base::<span class="built_in">sync_with_stdio</span>(<span class="literal">false</span>);</span><br><span class="line">	cin.<span class="built_in">tie</span>(<span class="literal">NULL</span>);</span><br><span class="line">	cin &gt;&gt; n &gt;&gt; k;</span><br><span class="line">	a.<span class="built_in">reserve</span>(n + <span class="number">5</span>);</span><br><span class="line">	b.<span class="built_in">reserve</span>(<span class="number">2</span> * n + <span class="number">5</span>);</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>; i &lt;= n; i++)&#123;</span><br><span class="line">		<span class="type">int</span> num;</span><br><span class="line">		cin &gt;&gt; num;</span><br><span class="line">		a.<span class="built_in">push_back</span>(num);</span><br><span class="line">		b.<span class="built_in">push_back</span>(num);</span><br><span class="line">		b.<span class="built_in">push_back</span>(k * num);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">sort</span>(b.<span class="built_in">begin</span>(), b.<span class="built_in">end</span>());</span><br><span class="line">	b.<span class="built_in">erase</span>(<span class="built_in">unique</span>(b.<span class="built_in">begin</span>(), b.<span class="built_in">end</span>()), b.<span class="built_in">end</span>());</span><br><span class="line">	<span class="type">int</span> size = b.<span class="built_in">size</span>();</span><br><span class="line">	ll c[size + <span class="number">5</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	ll cnt = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> p : a)&#123;</span><br><span class="line">		cnt++;</span><br><span class="line">		<span class="type">int</span> idx = <span class="built_in">lower_bound</span>(b.<span class="built_in">begin</span>(), b.<span class="built_in">end</span>(), p) - b.<span class="built_in">begin</span>() + <span class="number">1</span>;</span><br><span class="line">		<span class="type">int</span> idx2 = <span class="built_in">lower_bound</span>(b.<span class="built_in">begin</span>(), b.<span class="built_in">end</span>(), p * k) - b.<span class="built_in">begin</span>() + <span class="number">1</span>;</span><br><span class="line">		<span class="built_in">Update</span>(idx, <span class="number">1</span>, size, c);</span><br><span class="line">		ans += cnt - <span class="built_in">Sum</span>(idx2, c);</span><br><span class="line">	&#125;</span><br><span class="line">	cout &lt;&lt; ans;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</details>

<hr>
<h2 id="代码对比"><a href="#代码对比" class="headerlink" title="代码对比"></a>代码对比</h2><p>整个改造过程实际只涉及两个关键环节。</p>
<h3 id="1-扩展离散化集合"><a href="#1-扩展离散化集合" class="headerlink" title="1. 扩展离散化集合"></a>1. 扩展离散化集合</h3><p><strong>模板代码</strong>：仅收集原数组中的值。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 离散化集合 b 只需包含 a 内的值</span></span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>; i &lt;= n; i++)&#123;</span><br><span class="line">    <span class="type">int</span> num;</span><br><span class="line">    cin &gt;&gt; num;</span><br><span class="line">    a.<span class="built_in">push_back</span>(num);</span><br><span class="line">    b.<span class="built_in">push_back</span>(num);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>本题代码</strong>：同时收集原数值与其 <code>k</code> 倍值。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 离散化集合 b 必须同时包含 a 内的值及其 k 倍</span></span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>; i &lt;= n; i++)&#123;</span><br><span class="line">    ll num;</span><br><span class="line">    cin &gt;&gt; num;</span><br><span class="line">    a.<span class="built_in">push_back</span>(num);</span><br><span class="line">    b.<span class="built_in">push_back</span>(num);</span><br><span class="line">    b.<span class="built_in">push_back</span>(k * num); <span class="comment">// 【改动】为查询 k*p 预作准备</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>原因</strong>：树状数组需要查询 <code>k*p</code> 的排名，因此必须在一开始就将所有可能的 <code>k*p</code> 值纳入离散化，以建立统一的排名体系。</p>
<h3 id="2-变更查询边界"><a href="#2-变更查询边界" class="headerlink" title="2. 变更查询边界"></a>2. 变更查询边界</h3><p><strong>模板代码</strong>：查询大于 <code>p</code> 的元素个数。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="type">int</span> p : a)&#123;</span><br><span class="line">    <span class="comment">// 查询和更新都使用 p 自身的排名</span></span><br><span class="line">    <span class="type">int</span> idx = <span class="built_in">lower_bound</span>(b.<span class="built_in">begin</span>(), b.<span class="built_in">end</span>(), p) - b.<span class="built_in">begin</span>() + <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 查询边界是 p 本身</span></span><br><span class="line">    ans += cnt - <span class="built_in">Sum</span>(idx, c);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">Update</span>(idx, <span class="number">1</span>, size, c);</span><br><span class="line">    cnt++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>本题代码</strong>：查询大于 <code>k*p</code> 的元素个数。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(ll p : a)&#123;</span><br><span class="line">    <span class="comment">// 更新时用 p 的排名</span></span><br><span class="line">    <span class="type">int</span> idx = <span class="built_in">lower_bound</span>(b.<span class="built_in">begin</span>(), b.<span class="built_in">end</span>(), p) - b.<span class="built_in">begin</span>() + <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 【改动】计算新的查询边界 k*p 的排名</span></span><br><span class="line">    <span class="type">int</span> idx2 = <span class="built_in">lower_bound</span>(b.<span class="built_in">begin</span>(), b.<span class="built_in">end</span>(), p * k) - b.<span class="built_in">begin</span>() + <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 【改动】使用新的排名 idx2 进行查询</span></span><br><span class="line">    ans += cnt - <span class="built_in">Sum</span>(idx2, c);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">Update</span>(idx, <span class="number">1</span>, size, c);</span><br><span class="line">    cnt++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>原因</strong>：题目的核心条件从 <code>&gt; p</code> 变为 <code>&gt; k*p</code>，因此计算贡献时，传入 <code>Sum</code> 函数的参数，必须是 <code>k*p</code> 对应的排名，而非 <code>p</code> 的排名。</p>
<hr>
<p><strong>P.S.</strong> 例行在最后放上做题手稿</p>
<img src="/2025/10/13/K-InversePairs/1.jpg" class="" title="做题手稿">

<hr>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol>
<li><strong>模型识别与套用</strong>：将新问题关联到已知的算法模型（本题的<strong>逆序对模板</strong>），以此为基础快速构建解题框架。</li>
<li><strong>分析核心差异</strong>：精准定位问题变体的关键不同点。本题的核心差异在于判断条件从 <code>a[i] &gt; a[j]</code> 变更为 <code>a[i] &gt; k * a[j]</code>。</li>
<li><strong>模块化调整</strong>：根据核心差异，修改算法中受影响的模块。此题中，查询条件的变更，直接决定了<strong>离散化</strong>的数据集合必须相应地扩展。</li>
<li><strong>理解功能而非形式</strong>：掌握算法中每个模块的<strong>功能目的</strong>是解决问题的关键。这使得我们能根据问题变化，对模板进行有效调整，而不是进行无效的生搬硬套。</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/10/12/LilacFractal/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="nine19een">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="nine19een's Blog">
      <meta itemprop="description" content="记录学习过程中的思考、题解与复盘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | nine19een's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/10/12/LilacFractal/" class="post-title-link" itemprop="url">丁香花分形·复盘——从递推关系中洞悉分形之美</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-10-12 03:05:52 / 修改时间：03:24:30" itemprop="dateCreated datePublished" datetime="2025-10-12T03:05:52+08:00">2025-10-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%AE%97%E6%B3%95%E9%A2%98%E8%A7%A3-%E5%A4%8D%E7%9B%98/" itemprop="url" rel="index"><span itemprop="name">算法题解/复盘</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本题由某位BUAA大佬分享。</p>
<p>初见这道图形题时，我被其酷似分形的演变过程所吸引。它看似是一个纯粹的图形模拟题，但随着操作次数 <code>n</code> 的增加，图形的尺寸和复杂性都呈爆炸式增长，让我意识到简单的暴力绘制绝非正解。本文旨在复盘我如何从繁杂的图形变化中发现并实现一个精妙的递推关系，最终优雅地解决这个问题的全过程。</p>
<hr>
<h2 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h2><h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>丁香花通常由四片花瓣组成，四片花瓣的位置关系可以简要用图1表示。</p>
<p>单单四个正方形显然还不能表达丁香花的魅力，因此我们将该图形进行<strong>一次操作</strong>，包含以下两个步骤：</p>
<ol>
<li>将图形重复4次，如图2所示；</li>
<li>将图形旋转45度，如图3所示。</li>
</ol>
<p>我们将上述两个步骤整体称为<strong>一次操作</strong>。在图3基础上再重复一次操作，我们就能得到图4。</p>
<table>
<thead>
<tr>
<th align="center"></th>
<th align="center"></th>
<th align="center"></th>
<th align="center"></th>
</tr>
</thead>
<tbody><tr>
<td align="center"><img src="/2025/10/12/LilacFractal/111.png" class="" title="图1"></td>
<td align="center"><img src="/2025/10/12/LilacFractal/222.png" class="" title="图2"></td>
<td align="center"><img src="/2025/10/12/LilacFractal/333.png" class="" title="图3"></td>
<td align="center"><img src="/2025/10/12/LilacFractal/444.png" class="" title="图4"></td>
</tr>
<tr>
<td align="center"><strong>图1</strong>: 基础图形</td>
<td align="center"><strong>图2</strong>: 基础图形重复四次</td>
<td align="center"><strong>图3</strong>: 进行一次操作后</td>
<td align="center"><strong>图4</strong>: 进行两次操作后</td>
</tr>
</tbody></table>
<h3 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h3><p>本题需要你编程绘出进行了 <code>n</code> 次操作后的图形（注意：<strong>基础图形</strong>为进行了 <strong>0 次</strong>操作的图形）。</p>
<p>输出时，图形中有正方形的位置输出一个字符 <code>o</code>，没有正方形的位置输出一个空格 <code> </code>。行末的空格可以忽略。</p>
<p>例如，对于<strong>图1</strong> (<code>n=0</code>)，应该输出为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">  o</span><br><span class="line">o   o</span><br><span class="line">  o</span><br></pre></td></tr></table></figure>

<p>又如，对于<strong>图4</strong> (<code>n=2</code>)，应该输出为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">            o     o</span><br><span class="line">          o   o o   o</span><br><span class="line">            o     o</span><br><span class="line">            o     o</span><br><span class="line">          o   o o   o</span><br><span class="line">  o     o   o     o   o     o</span><br><span class="line">o   o o   o         o   o o   o</span><br><span class="line">  o     o             o     o</span><br><span class="line">  o     o             o     o</span><br><span class="line">o   o o   o         o   o o   o</span><br><span class="line">  o     o   o     o   o     o</span><br><span class="line">          o   o o   o</span><br><span class="line">            o     o</span><br><span class="line">            o     o</span><br><span class="line">          o   o o   o</span><br><span class="line">            o     o</span><br></pre></td></tr></table></figure>

<h3 id="输入"><a href="#输入" class="headerlink" title="输入"></a>输入</h3><p>输入一个非负整数 <code>n</code>，表示操作的次数。</p>
<p>数据保证 <code>0 &lt;= n &lt;= 6</code>。</p>
<h3 id="输出"><a href="#输出" class="headerlink" title="输出"></a>输出</h3><p>输出经过 <code>n</code> 次操作后对应的图形。</p>
<p><strong>特别注意</strong>：为了方便在控制台进行输出，当操作次数 <code>n</code> 为<strong>奇数</strong>时，请将图形<strong>旋转45度再输出</strong>。</p>
<h3 id="输入样例"><a href="#输入样例" class="headerlink" title="输入样例"></a>输入样例</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1</span><br></pre></td></tr></table></figure>

<h3 id="输出样例"><a href="#输出样例" class="headerlink" title="输出样例"></a>输出样例</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  o     o</span><br><span class="line">o   o o   o</span><br><span class="line">  o     o</span><br><span class="line">  o     o</span><br><span class="line">o   o o   o</span><br><span class="line">  o     o</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="题目分析"><a href="#题目分析" class="headerlink" title="题目分析"></a>题目分析</h2><p>理解题目后，我们可以将<strong>一次操作</strong>分解为两个基本步骤的组合：</p>
<ol>
<li><strong>膨胀</strong>：将当前图形作为单元，无重叠地平铺成一个 2x2 的更大图形。</li>
<li><strong>重组</strong>：将膨胀后得到的四个象限进行有重叠的重新排列，形成类似<strong>旋转45度</strong>的视觉效果。</li>
</ol>
<p>直接模拟这个过程的难点在于<strong>第二步（重组）</strong>。每次重组后，新图形的边长是多少？四个象限应该放置在哪个精确的坐标上？这些参数的变化并非线性，如果不能找到其规律，算法将无从下手。因此，整个问题的核心，从<strong>如何画图</strong>转变成了<strong>如何计算每一步操作的画布尺寸与布局坐标</strong>。</p>
<p>我的解法选择了一个迭代的思路，从 <code>n=0</code> 的基础图形出发，循环 <code>n</code> 次，每次迭代生成下一阶段的图形。这个迭代过程并非一成不变，而是根据迭代次数的奇偶，执行两种截然不同的生成逻辑。</p>
<hr>
<h2 id="算法设计及实现"><a href="#算法设计及实现" class="headerlink" title="算法设计及实现"></a><strong>算法设计及实现</strong></h2><p>我的算法将题目中抽象的“一次操作”，具象化为一次<strong>奇数步膨胀</strong>和一次<strong>偶数步重组</strong>的交替执行。通过一个 <code>for</code> 循环，我们模拟 <code>n</code> 次这样的交替演变，最终得到目标图形。</p>
<h3 id="核心思路：奇偶交替的迭代生成"><a href="#核心思路：奇偶交替的迭代生成" class="headerlink" title="核心思路：奇偶交替的迭代生成"></a><strong>核心思路：奇偶交替的迭代生成</strong></h3><p>我们用一个 <code>for</code> 循环从 <code>i=1</code> 到 <code>n</code> 进行迭代，其中 <code>i</code> 代表当前是第几次演变。</p>
<ol>
<li><p><strong>当 <code>i</code> 为奇数时：膨胀阶段</strong></p>
<ul>
<li><strong>任务</strong>：执行纯粹的复制与放大。</li>
<li><strong>实现</strong>：我们将上一步（<code>i-1</code>）得到的完整图形（记为 <code>temp</code>）视为一个“瓦片”。然后，在一个尺寸为 <code>a_temp * 2</code> 的新画布（记为 <code>pic</code>）上，将这个瓦片无重叠地铺满 <code>pic</code> 的四个象限。这一步非常直观，图形的结构不变，只是尺寸翻倍。</li>
</ul>
</li>
<li><p><strong>当 <code>i</code> 为偶数时：重组阶段</strong></p>
<ul>
<li><strong>任务</strong>：执行复杂的重叠与收缩。</li>
<li><strong>实现</strong>：这一步处理的是奇数阶段生成的、由四个象限组成的膨胀图形。我们将这四个“瓦片”重新排列，将它们分别放置在新画布的<strong>上、下、左、右</strong>四个方位，形成一个中心重叠的十字形状。</li>
<li><strong>难点</strong>：新画布的尺寸 <code>a_pic</code> 以及四个“瓦片”的精确放置坐标，是这一步的关键。通过观察和推演，我发现了一个至关重要的递推规律。</li>
</ul>
</li>
</ol>
<h3 id="关键发现：b-i-3-递推规律"><a href="#关键发现：b-i-3-递推规律" class="headerlink" title="关键发现：b[i-3] 递推规律"></a><strong>关键发现：<code>b[i-3]</code> 递推规律</strong></h3><p>在重组阶段，各项参数的计算并非无迹可寻。我发现，当进行第 <code>i</code> 次演变（<code>i</code> 为偶数且 <code>i &gt;= 4</code>）时，新画布的尺寸以及重叠的深度，都与<strong>第 <code>i-3</code> 次演变完成时的画布边长 <code>b[i-3]</code></strong> 存在一个确定的数学关系。</p>
<p>下图为做题时的手绘示意图，可供直观理解：</p>
<img src="/2025/10/12/LilacFractal/2.jpg" class="" title="草稿">

<ul>
<li><p><strong>新画布尺寸 <code>a_pic</code> 的计算 (<code>update_a</code> 函数):</strong><br><code>a_pic(i) = a_pic(i-1) + (a_pic(i-1) - b[i-3]) * 2</code><br>这里的 <code>a_pic(i-1)</code> 是上一个奇数膨胀阶段的边长。这个公式描述了新画布如何在上一阶段的基础上，根据 <code>i-3</code> 步的历史状态进行扩张。</p>
</li>
<li><p><strong>布局坐标的计算 (<code>draw</code> 函数):</strong><br>在 <code>draw</code> 函数中，放置“瓦片”的起始坐标偏移量，也由 <code>b[i-3]</code> 决定。例如，左侧瓦片的 <code>y</code> 坐标和上方瓦片的 <code>x</code> 坐标，都涉及到一个关键偏移量：<code>a_temp - (b[i - 3] - 1)</code>，其中 <code>a_temp</code> 是 <code>a_pic(i-1)</code>。</p>
</li>
</ul>
<p>这个递推关系，正是图形演变过程的关键。它将一个复杂的几何问题，转化为了一个可以通过历史数据精确计算的数学问题。<code>i=2</code> 的情况由于 <code>i-3</code> 无意义，需要作为特殊情况单独处理。</p>
<h3 id="可行性分析"><a href="#可行性分析" class="headerlink" title="可行性分析"></a><strong>可行性分析</strong></h3><ul>
<li><p><strong>时间复杂度:</strong></p>
<ul>
<li>外层循环执行 <code>n</code> 次。在每次循环内部，核心操作是 <code>draw</code> 函数，它本质上是数组的复制，复杂度为 <code>O(a_temp^2)</code>。</li>
<li>画布边长 <code>a_pic</code> 大致以 <code>2*sqrt(2)</code> 为公比的等比数列增长（奇数步<code>*2</code>，偶数步<code>*sqrt(2)</code>左右）。当 <code>n</code> 较小时，<code>a_pic</code> 的增长在可控范围内，对于题目数据范围，总计算量可以接受。</li>
</ul>
</li>
<li><p><strong>空间复杂度:</strong></p>
<ul>
<li>我们需要 <code>pic</code> 和 <code>temp</code> 两个二维数组来存储图形，其大小由最终的 <code>a_pic</code> 决定。空间复杂度为 <code>O(a_pic^2)</code>。</li>
</ul>
</li>
<li><p><strong>结论：</strong><br>该算法将复杂的图形生成问题转化为迭代计算，通过发现递推规律避免了复杂的几何推导，<strong>方案可行</strong>。</p>
</li>
</ul>
<h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a><strong>实现</strong></h3><p>基于以上思路，我构建了最终的AC代码。它通过 <code>pic</code> 和 <code>temp</code> 两个数组作为双缓冲，交替进行图形的生成和暂存，并通过 <code>update_a</code> 和 <code>draw</code> 函数，精确实现了奇偶交替的演变逻辑。</p>
<details>
<summary>点击展开/折叠 最终AC代码</summary>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="type">int</span> <span class="type">const</span> maxn = <span class="number">1e3</span> + <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> n, a_pic = <span class="number">3</span>, a_temp = <span class="number">3</span>, b[<span class="number">10</span>];</span><br><span class="line"><span class="type">char</span> pic[maxn][maxn];</span><br><span class="line"><span class="type">char</span> temp[maxn][maxn];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">isEven</span><span class="params">(<span class="type">int</span> num)</span></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> !(num &amp; <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">draw</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y)</span></span>&#123;</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>; i &lt;= a_temp; ++i)&#123;</span><br><span class="line">		<span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">1</span>; j &lt;= a_temp; ++j)&#123;</span><br><span class="line">			<span class="keyword">if</span>(pic[x + i - <span class="number">1</span>][y + j - <span class="number">1</span>] != <span class="string">&#x27;o&#x27;</span>)&#123;</span><br><span class="line">				pic[x + i - <span class="number">1</span>][y + j - <span class="number">1</span>] = temp[i][j];</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">update_a</span><span class="params">(<span class="type">int</span> x)</span></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(!<span class="built_in">isEven</span>(x))&#123;</span><br><span class="line">		a_pic *= <span class="number">2</span>;</span><br><span class="line">		b[x] = a_pic;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(x == <span class="number">2</span>)&#123;</span><br><span class="line">			a_pic = a_temp * <span class="number">3</span> - <span class="number">2</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span>&#123;</span><br><span class="line">			a_pic = a_pic + (a_pic - b[x - <span class="number">3</span>]) * <span class="number">2</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">update_temp</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>; i &lt;= a_pic; ++i)&#123;</span><br><span class="line">		<span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">1</span>; j &lt;= a_pic; ++j)&#123;</span><br><span class="line">			<span class="keyword">if</span> (pic[i][j] == <span class="number">0</span>) &#123;</span><br><span class="line">				pic[i][j] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			temp[i][j] = pic[i][j];</span><br><span class="line">		&#125;	</span><br><span class="line">	&#125;</span><br><span class="line">	a_temp = a_pic;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	ios_base::<span class="built_in">sync_with_stdio</span>(<span class="literal">false</span>);</span><br><span class="line">	cin.<span class="built_in">tie</span>(<span class="literal">NULL</span>);</span><br><span class="line">	temp[<span class="number">1</span>][<span class="number">1</span>] = <span class="string">&#x27; &#x27;</span>, temp[<span class="number">1</span>][<span class="number">2</span>] = <span class="string">&#x27;o&#x27;</span>, temp[<span class="number">1</span>][<span class="number">3</span>] = <span class="string">&#x27; &#x27;</span>, temp[<span class="number">2</span>][<span class="number">1</span>] = <span class="string">&#x27;o&#x27;</span>, temp[<span class="number">2</span>][<span class="number">2</span>] = <span class="string">&#x27; &#x27;</span>, temp[<span class="number">2</span>][<span class="number">3</span>] = <span class="string">&#x27;o&#x27;</span>, temp[<span class="number">3</span>][<span class="number">1</span>] = <span class="string">&#x27; &#x27;</span>, temp[<span class="number">3</span>][<span class="number">2</span>] = <span class="string">&#x27;o&#x27;</span>, temp[<span class="number">3</span>][<span class="number">3</span>] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">	cin &gt;&gt; n;</span><br><span class="line">	<span class="keyword">if</span>(n == <span class="number">0</span>)&#123;</span><br><span class="line">		<span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">3</span>; ++i)&#123;</span><br><span class="line">			<span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">1</span>; j &lt;= <span class="number">3</span>; ++j)&#123;</span><br><span class="line">				cout &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; temp[i][j];</span><br><span class="line">			&#125;</span><br><span class="line">			cout &lt;&lt; <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125; </span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>; i &lt;= n; ++i)&#123;</span><br><span class="line">		<span class="built_in">update_a</span>(i);</span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">1</span>; j &lt;= a_temp; ++j) &#123;</span><br><span class="line">			<span class="built_in">memset</span>(pic[j], <span class="number">0</span>, <span class="keyword">sizeof</span> pic[j]);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(!<span class="built_in">isEven</span>(i))&#123;</span><br><span class="line">			<span class="built_in">draw</span>(<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">			<span class="built_in">draw</span>(<span class="number">1</span>, <span class="number">1</span> + a_temp);</span><br><span class="line">			<span class="built_in">draw</span>(<span class="number">1</span> + a_temp, <span class="number">1</span>);</span><br><span class="line">			<span class="built_in">draw</span>(<span class="number">1</span> + a_temp, <span class="number">1</span> + a_temp);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="keyword">if</span>(i == <span class="number">2</span>)&#123;</span><br><span class="line">				<span class="built_in">draw</span>(<span class="number">1</span>, a_temp);</span><br><span class="line">				<span class="built_in">draw</span>(a_temp, <span class="number">1</span>);</span><br><span class="line">				<span class="built_in">draw</span>(a_temp, <span class="number">2</span> * a_temp - <span class="number">1</span>);</span><br><span class="line">				<span class="built_in">draw</span>(<span class="number">2</span> * a_temp - <span class="number">1</span>, a_temp);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span>&#123;</span><br><span class="line">				<span class="built_in">draw</span>(<span class="number">1</span>, a_temp - (b[i - <span class="number">3</span>] - <span class="number">1</span>));</span><br><span class="line">				<span class="built_in">draw</span>(a_temp - (b[i - <span class="number">3</span>] - <span class="number">1</span>), <span class="number">1</span>);</span><br><span class="line">				<span class="built_in">draw</span>(a_temp - (b[i - <span class="number">3</span>] - <span class="number">1</span>), <span class="number">2</span> * a_temp - (<span class="number">2</span> * b[i - <span class="number">3</span>] - <span class="number">1</span>));</span><br><span class="line">				<span class="built_in">draw</span>(<span class="number">2</span> * a_temp - (<span class="number">2</span> * b[i - <span class="number">3</span>] - <span class="number">1</span>), a_temp - (b[i - <span class="number">3</span>] - <span class="number">1</span>));</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">update_temp</span>();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>; i &lt;= a_pic; ++i)&#123;</span><br><span class="line">		<span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">1</span>; j &lt;= a_pic; ++j)&#123;</span><br><span class="line">			cout &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; pic[i][j];</span><br><span class="line">		&#125;</span><br><span class="line">		cout &lt;&lt; <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</details>

<h3 id="各阶段图形演变"><a href="#各阶段图形演变" class="headerlink" title="各阶段图形演变"></a>各阶段图形演变</h3><p>为了直观地展示算法的最终效果以及图形的演变之美，以下是 <code>n=0</code> 到 <code>n=6</code> 的完整输出图形。</p>
<details>
<summary>点击展开/折叠 n=0 的输出图形</summary>

<img src="/2025/10/12/LilacFractal/n0_output.png" class="" title="n&#x3D;0 输出">

</details>

<details>
<summary>点击展开/折叠 n=1 的输出图形</summary>

<img src="/2025/10/12/LilacFractal/n1_output.png" class="" title="n&#x3D;1 输出">

</details>

<details>
<summary>点击展开/折叠 n=2 的输出图形</summary>

<img src="/2025/10/12/LilacFractal/n2_output.png" class="" title="n&#x3D;2 输出">

</details>

<details>
<summary>点击展开/折叠 n=3 的输出图形</summary>

<img src="/2025/10/12/LilacFractal/n3_output.png" class="" title="n&#x3D;3 输出">

</details>

<details>
<summary>点击展开/折叠 n=4 的输出图形</summary>

<img src="/2025/10/12/LilacFractal/n4_output.png" class="" title="n&#x3D;4 输出">

</details>

<details>
<summary>点击展开/折叠 n=5 的输出图形</summary>

<img src="/2025/10/12/LilacFractal/n5_output.png" class="" title="n&#x3D;5 输出">

</details>

<details>
<summary>点击展开/折叠 n=6 的输出图形</summary>

<img src="/2025/10/12/LilacFractal/n6_output.png" class="" title="n&#x3D;6 输出">

</details>

<hr>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol>
<li><strong>分解操作步骤</strong>：解决本题的第一步，是将题目描述的单次复杂操作，拆解为<strong>奇数步膨胀</strong>和<strong>偶数步重组</strong>这两个逻辑更清晰、更容易实现的交替步骤。</li>
<li><strong>寻找递推规律</strong>：对于复杂的模拟题，直接推导通项公式往往很困难。本题的突破口在于观察并发现了控制图形尺寸和坐标的递推关系（<code>b[i-3]</code>规律），这比纯粹的几何分析要直接得多。</li>
<li><strong>迭代与双缓冲</strong>：采用迭代的方式，一步步从初始状态构建出最终图形，是解决此类问题的稳妥方法。使用 <code>pic</code> 和 <code>temp</code> 两个数组作为双缓冲，可以很方便地根据前一阶段的图形来生成下一阶段，避免了数据的原地修改冲突。</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/10/02/Luogu-P8613-Review/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="nine19een">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="nine19een's Blog">
      <meta itemprop="description" content="记录学习过程中的思考、题解与复盘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | nine19een's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/10/02/Luogu-P8613-Review/" class="post-title-link" itemprop="url">洛谷P8613小朋友排队·复盘——浅谈冒泡排序与逆序对</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2025-10-02 16:05:52" itemprop="dateCreated datePublished" datetime="2025-10-02T16:05:52+08:00">2025-10-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-10-13 02:21:31" itemprop="dateModified" datetime="2025-10-13T02:21:31+08:00">2025-10-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%AE%97%E6%B3%95%E9%A2%98%E8%A7%A3-%E5%A4%8D%E7%9B%98/" itemprop="url" rel="index"><span itemprop="name">算法题解/复盘</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>前两天做了一道蓝桥省赛题，是一道对排序思想和实现细节要求较高的题目，由于初次解题时对问题模型的理解存在偏差，导致我的算法方案迭代了两次，耗费了较多时间。本文旨在对整个求解过程进行技术性复盘，深入剖析错误思路的根源，并最终给出一个高效严谨的正确实现。</p>
<hr>
<h2 id="题目分析"><a href="#题目分析" class="headerlink" title="题目分析"></a>题目分析</h2><p><strong><a target="_blank" rel="noopener" href="https://www.luogu.com.cn/problem/P8613">P8613 [蓝桥杯 2014 省 B] 小朋友排队</a></strong></p>
<img src="/2025/10/02/Luogu-P8613-Review/1.png" class="" title="题面">

<p>理解题目后，我们可以提炼出一个核心流程来简化题目：<strong>计算每个小朋友被交换的次数→计算每个小朋友的不高兴程度→求和</strong>。</p>
<p>不难发现，<strong>每次只能交换位置相邻的两个小朋友</strong>实际上就是<strong>冒泡排序</strong>的操作流程。所以问题也就变成了：<strong>对所有小朋友进行冒泡排序，统计出每个小朋友被交换了多少次，并对每个小朋友的不高兴程度进行求和</strong>。</p>
<p>接下来我们需要用到一个小结论：<strong>对一个序列进行冒泡排序时，总交换次数等于该序列逆序对的数量</strong>。结论其实不难理解，对于每一对元素，只有当该对元素为逆序对时，我们才会对其进行交换操作。因此，<strong>总交换次数</strong>一定严格等于<strong>总逆序对数量</strong>。</p>
<p>而在本题中，我们需要的不是<strong>总交换次数</strong>，而是<strong>每个元素被交换的次数</strong>，这也很好实现，仅需统计<strong>包含该元素的逆序对的数量</strong>即可。</p>
<p>至于最终的求和部分，只需要对每个小朋友进行一次<strong>等差数列求和</strong>：<code>f(k) = k * (k+1) / 2</code>，再对所有元素进行求和：<code>Σf(k_i)</code>即可。</p>
<hr>
<h2 id="算法设计及实现"><a href="#算法设计及实现" class="headerlink" title="算法设计及实现"></a><strong>算法设计及实现</strong></h2><p>在明确了<strong>计算每个元素的逆序对总数</strong>这一核心目标后，我选择使用<strong>树状数组+离散化</strong>来解决问题，下文的两次算法设计迭代也都将围绕着树状数组来进行。</p>
<h3 id="V1-0-初试"><a href="#V1-0-初试" class="headerlink" title="V1.0 初试"></a><strong>V1.0 初试</strong></h3><p>最初的方案基于一个宏观的、但忽略了个体差异的思路，它整合了离散化、树状数组和双向遍历三种核心技术，旨在按<strong>身高种类</strong>进行逆序对的统计。</p>
<h4 id="设计"><a href="#设计" class="headerlink" title="设计"></a>设计</h4><ol>
<li><p><strong>核心数据结构：<code>ans_c</code> 数组</strong></p>
<ul>
<li>创建一个大小为 <code>size</code> (唯一身高值的数量) 的数组 <code>ans_c</code>，其中 <code>ans_c[idx]</code> 用于存储<strong>身高排名为 <code>idx</code></strong> 的所有小朋友的逆序对总数（或其累加值）。</li>
</ul>
</li>
<li><p><strong>离散化</strong></p>
<ul>
<li><strong>动机</strong>：<br>题目中身高 <code>H_i</code> 的值域可达 <code>10^6</code>，而 <code>n</code> 最多为 <code>10^5</code>。直接使用身高值作为数组下标是不可行的。</li>
<li><strong>实现</strong>：<br>通过 <strong>排序→去重</strong> 操作，将所有出现过的身高值映射到一个 <code>[1, size]</code> 的紧凑整数区间。一个原始身高值 <code>H</code> 在排序去重后数组 <code>b</code> 中的位置（下标+1），就是它离散化后的新排名 <code>idx</code>。这个 <code>idx</code> 将作为 <code>ans_c</code> 数组和树状数组的下标。</li>
</ul>
</li>
<li><p><strong>树状数组</strong></p>
<ul>
<li><strong>本质</strong>：<br>树状数组是一种高效的数据结构，能够在 <code>O(log n)</code> 的时间内，同时完成 <strong>单点更新</strong> 和 <strong>查询前缀和</strong> 两种操作。</li>
<li><strong>在本方案中的应用</strong>：<br>我利用树状数组来动态回答一个核心问题：“在我当前遍历过的集合中，身高排名在某个范围内的有多少人？”<ul>
<li><code>update(idx, 1)</code>： 当处理一个身高排名为 <code>idx</code> 的小朋友时，执行此操作，意味着“身高排名为<code>idx</code>的人数+1”。</li>
<li><code>query(idx)</code>： 执行此操作，可以得到“身高排名在 <code>[1, idx]</code> 区间内的人数总和”。</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>双向遍历策略</strong></p>
<ul>
<li><strong>依据</strong>：<br>一个元素的总逆序对数 <code>k</code>，等于其<strong>左侧</strong>大于它的元素数，加上其<strong>右侧</strong>小于它的元素数。这两个部分需要分开计算。</li>
</ul>
</li>
</ol>
<p><strong>算法执行流程</strong></p>
<ul>
<li><strong>a. 正向遍历 (计算左逆序对):</strong><ul>
<li>从左到右遍历原始身高数组 <code>a</code>。</li>
<li>对于每个身高 <code>p</code>，首先查询树状数组 <code>c</code>，计算在 <code>p</code> 左侧、且值大于 <code>p</code> 的元素数量。</li>
<li>将此数量<strong>赋值</strong>给 <code>ans_c[idx]</code>，其中 <code>idx</code> 是 <code>p</code> 的身高排名。</li>
<li>在树状数组中执行 <code>update(idx, 1)</code>，将当前元素 <code>p</code> 加入“已处理”集合。</li>
</ul>
</li>
<li><strong>b. 反向遍历 (计算右逆序对):</strong><ul>
<li>清空树状数组 <code>c</code>。</li>
<li>从右到左遍历原始身高数组 <code>a</code>。</li>
<li>对于每个身高 <code>p</code>，查询树状数组 <code>c</code>，计算在 <code>p</code> 右侧、且值小于 <code>p</code> 的元素数量。</li>
<li>将此数量<strong>累加</strong>到 <code>ans_c[idx]</code> 上。</li>
<li>在树状数组中执行 <code>update(idx, 1)</code>。</li>
</ul>
</li>
<li><strong>c. 计算总和:</strong><ul>
<li>遍历 <code>ans_c</code> 数组，对每个 <code>k = ans_c[idx]</code>，计算 <code>sum(k)</code> 并求和，得到最终答案。</li>
</ul>
</li>
</ul>
<h4 id="可行性分析"><a href="#可行性分析" class="headerlink" title="可行性分析"></a><strong>可行性分析</strong></h4><p>在编码前，对该方案的复杂度进行预估：</p>
<ul>
<li><p><strong>时间复杂度:</strong></p>
<ol>
<li><strong>离散化</strong>: 核心操作是 <code>std::sort</code>，复杂度为 <code>O(n log n)</code>。</li>
<li><strong>双向遍历</strong>: 包含两次独立的、遍历 <code>n</code> 个元素的循环。在每次循环内部，<code>lower_bound</code> 操作的复杂度为 <code>O(log size)</code>，树状数组的 <code>query</code> 和 <code>update</code> 操作复杂度均为 <code>O(log size)</code>。因此，这两次遍历的总时间复杂度为 <code>O(n log size)</code>。</li>
<li><strong>最终求和</strong>: <code>O(n)</code> 或 <code>O(size)</code>。</li>
</ol>
<ul>
<li>由于 <code>size &lt;= n</code>，因此<strong>总时间复杂度为 <code>O(n log n)</code></strong>。对于 <code>n = 10^5</code> 的数据规模，<code>10^5 * log(10^5)</code> 约等于 <code>1.7 * 10^6</code>，远在 <code>10^8</code> 的安全线内，<strong>不会TLE</strong>。</li>
</ul>
</li>
<li><p><strong>空间复杂度:</strong></p>
<ol>
<li><code>a</code>, <code>b</code> 两个 <code>vector</code> 占用 <code>O(n)</code> 空间。</li>
<li>树状数组 <code>cnt_c</code> 和结果数组 <code>ans_c</code> 均占用 <code>O(size)</code> 空间，最坏情况下 <code>size = n</code>，即 <code>O(n)</code>。</li>
</ol>
<ul>
<li><strong>总空间复杂度为 <code>O(n)</code></strong>，对于 <code>n = 10^5</code>，内存占用<strong>在可接受范围内</strong>。</li>
</ul>
</li>
<li><p><strong>结论：</strong><br>从时间&#x2F;空间复杂度的角度分析，<strong>方案可行</strong>。</p>
</li>
</ul>
<h4 id="实现"><a href="#实现" class="headerlink" title="实现"></a><strong>实现</strong></h4><p>基于以上思路，我构建了第一版代码。其核心是创建了一个大小为 <code>size</code> 的数组 <code>ans_c</code>，其中 <code>ans_c[idx]</code> 旨在存储身高排名为 <code>idx</code> 的小朋友的总逆序对数。此时我并没有注意到，我的算法设计存在一个严重的漏洞，这也让我的初次提交仅拿到了一个测试点的分数。</p>
<img src="/2025/10/02/Luogu-P8613-Review/2.png" class="" title="10分提交记录">

<p><a target="_blank" rel="noopener" href="https://www.luogu.com.cn/record/237572595">初次提交记录</a></p>
<details>
<summary>点击展开/折叠 初版代码</summary>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> ll = <span class="type">long</span> <span class="type">long</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="type">const</span> maxn = <span class="number">1e5</span> + <span class="number">5</span>;</span><br><span class="line"><span class="type">int</span> n;</span><br><span class="line"></span><br><span class="line">vector&lt;<span class="type">int</span>&gt; a, b;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">lowbit</span><span class="params">(<span class="type">int</span> x)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> x &amp; -x;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">ll <span class="title">query</span><span class="params">(<span class="type">int</span> x, ll arr[])</span> </span>&#123;</span><br><span class="line">    ll ans_q = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = x; i != <span class="number">0</span>; i -= <span class="built_in">lowbit</span>(i)) &#123;</span><br><span class="line">        ans_q += arr[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ans_q;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">update</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> add, <span class="type">int</span> size, ll arr[])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = x; i &lt;= size; i += <span class="built_in">lowbit</span>(i)) &#123;</span><br><span class="line">        arr[i] += add;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">ll <span class="title">sum</span><span class="params">(ll x)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="number">1</span> + x) * x / <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ios_base::<span class="built_in">sync_with_stdio</span>(<span class="literal">false</span>);</span><br><span class="line">    cin.<span class="built_in">tie</span>(<span class="literal">NULL</span>);</span><br><span class="line">    a.<span class="built_in">reserve</span>(maxn);</span><br><span class="line">    b.<span class="built_in">reserve</span>(maxn);</span><br><span class="line">    cin &gt;&gt; n;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">        <span class="type">int</span> num;</span><br><span class="line">        cin &gt;&gt; num;</span><br><span class="line">        a.<span class="built_in">push_back</span>(num);</span><br><span class="line">        b.<span class="built_in">push_back</span>(num);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">sort</span>(b.<span class="built_in">begin</span>(), b.<span class="built_in">end</span>());</span><br><span class="line">    b.<span class="built_in">erase</span>(<span class="built_in">unique</span>(b.<span class="built_in">begin</span>(), b.<span class="built_in">end</span>()), b.<span class="built_in">end</span>());</span><br><span class="line">    <span class="type">int</span> size = b.<span class="built_in">size</span>();</span><br><span class="line">    ll cnt_c[size + <span class="number">5</span>] = &#123;<span class="number">0</span>&#125;, ans_c[size + <span class="number">5</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="type">int</span> cnt = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> p : a) &#123;</span><br><span class="line">        cnt++;</span><br><span class="line">        <span class="type">int</span> idx = <span class="built_in">lower_bound</span>(b.<span class="built_in">begin</span>(), b.<span class="built_in">end</span>(), p) - b.<span class="built_in">begin</span>() + <span class="number">1</span>;</span><br><span class="line">        <span class="built_in">update</span>(idx, <span class="number">1</span>, size, cnt_c);</span><br><span class="line">        ans_c[idx] = cnt - <span class="built_in">query</span>(idx, cnt_c);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memset</span>(cnt_c, <span class="number">0</span>, <span class="built_in">sizeof</span>(cnt_c));</span><br><span class="line">    cnt = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> it = a.<span class="built_in">rbegin</span>(); it != a.<span class="built_in">rend</span>(); ++it) &#123;</span><br><span class="line">        <span class="type">int</span> idx = <span class="built_in">lower_bound</span>(b.<span class="built_in">begin</span>(), b.<span class="built_in">end</span>(), *it) - b.<span class="built_in">begin</span>() + <span class="number">1</span>;</span><br><span class="line">        ans_c[idx] += <span class="built_in">query</span>(idx, cnt_c);</span><br><span class="line">        <span class="built_in">update</span>(idx, <span class="number">1</span>, size, cnt_c);</span><br><span class="line">    &#125;</span><br><span class="line">    ll ans = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</span><br><span class="line">        ans += <span class="built_in">sum</span>(ans_c[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    cout &lt;&lt; ans &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</details>

<h4 id="错误分析"><a href="#错误分析" class="headerlink" title="错误分析"></a><strong>错误分析</strong></h4><p>该方案在提交后仅获得 10 分，原因在于其数据结构的设计与问题要求不匹配，存在严重的逻辑缺陷。</p>
<ul>
<li><p><strong>问题根源：</strong><br>当序列中存在多个身高相同的元素时，它们在离散化后会映射到<strong>同一个排名 <code>idx</code></strong>。这导致 <code>ans_c[idx]</code> 在计算过程中，会<strong>错误地覆盖或累加</strong>属于不同原始位置元素的数据。</p>
<p>例如，对于序列 <code>[H1, H2, H1]</code>，第二个 <code>H1</code> 的计算结果会直接覆盖第一个 <code>H1</code> 的，造成信息丢失。</p>
</li>
<li><p><strong>结论：</strong><br>算法的数据统计粒度必须精确到<strong>每个独立的个体<code>n</code></strong>，而非<strong>每种属性的类别<code>size</code></strong>。</p>
</li>
</ul>
<h3 id="V2-0-改进（AC方案）"><a href="#V2-0-改进（AC方案）" class="headerlink" title="V2.0 改进（AC方案）"></a><strong>V2.0 改进（AC方案）</strong></h3><p>为修正上述缺陷，必须调整数据结构，为每个原始元素建立独立的档案。</p>
<h4 id="设计-1"><a href="#设计-1" class="headerlink" title="设计"></a><strong>设计</strong></h4><ol>
<li>创建一个大小为 <code>n</code> 的数组 <code>ans_a</code>，其中 <code>ans_a[i]</code> 用于存储<strong>原始序列中第 <code>i</code> 个元素</strong>的总交换次数。</li>
<li><strong>正向遍历 (计算左逆序对):</strong><ul>
<li><code>for i from 0 to n-1</code>:</li>
<li>利用树状数组 <code>c</code> 查询在 <code>[0, i-1]</code> 区间内，值大于 <code>a[i]</code> 的元素数量。</li>
<li>结果累加至 <code>ans_a[i]</code>。</li>
<li>将 <code>a[i]</code> 的信息更新到树状数组 <code>c</code> 中。</li>
</ul>
</li>
<li><strong>反向遍历 (计算右逆序对):</strong><ul>
<li>清空树状数组 <code>c</code>。</li>
<li><code>for i from n-1 down to 0</code>:</li>
<li>利用树状数组 <code>c</code> 查询在 <code>[i+1, n-1]</code> 区间内，值小于 <code>a[i]</code> 的元素数量。</li>
<li>结果累加至 <code>ans_a[i]</code>。</li>
<li>将 <code>a[i]</code> 的信息更新到树状数组 <code>c</code> 中。</li>
</ul>
</li>
<li><strong>计算总和:</strong><ul>
<li>遍历 <code>ans_a</code> 数组，对每个 <code>k_i = ans_a[i]</code>，计算 <code>sum(k_i)</code> 并累加，得到最终答案。</li>
</ul>
</li>
</ol>
<h4 id="可行性分析-1"><a href="#可行性分析-1" class="headerlink" title="可行性分析"></a><strong>可行性分析</strong></h4><ul>
<li><p><strong>时间复杂度:</strong></p>
<ul>
<li>该方案的核心计算流程与 V1.0 完全一致，依然是“离散化 + 两次 <code>n</code> 循环内嵌 <code>log size</code> 操作”。因此，<strong>总时间复杂度仍然是 <code>O(n log n)</code></strong>，性能上依然高效。</li>
</ul>
</li>
<li><p><strong>空间复杂度:</strong></p>
<ul>
<li>与 V1.0 的唯一区别在于结果数组。<code>ans_a</code> 的大小为 <code>n</code>，替代了 V1.0 中大小为 <code>size</code> 的 <code>ans_c</code>。在最坏情况下 <code>size=n</code>，两者空间占用相当。</li>
<li><strong>总空间复杂度依然为 <code>O(n)</code></strong>。</li>
</ul>
</li>
<li><p><strong>结论：</strong><br>从时间&#x2F;空间复杂度的角度分析，<strong>方案可行</strong>。</p>
</li>
</ul>
<h4 id="实现-1"><a href="#实现-1" class="headerlink" title="实现"></a><strong>实现</strong></h4><p>该方案通过以<strong>数组下标 <code>i</code> 关联原始位置</strong>，确保了数据归属的唯一性，且代码实现比 <strong>V1.0</strong> 更简洁。</p>
<img src="/2025/10/02/Luogu-P8613-Review/3.png" class="" title="AC提交记录">

<p><a target="_blank" rel="noopener" href="https://www.luogu.com.cn/record/237593958">最终AC提交记录</a></p>
<details>
<summary>点击展开/折叠 最终AC代码</summary>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> ll = <span class="type">long</span> <span class="type">long</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="type">const</span> maxn = <span class="number">1e5</span> + <span class="number">5</span>;</span><br><span class="line"><span class="type">int</span> n;</span><br><span class="line"></span><br><span class="line">vector&lt;<span class="type">int</span>&gt; a, b;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">lowbit</span><span class="params">(<span class="type">int</span> x)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> x &amp; -x;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">ll <span class="title">query</span><span class="params">(<span class="type">int</span> x, ll arr[])</span> </span>&#123;</span><br><span class="line">    ll ans_q = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = x; i != <span class="number">0</span>; i -= <span class="built_in">lowbit</span>(i)) &#123;</span><br><span class="line">        ans_q += arr[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ans_q;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">update</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> add, <span class="type">int</span> size, ll arr[])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = x; i &lt;= size; i += <span class="built_in">lowbit</span>(i)) &#123;</span><br><span class="line">        arr[i] += add;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">ll <span class="title">sum</span><span class="params">(ll x)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="number">1</span> + x) * x / <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ios_base::<span class="built_in">sync_with_stdio</span>(<span class="literal">false</span>);</span><br><span class="line">    cin.<span class="built_in">tie</span>(<span class="literal">NULL</span>);</span><br><span class="line">    a.<span class="built_in">reserve</span>(maxn);</span><br><span class="line">    b.<span class="built_in">reserve</span>(maxn);</span><br><span class="line">    cin &gt;&gt; n;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">        <span class="type">int</span> num;</span><br><span class="line">        cin &gt;&gt; num;</span><br><span class="line">        a.<span class="built_in">push_back</span>(num);</span><br><span class="line">        b.<span class="built_in">push_back</span>(num);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">sort</span>(b.<span class="built_in">begin</span>(), b.<span class="built_in">end</span>());</span><br><span class="line">    b.<span class="built_in">erase</span>(<span class="built_in">unique</span>(b.<span class="built_in">begin</span>(), b.<span class="built_in">end</span>()), b.<span class="built_in">end</span>());</span><br><span class="line">    <span class="type">int</span> size = b.<span class="built_in">size</span>();</span><br><span class="line">    ll cnt_c[size + <span class="number">5</span>] = &#123;<span class="number">0</span>&#125;, ans_a[n + <span class="number">5</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">        <span class="type">int</span> idx = <span class="built_in">lower_bound</span>(b.<span class="built_in">begin</span>(), b.<span class="built_in">end</span>(), a[i]) - b.<span class="built_in">begin</span>() + <span class="number">1</span>;</span><br><span class="line">        <span class="built_in">update</span>(idx, <span class="number">1</span>, size, cnt_c);</span><br><span class="line">        ans_a[i] += i + <span class="number">1</span> - <span class="built_in">query</span>(idx, cnt_c);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memset</span>(cnt_c, <span class="number">0</span>, <span class="built_in">sizeof</span>(cnt_c));</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = n - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        <span class="type">int</span> idx = <span class="built_in">lower_bound</span>(b.<span class="built_in">begin</span>(), b.<span class="built_in">end</span>(), a[i]) - b.<span class="built_in">begin</span>() + <span class="number">1</span>;</span><br><span class="line">        ans_a[i] += <span class="built_in">query</span>(idx - <span class="number">1</span>, cnt_c);</span><br><span class="line">        <span class="built_in">update</span>(idx, <span class="number">1</span>, size, cnt_c);</span><br><span class="line">    &#125;</span><br><span class="line">    ll ans = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">        ans += <span class="built_in">sum</span>(ans_a[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    cout &lt;&lt; ans &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</details>

<ul>
<li><p><strong>实现细节注意：正向与反向遍历的逻辑对称性</strong></p>
<p>我代码中的两次遍历，在 <code>update</code> 和 <code>query</code> 的顺序与逻辑上，展现了一种精妙的对称性，值得在此详细剖析。</p>
<ol>
<li><p><strong>正向遍历 (计算左逆序对): “先改后查”</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">    <span class="type">int</span> idx = <span class="built_in">lower_bound</span>(b.<span class="built_in">begin</span>(), b.<span class="built_in">end</span>(), a[i]) - b.<span class="built_in">begin</span>() + <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">update</span>(idx, <span class="number">1</span>, size, cnt_c);</span><br><span class="line">    ans_a[i] += i + <span class="number">1</span> - <span class="built_in">query</span>(idx, cnt_c);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>执行顺序</strong>:<br>先将当前元素 <code>a[i]</code> 加入树状数组 (<code>update</code>)，再进行查询 (<code>query</code>)。</li>
<li><strong>逻辑解读</strong>:<br><code>query(idx, cnt_c)</code> 查询的是<strong>包含 <code>a[i]</code> 自身在内</strong>的、<code>[0, i]</code> 区间中值小于等于 <code>a[i]</code> 的元素数量。因此，用已处理的总数 <code>i + 1</code> 减去它，就得到了 <code>[0, i]</code> 区间内值大于 <code>a[i]</code> 的数量。由于元素不可能大于自身，该结果精确等价于 <code>a[i]</code> 的左逆序对数。</li>
</ul>
</li>
<li><p><strong>反向遍历 (计算右逆序对): “先查后改”</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = n - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">    <span class="type">int</span> idx = <span class="built_in">lower_bound</span>(b.<span class="built_in">begin</span>(), b.<span class="built_in">end</span>(), a[i]) - b.<span class="built_in">begin</span>() + <span class="number">1</span>;</span><br><span class="line">    ans_a[i] += <span class="built_in">query</span>(idx - <span class="number">1</span>, cnt_c);</span><br><span class="line">    <span class="built_in">update</span>(idx, <span class="number">1</span>, size, cnt_c);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>执行顺序</strong>:<br>先进行查询 (<code>query</code>)，再将当前元素 <code>a[i]</code> 加入树状数组 (<code>update</code>)。</li>
<li><strong>逻辑解读</strong>:<br><code>query(idx - 1, cnt_c)</code> 查询的是<strong>在 <code>a[i]</code> 被加入之前</strong>，树状数组中已有的（即 <code>[i+1, n-1]</code> 区间内的）元素里，排名严格小于 <code>idx</code>（即值严格小于 <code>a[i]</code>）的数量。这直接就是 <code>a[i]</code> 的右逆序对数。</li>
</ul>
</li>
</ol>
<p><strong>对比总结：</strong><br>正向遍历采用“先改后查”的策略，通过总数减法巧妙地排除了自身的影响；而反向遍历则采用“先查后改”的策略，直接查询所需的结果。两者虽然实现顺序相反，但都最终达成了正确的计算目的，体现了算法实现的灵活性。</p>
</li>
</ul>
<hr>
<p><strong>P.S.</strong> 最后附上我做题时的杂乱草稿（</p>
<img src="/2025/10/02/Luogu-P8613-Review/4.jpg" class="" title="做题草稿">

<hr>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol>
<li><strong>问题转化的重要性</strong>：本题的核心在于将一个复杂的、带非线性成本的排序问题，成功转化为一个纯粹的、可分步计算的<strong>为序列中每个元素统计逆序对</strong>的组合计数问题。</li>
<li><strong>实现与模型的匹配</strong>：数据结构的选择与实现，必须在<strong>个体粒度</strong>上与问题模型保持一致。这是避免在存在重复元素时出现逻辑错误的关键。</li>
<li><strong>工具的正确使用</strong>：树状数组作为一种高效的动态前缀和工具，非常适合在本题的正、反向遍历中，进行动态的范围计数。</li>
</ol>
<p>希望本次复盘能为解决类似问题提供一个清晰的思路。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/09/22/%E4%BB%8E4%E5%B0%8F%E6%97%B6%E5%88%B02%E5%88%86%E9%92%9F%EF%BC%9A%E6%88%91%E7%9A%84GitHub-Profile%E8%87%AA%E5%8A%A8%E5%8C%96%E6%9E%84%E5%BB%BA%E4%B9%8B%E8%B7%AF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="nine19een">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="nine19een's Blog">
      <meta itemprop="description" content="记录学习过程中的思考、题解与复盘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | nine19een's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/09/22/%E4%BB%8E4%E5%B0%8F%E6%97%B6%E5%88%B02%E5%88%86%E9%92%9F%EF%BC%9A%E6%88%91%E7%9A%84GitHub-Profile%E8%87%AA%E5%8A%A8%E5%8C%96%E6%9E%84%E5%BB%BA%E4%B9%8B%E8%B7%AF/" class="post-title-link" itemprop="url">从 4 小时到 2 分钟：我的 GitHub Profile 自动化构建与持续集成之路</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-09-22 18:30:00 / 修改时间：19:41:45" itemprop="dateCreated datePublished" datetime="2025-09-22T18:30:00+08:00">2025-09-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%8A%80%E6%9C%AF%E5%AE%9E%E8%B7%B5/" itemprop="url" rel="index"><span itemprop="name">技术实践</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>高考结束后的那个夏天，我没有选择狂欢，而是一头扎进了代码的世界。当两个月的算法与数据结构探索之旅告一段落，我决心将这段经历记录下来，让努力留下可视化的痕迹。为了实现这个目标，我将目光投向了 GitHub ，我计划用 GitHub 为自己打造一个独一无二的、能够动态展示我的学习历程的个人主页。</p>
<p>我了解到，常规的 <code>git push</code> 会将所有提交的时间戳记为当前时刻，导致 GitHub 贡献图无法真实反映、精确还原我暑假期间的学习轨迹。</p>
<p>为了解决这一问题，并为未来的学习过程建立一个可追溯、可视化的档案，我设计并实施了本次手动迁移与版本历史构建的任务。</p>
<p>这篇文章，将详细记录我从连 Git 指令都敲不对，到最终利用 Python 脚本实现自动化操作的完整过程以及心路历程。</p>
<hr>
<h2 id="手动实现：基础工作流与问题排查"><a href="#手动实现：基础工作流与问题排查" class="headerlink" title="手动实现：基础工作流与问题排查"></a>手动实现：基础工作流与问题排查</h2><p>我决定采用 <code>git commit</code> 命令，为每一份题解代码创建带有历史时间戳的提交。这个方案虽然可行，但在手动执行的过程中，我遇到并解决了一系列典型的命令行与 Git 环境配置问题。下面将对这些问题进行复盘。</p>
<h3 id="核心实现思路"><a href="#核心实现思路" class="headerlink" title="核心实现思路"></a>核心实现思路</h3><p>本次操作的技术基石是 Git 的 <code>commit</code> 命令所提供的 <code>--date</code> 参数。该参数允许用户在创建提交时，指定一个自定义的时间戳，从而实现对版本历史的回溯性构建。</p>
<p>我设计的基础工作流的操作流程如下：</p>
<ol>
<li><p>将代码文件添加至工作区。</p>
</li>
<li><p>在代码文件的前四行手动添加格式规范的注释，格式如下：</p>
<p> <code>// Problem:  练习平台 题号 题目</code><br> <code>// Link:     题目链接</code><br> <code>// Author:   nine19een</code><br> <code>// Date:     日期</code><br> <code>//</code><br> <code>// 代码正文</code></p>
</li>
<li><p>使用 <code>git add</code> 将文件变更添加至暂存区。</p>
</li>
<li><p>执行带有特定历史日期的 <code>git commit</code> 命令以创建提交。</p>
</li>
</ol>
<p>核心命令示例：</p>
<p><strong><code>git commit --date=&quot;YYYY-MM-DD HH:MM:SS&quot; -m &quot;Creat 文件名&quot;</code></strong></p>
<p>其中，<code>--date</code> 参数用于指定历史时间戳，可通过练习平台的提交记录获取并手动替换进指令里。</p>
<h3 id="环境配置与故障排查"><a href="#环境配置与故障排查" class="headerlink" title="环境配置与故障排查"></a>环境配置与故障排查</h3><p>在将上述流程的实践过程中，我遇到并解决了以下几个典型的环境配置与命令行操作问题。</p>
<h4 id="Case-1-路径导航错误-No-such-file-or-directory"><a href="#Case-1-路径导航错误-No-such-file-or-directory" class="headerlink" title="Case 1: 路径导航错误 - No such file or directory"></a><strong>Case 1: 路径导航错误 - <code>No such file or directory</code></strong></h4><ul>
<li><p><strong>现象:</strong><br>在 Git Bash 环境下，使用 <code>cd</code> 命令并提供 Windows 文件管理器中的标准路径，无法成功切换目录，返回 <code>No such file or directory</code> 错误。</p>
</li>
<li><p><strong>问题分析:</strong><br>该错误源于 Windows 与类 Unix 环境 (Git Bash) 在路径表示法上的差异。主要有两点：</p>
<ol>
<li><strong>路径分隔符:</strong> Windows 使用 <code>\</code>，而 Git Bash 需要 <code>/</code>，因此，<strong>直接在Windows的文件资源管理器中复制路径并粘贴到 Git Bash 窗口是不可行的！</strong></li>
<li><strong>路径完整性:</strong> 必须提供从盘符开始的完整、正确的路径结构。</li>
</ol>
</li>
<li><p><strong>解决方案:</strong></p>
<ol>
<li><p><strong>格式修正:</strong> 若选择<strong>路径复制&#x2F;粘贴</strong>方案，需手动将路径中的 <code>\</code> 全部替换为 <code>/</code>，并确保路径完整（如 <code>C:/Users/YourName/Documents/...</code>）。</p>
</li>
<li><p><strong>GUI 辅助:</strong> 作为一种更高效且不易出错的方法，可以在 <code>cd </code> 命令后，直接将目标文件夹从文件管理器拖拽至 Git Bash 窗口，以自动生成符合其语法规范的完整路径。<strong>强烈建议使用该方法，不易出错</strong>。</p>
<img src="/2025/09/22/%E4%BB%8E4%E5%B0%8F%E6%97%B6%E5%88%B02%E5%88%86%E9%92%9F%EF%BC%9A%E6%88%91%E7%9A%84GitHub-Profile%E8%87%AA%E5%8A%A8%E5%8C%96%E6%9E%84%E5%BB%BA%E4%B9%8B%E8%B7%AF/1.jpg" class="" title="拖拽操作示例">

<p>将文件拖拽进 Git Bash 窗口即会自动生成完整路径。</p>
<img src="/2025/09/22/%E4%BB%8E4%E5%B0%8F%E6%97%B6%E5%88%B02%E5%88%86%E9%92%9F%EF%BC%9A%E6%88%91%E7%9A%84GitHub-Profile%E8%87%AA%E5%8A%A8%E5%8C%96%E6%9E%84%E5%BB%BA%E4%B9%8B%E8%B7%AF/2.jpg" class="" title="拖拽操作结果">

<p>再按回车即可。</p>
</li>
</ol>
</li>
</ul>
<h4 id="Case-2-仓库定位错误-fatal-not-a-git-repository"><a href="#Case-2-仓库定位错误-fatal-not-a-git-repository" class="headerlink" title="Case 2: 仓库定位错误 - fatal: not a git repository"></a><strong>Case 2: 仓库定位错误 - <code>fatal: not a git repository</code></strong></h4><ul>
<li><p><strong>现象:</strong><br>在 <code>git clone</code> 操作成功后，在当前目录（即 <code>clone</code> 命令的执行目录）下运行 <code>git status</code> 或 <code>git add</code> 等命令，系统返回致命错误，提示当前目录并非一个 Git 仓库。</p>
</li>
<li><p><strong>问题分析:</strong><br><code>git clone</code> 命令会在当前目录下创建一个<strong>新的子目录</strong>作为仓库的根目录。所有 Git 相关的操作，都必须在这个新生成的子目录（或其内部）执行，因为根目录中包含了必需的 <code>.git</code> 元数据文件夹。错误发生时，我正处在仓库的父目录。</p>
</li>
<li><p><strong>解决方案:</strong><br>执行 <code>git clone</code> 后，必须使用 <code>cd &lt;repository-name&gt;</code> 命令，<strong>进入到新克隆的仓库根目录</strong>，再执行后续的 Git 操作。</p>
</li>
</ul>
<h4 id="Case-3-网络连接失败-schannel-failed-to-receive-handshake-SSL-TLS-connection-failed"><a href="#Case-3-网络连接失败-schannel-failed-to-receive-handshake-SSL-TLS-connection-failed" class="headerlink" title="Case 3: 网络连接失败 - schannel: failed to receive handshake, SSL/TLS connection failed"></a><strong>Case 3: 网络连接失败 - <code>schannel: failed to receive handshake, SSL/TLS connection failed</code></strong></h4><ul>
<li><p><strong>现象:</strong><br>在解决了本地的路径和仓库定位问题后，我遇到了最棘手的一个 blocker。当执行 <code>git push</code>, <code>git pull</code>, <code>git fetch</code> 等任何需要与远程服务器通信的网络操作时，命令会在长时间等待后失败，并返回一个底层网络错误：<code>schannel: failed to receive handshake, SSL/TLS connection failed</code>。</p>
<p>最令人困惑的是，与此同时，我的浏览器却可以正常、快速地访问 <code>github.com</code> 网站。</p>
</li>
<li><p><strong>问题分析:</strong><br>这个现象——“浏览器可以，但命令行不行”——是一个非常典型的<strong>网络代理配置问题</strong>。</p>
<p>问题根源在于，我的电脑上运行了 Clash 这样的网络代理工具来优化网络访问。浏览器被正确配置为通过代理来访问 GitHub，所以连接顺畅。然而，Git Bash 作为一个独立的命令行环境，<strong>默认不会</strong>自动使用系统的代理设置。</p>
<p>因此，Git 仍在尝试<strong>直接连接</strong> GitHub 的服务器，这条直连路径受到了网络环境的干扰，导致在 SSL&#x2F;TLS 加密握手阶段就因超时而失败。<code>schannel</code> 是 Windows 系统用于处理此过程的内置安全库的名称。</p>
</li>
<li><p><strong>解决方案:</strong><br>解决方案的核心是：<strong>必须为 Git 命令行工具，手动配置与系统代理一致的代理服务器。</strong></p>
<p>这个过程分为两步：</p>
<ol>
<li><p><strong>定位代理端口号：</strong><br>首先，需要找到 Clash 代理软件为 HTTP&#x2F;HTTPS 协议监听的本地端口号。这里我以我使用的 Clash Verge 进行举例。</p>
<img src="/2025/09/22/%E4%BB%8E4%E5%B0%8F%E6%97%B6%E5%88%B02%E5%88%86%E9%92%9F%EF%BC%9A%E6%88%91%E7%9A%84GitHub-Profile%E8%87%AA%E5%8A%A8%E5%8C%96%E6%9E%84%E5%BB%BA%E4%B9%8B%E8%B7%AF/3.jpg" class="" title="寻找端口号">
</li>
<li><p><strong>为 Git 配置全局代理：</strong><br>接着，需要在 Git Bash 内执行以下两条命令，将 Git 的 <code>http.proxy</code> 和 <code>https.proxy</code> 都指向本地代理的监听地址 (<code>http://127.0.0.1:端口号</code>)。P.S. <code>127.0.0.1</code> 是一个永远指向本机的特殊 IP 地址。</p>
<ul>
<li><p>将 Git 的 HTTP 流量指向本地端口：</p>
<p><strong><code>git config --global http.proxy http://127.0.0.1:端口号</code></strong></p>
</li>
<li><p>将 Git 的 HTTPS 流量也指向本地端口 (关键)：</p>
<p><strong><code>git config --global https.proxy http://127.0.0.1:端口号</code></strong></p>
</li>
</ul>
</li>
</ol>
</li>
</ul>
<p>在执行完这两条命令，成功地为 Git “开启代理”之后，再次运行 <code>git fetch</code>，网络连接问题迎刃而解。</p>
<h4 id="Case-4-推送被拒绝-rejected-main-main-fetch-first"><a href="#Case-4-推送被拒绝-rejected-main-main-fetch-first" class="headerlink" title="Case 4: 推送被拒绝 - ! [rejected] main -&gt; main (fetch first)"></a><strong>Case 4: 推送被拒绝 - <code>! [rejected] main -&gt; main (fetch first)</code></strong></h4><ul>
<li><p><strong>现象:</strong><br>在本地进行 <code>commit</code> 操作后，执行 <code>git push</code> 时，推送被远程服务器拒绝。提示信息指出，远程仓库包含了本地所没有的修改。</p>
</li>
<li><p><strong>问题分析:</strong><br>这是 Git 的一种保护机制，旨在防止本地的推送<strong>意外覆盖</strong>掉远程仓库上其他人（或自己在别处）的提交。这种情况通常发生于：在本地 <code>clone</code> 或上次 <code>pull</code> 之后，远程仓库又有了新的 <code>commit</code>（例如，<strong>直接在 GitHub 网站上修改了 <code>README.md</code> 文件</strong>）。</p>
</li>
<li><p><strong>解决方案:</strong><br><strong>请务必在每次</strong> <code>git push</code> <strong>之前先执行</strong> <code>git pull</code> ，以确保本地和远程仓库的文件更新保持同步。</p>
<ol>
<li>执行 <code>git pull</code> 命令，将远程的最新变更下载到本地并自动合并。</li>
<li>在解决了可能出现的合并冲突（对于个人项目，通常会自动合并成功）后，再次执行 <code>git push</code>。</li>
</ol>
</li>
</ul>
<h4 id="Case-5-换行符警告-LF-will-be-replaced-by-CRLF"><a href="#Case-5-换行符警告-LF-will-be-replaced-by-CRLF" class="headerlink" title="Case 5: 换行符警告 - LF will be replaced by CRLF"></a><strong>Case 5: 换行符警告 - <code>LF will be replaced by CRLF</code></strong></h4><ul>
<li><p><strong>现象:</strong><br>在 <code>git add</code> 一个文件时，Git bash 会出现一条警告，提示文件中的 <code>LF</code> 将会被 <code>CRLF</code> 替换。</p>
</li>
<li><p><strong>问题分析:</strong><br>这是由于不同操作系统使用的换行符标准不同导致的。Unix&#x2F;Linux&#x2F;macOS 使用 <code>LF</code> ，而 Windows 使用 <code>CRLF</code> 。Git 内置了 <code>core.autocrlf</code> 功能，能够自动在不同系统间转换换行符，以保证版本库中的换行符格式统一。这个警告正是该功能在工作的体现。</p>
</li>
<li><p><strong>解决方案:</strong><br><strong>无视风险，继续访问</strong>（）。无需任何操作，可以安全地忽略此警告。因为这是 Git 的正常行为，代表它正在后台为我们处理跨平台兼容性问题。</p>
</li>
</ul>
<h4 id="Case-6-暂存区管理-在误操作后如何撤销-git-add"><a href="#Case-6-暂存区管理-在误操作后如何撤销-git-add" class="headerlink" title="Case 6: 暂存区管理 - 在误操作后如何撤销 git add"></a><strong>Case 6: 暂存区管理 - 在误操作后如何撤销 <code>git add</code></strong></h4><ul>
<li><p><strong>现象:</strong><br>在执行 <code>git add .</code> 后，发现将一些不需要的文件（或错误的修改）添加到了暂存区，需要在 <code>commit</code> 前进行撤销。</p>
</li>
<li><p><strong>问题分析:</strong><br>这是 Git 工作流中非常常见的需求。需要一个命令，能将文件从暂存区安全地移回工作区，而不丢失任何代码修改。</p>
</li>
<li><p><strong>解决方案:</strong></p>
<ol>
<li><p><strong>撤销所有暂存：</strong> 使用 <code>git reset</code> 命令，可以一次性清空整个暂存区。</p>
<p><strong><code>git reset</code></strong></p>
</li>
<li><p><strong>撤销单个文件：</strong> 使用 <code>git restore --staged &lt;file&gt;</code> 命令，可以精确地将指定文件移出暂存区。</p>
<p><strong><code>git restore --staged &lt;filename&gt;</code></strong></p>
</li>
</ol>
<p>这两种方式都<strong>不会修改工作区的文件内容</strong>，非常安全。</p>
</li>
</ul>
<hr>
<h2 id="自动化实现：从“体力劳动”到“系统构建”"><a href="#自动化实现：从“体力劳动”到“系统构建”" class="headerlink" title="自动化实现：从“体力劳动”到“系统构建”"></a>自动化实现：从“体力劳动”到“系统构建”</h2><p><strong>历时四个小时</strong>的手动历史提交迁移结束后，我立刻意识到：为这上百份题解代码，手动在 <code>README.md</code> 中创建并维护一个格式统一、内容准确、且按日期排序的表格，<del>不仅极度耗时，且极易出错。</del><strong>我会死掉的</strong>。</p>
<p>因此，我决定采用 Python 编写自动化脚本，将整个 <code>README.md</code> 的更新流程自动化。P.S.<del>懒惰是人类的第一生产力。</del></p>
<h3 id="核心思路：两阶段任务分解"><a href="#核心思路：两阶段任务分解" class="headerlink" title="核心思路：两阶段任务分解"></a>核心思路：两阶段任务分解</h3><p>为了降低复杂度并确保每一步都稳定可靠，我将整个自动化任务分解为两个独立的、前后关联的子项目：</p>
<ol>
<li><p><strong>项目一：源代码注释规范化</strong></p>
<ul>
<li><p><strong>目标：</strong> 遍历所有源代码文件，对所有注释不规范的代码进行更新，注释格式详见<strong>手动实现：基础工作流与问题排查 - 核心实现思路 - 2.</strong>。</p>
</li>
<li><p><strong>作用：</strong> 为后续的 <code>README</code> 生成器提供一个统一、可靠、可离线解析的数据源。</p>
</li>
</ul>
</li>
<li><p><strong>项目二：README 生成器</strong></p>
<ul>
<li><p><strong>目标：</strong> 读取所有经过规范化的源代码文件，提取其头部注释中的元数据，并生成最终的、完整的 Markdown 表格，用于在 <code>README.md</code> 中生成一个包含所有题目&#x2F;题解信息的表格。</p>
</li>
<li><p><strong>作用：</strong> 彻底替代手动编辑 <code>README</code> 的工作。</p>
</li>
</ul>
</li>
</ol>
<h3 id="项目一：源代码注释规范化脚本"><a href="#项目一：源代码注释规范化脚本" class="headerlink" title="项目一：源代码注释规范化脚本"></a>项目一：源代码注释规范化脚本</h3><h4 id="Case-1-编码格式不统一-中文乱码"><a href="#Case-1-编码格式不统一-中文乱码" class="headerlink" title="Case 1: 编码格式不统一 - 中文乱码"></a><strong>Case 1: 编码格式不统一 - 中文乱码</strong></h4><ul>
<li><p><strong>现象:</strong><br>当我在脚本尝试读取 <code>.cpp</code> 文件内容时，或在使用 CLion 打开从 GitHub 克隆的文件时，文件中的中文注释显示为乱码。</p>
</li>
<li><p><strong>问题分析:</strong><br>这是典型的字符编码不匹配问题。GitHub 和 CLion 默认使用 <code>UTF-8</code> 编码，它兼容全球所有语言。而我之前做题时使用的 Dev-C++ 在 Windows环境下，默认使用本地化的 <code>GBK</code> 编码保存文件。当一个程序尝试用 <code>UTF-8</code> 编码去读取一个 <code>GBK</code> 编码的文件时，就会产生乱码。</p>
</li>
<li><p><strong>解决方案:</strong><br>在整个开发链条中，强制统一使用 <code>UTF-8</code> 编码。</p>
<ol>
<li><strong>开发环境迁移：</strong> 彻底弃用对 <code>UTF-8</code> 支持不佳的旧 IDE，将主力开发环境迁移至现代化、默认使用 <code>UTF-8</code> 的 CLion。</li>
<li><strong>脚本读写配置：</strong> 在 Python 脚本中，使用 <code>open()</code> 函数时，明确指定 <code>encoding</code> 参数。读取时使用 <code>encoding=&#39;utf-8-sig&#39;</code> 以兼容 Windows 下带 BOM 的 UTF-8 文件，写入时使用 <code>encoding=&#39;utf-8&#39;</code>。<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 读取时指定编码</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8-sig&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    lines = f.readlines()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 写入时同样指定编码</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.writelines(lines)</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
</ul>
<h4 id="最终脚本：update-sources-py"><a href="#最终脚本：update-sources-py" class="headerlink" title="最终脚本：update_sources.py"></a><strong>最终脚本：<code>update_sources.py</code></strong></h4><p>该脚本的核心逻辑是：遍历指定目录下的所有 C++ 文件，检查其是否已包含标准注释头。如果没有，则从文件名中解析题号，通过网络请求访问题目 URL 抓取完整标题，并从 Git 历史中获取文件首次提交的日期。最后，将这些元数据整合成标准格式的注释块，并重写回文件头部。</p>
<p>在让Gemini充分了解了我的诉求后，一份自动化更新注释的 Python 脚本便诞生了。</p>
<details>
<summary>点击展开/折叠 `update_sources.py` 完整代码</summary>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">REPO_FOLDER = <span class="string">&quot;Coding-Practice&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_luogu_title</span>(<span class="params">url</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        headers = &#123;</span><br><span class="line">            <span class="string">&#x27;User-Agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        response = requests.get(url, headers=headers, timeout=<span class="number">10</span>)</span><br><span class="line">        response.raise_for_status()</span><br><span class="line"></span><br><span class="line">        soup = BeautifulSoup(response.text, <span class="string">&#x27;lxml&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        title_tag = soup.find(<span class="string">&#x27;h1&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> title_tag:</span><br><span class="line">            <span class="keyword">return</span> title_tag.get_text(strip=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">except</span> requests.exceptions.RequestException <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;    - 网络错误: 无法访问 <span class="subst">&#123;url&#125;</span> - <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_file</span>(<span class="params">file_path</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8-sig&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            lines = f.readlines()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> lines:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;  - 跳过 (文件为空): <span class="subst">&#123;os.path.basename(file_path)&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        first_line_content = lines[<span class="number">0</span>].strip()</span><br><span class="line">        <span class="keyword">if</span> first_line_content == <span class="string">&quot;// Problem:  Luogu&quot;</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;  - 处理中: <span class="subst">&#123;os.path.basename(file_path)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">            link_url = <span class="string">&quot;&quot;</span></span><br><span class="line">            <span class="keyword">for</span> line <span class="keyword">in</span> lines:</span><br><span class="line">                <span class="keyword">if</span> <span class="string">&quot;// Link:&quot;</span> <span class="keyword">in</span> line:</span><br><span class="line">                    <span class="keyword">match</span> = re.search(<span class="string">r&#x27;https?://[^\s]+&#x27;</span>, line)</span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">match</span>:</span><br><span class="line">                        link_url = <span class="keyword">match</span>.group(<span class="number">0</span>)</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> link_url:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;    - 错误: 在文件中未找到有效的 Link URL。&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">            title = get_luogu_title(link_url)</span><br><span class="line">            time.sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> title:</span><br><span class="line">                lines[<span class="number">0</span>] = <span class="string">f&quot;// Problem:  Luogu <span class="subst">&#123;title&#125;</span>\n&quot;</span></span><br><span class="line">                <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                    f.writelines(lines)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;    - 更新成功！标题已设置为: <span class="subst">&#123;title&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;    - 更新失败: 未能从 <span class="subst">&#123;link_url&#125;</span> 获取标题。&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;  - 跳过 (已处理): <span class="subst">&#123;os.path.basename(file_path)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;  - 处理文件时发生未知错误: <span class="subst">&#123;os.path.basename(file_path)&#125;</span> - <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.isdir(REPO_FOLDER):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;错误: 文件夹 &#x27;<span class="subst">&#123;REPO_FOLDER&#125;</span>&#x27; 不存在。请确保脚本和该文件夹在同一目录下。&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;--- 开始扫描文件夹: <span class="subst">&#123;REPO_FOLDER&#125;</span> ---&quot;</span>)</span><br><span class="line"></span><br><span class="line">    all_files = <span class="built_in">sorted</span>([f <span class="keyword">for</span> f <span class="keyword">in</span> os.listdir(REPO_FOLDER) <span class="keyword">if</span> f.startswith(<span class="string">&quot;Luogu&quot;</span>) <span class="keyword">and</span> f.endswith(<span class="string">&quot;.cpp&quot;</span>)])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> filename <span class="keyword">in</span> all_files:</span><br><span class="line">        full_path = os.path.join(REPO_FOLDER, filename)</span><br><span class="line">        process_file(full_path)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n--- 扫描完成 ---&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

</details>

<h3 id="项目二：README-生成器脚本"><a href="#项目二：README-生成器脚本" class="headerlink" title="项目二：README 生成器脚本"></a>项目二：README 生成器脚本</h3><p>在所有源文件都拥有了标准化的元数据之后，生成 <code>README</code> 的任务就变得纯粹而直接。</p>
<h4 id="Case-1-爬虫失效"><a href="#Case-1-爬虫失效" class="headerlink" title="Case 1: 爬虫失效"></a><strong>Case 1: 爬虫失效</strong></h4><ul>
<li><p><strong>现象:</strong><br>在 <code>update_sources.py</code> 的开发过程中，用于抓取洛谷题目难度的爬虫函数，在多次尝试后依然反复失效，返回 <code>N/A</code> 或空的页面内容，即便 URL 在浏览器中可以正常访问。</p>
</li>
<li><p><strong>问题分析:</strong><br>我编写了一个独立的脚本，将 <code>requests</code> 库获取到的原始 HTML 内容保存下来后，发现我收到的并非洛谷的题目页面，而是 Cloudflare 的人机验证页面。大概是我的操作被 Cloudflare 的反爬虫机制识别并拦截了。</p>
</li>
<li><p><strong>解决方案：</strong></p>
<ol>
<li><strong>方案迭代：</strong> 我先后尝试了多种爬虫策略，包括更换 User-Agent、寻找特定的 HTML 标签（洛谷难度标签为<code>&lt;span&gt;</code>）、甚至用正则表达式直接匹配页面数据脚本，但都因为反爬虫机制的存在而宣告失败。</li>
<li><strong>最终方案：</strong> 我突然意识到，这些题目与其对应的难度，我可以<strong>直接从洛谷个人主页里保存到本地</strong>，将其变成静态数据。</li>
</ol>
<img src="/2025/09/22/%E4%BB%8E4%E5%B0%8F%E6%97%B6%E5%88%B02%E5%88%86%E9%92%9F%EF%BC%9A%E6%88%91%E7%9A%84GitHub-Profile%E8%87%AA%E5%8A%A8%E5%8C%96%E6%9E%84%E5%BB%BA%E4%B9%8B%E8%B7%AF/4.jpg" class="" title="洛谷主页">

<p>因此，我做出了一个关键的架构决策：<strong>放弃动态爬取，转向静态的本地数据源。</strong></p>
<p>我将所有题目的难度信息，手动整理成一个 Python 字典，直接内置在脚本中。</p>
<pre><code><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 本地难度数据库示例</span></span><br><span class="line">DIFFICULTY_DATA = &#123;</span><br><span class="line">    <span class="string">&quot;P1001&quot;</span>: <span class="string">&quot;入门&quot;</span>,</span><br><span class="line">    <span class="string">&quot;P1002&quot;</span>: <span class="string">&quot;普及−&quot;</span>,</span><br><span class="line">    <span class="comment"># ... and so on</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</code></pre>
<p>这个决策，让脚本彻底摆脱了 Cloudflare 的困扰，<strong>100% 可靠且运行速度速度极佳</strong>，也易于长期维护。</p>
</li>
</ul>
<h4 id="Case-2-逻辑疏漏"><a href="#Case-2-逻辑疏漏" class="headerlink" title="Case 2: 逻辑疏漏"></a><strong>Case 2: 逻辑疏漏</strong></h4><ul>
<li><p><strong>现象:</strong><br>脚本初版成功生成了所有新题目的表格行，但在后续迭代中，我发现它会丢失 <code>README.md</code> 中已有的、非洛谷平台的记录（如 Codeforces）。</p>
</li>
<li><p><strong>问题分析:</strong><br>我的脚本只考虑了“生成新的”，而没有考虑“保留旧的”和“合并排序”。</p>
</li>
<li><p><strong>解决方案:</strong><br>重构脚本的核心逻辑，使其具备多平台兼容性：</p>
<ol>
<li><strong>全面读取：</strong> 读取旧 <code>README</code> 时，不再只筛选洛谷题目，而是将所有表格行都加载到内存中。</li>
<li><strong>增量处理：</strong> 只为那些<strong>文件名</strong>不存在于旧记录中的新文件，生成新的表格行。</li>
<li><strong>合并排序：</strong> 将新生成的行与所有旧的行合并成一个总列表，最后对这个总列表，进行统一的日期降序排序。</li>
</ol>
</li>
</ul>
<h4 id="最终脚本：generate-readme-py"><a href="#最终脚本：generate-readme-py" class="headerlink" title="最终脚本：generate_readme.py"></a><strong>最终脚本：<code>generate_readme.py</code></strong></h4><p>这是经历了多次重构和 BUG 修复后的最终版本。它整合了本地难度数据库、多平台兼容、增量更新和全量排序等所有功能。</p>
<p>脚本运行后，会生成一个 <code>update.txt</code> 文件，包含了所有新旧题目的、完美排序的最终表格，我只需要将其整体复制并替换 <code>README.md</code> 中的旧表格即可。</p>
<details>
<summary>点击展开/折叠 `update_sources.py` 完整代码</summary>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> unquote</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- Configuration ---</span></span><br><span class="line">GITHUB_USERNAME = <span class="string">&quot;nine19een&quot;</span></span><br><span class="line">REPO_NAME = <span class="string">&quot;Coding-Practice&quot;</span></span><br><span class="line">SOURCE_CODE_PATH = <span class="string">&quot;Coding-Practice&quot;</span></span><br><span class="line">README_FILE_PATH = <span class="string">&quot;README.md&quot;</span></span><br><span class="line">OUTPUT_FILENAME = <span class="string">&quot;update.txt&quot;</span></span><br><span class="line"><span class="comment"># ---------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ==============================================================================</span></span><br><span class="line"><span class="comment"># Local Difficulty Database</span></span><br><span class="line"><span class="comment"># ==============================================================================</span></span><br><span class="line">DIFFICULTY_DATA = &#123;</span><br><span class="line">    <span class="string">&quot;P1001&quot;</span>: <span class="string">&quot;入门&quot;</span>, <span class="string">&quot;P1046&quot;</span>: <span class="string">&quot;入门&quot;</span>, <span class="string">&quot;P1047&quot;</span>: <span class="string">&quot;入门&quot;</span>, <span class="string">&quot;P1085&quot;</span>: <span class="string">&quot;入门&quot;</span>,</span><br><span class="line">    <span class="comment"># 略</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># ==============================================================================</span></span><br><span class="line"></span><br><span class="line">BADGE_TEMPLATES = &#123;</span><br><span class="line">    <span class="string">&quot;入门&quot;</span>: <span class="string">&#x27;&lt;img src=&quot;https://img.shields.io/badge/入门-FE4C61?style=for-the-badge&amp;textColor=white&quot; alt=&quot;入门&quot;&gt;&#x27;</span>,</span><br><span class="line">    <span class="string">&quot;普及−&quot;</span>: <span class="string">&#x27;&lt;img src=&quot;https://img.shields.io/badge/普及−-F39C11?style=for-the-badge&amp;textColor=white&quot; alt=&quot;普及−&quot;&gt;&#x27;</span>,</span><br><span class="line">    <span class="comment"># 略</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_existing_entries</span>(<span class="params">readme_path</span>):</span><br><span class="line">    existing_entries = []</span><br><span class="line">    in_table_section = <span class="literal">False</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(readme_path):</span><br><span class="line">        <span class="keyword">return</span> existing_entries</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(readme_path, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">                <span class="keyword">if</span> line.strip().startswith(<span class="string">&#x27;| :---&#x27;</span>):</span><br><span class="line">                    in_table_section = <span class="literal">True</span></span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                <span class="keyword">if</span> in_table_section <span class="keyword">and</span> (<span class="keyword">not</span> line.strip().startswith(<span class="string">&#x27;|&#x27;</span>) <span class="keyword">or</span> <span class="keyword">not</span> line.strip()):</span><br><span class="line">                    in_table_section = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> in_table_section:</span><br><span class="line">                    date_match = re.search(<span class="string">r&#x27;\|\s*(\d&#123;4&#125;-\d&#123;2&#125;-\d&#123;2&#125;)&#x27;</span>, line)</span><br><span class="line">                    date_str = date_match.group(<span class="number">1</span>) <span class="keyword">if</span> date_match <span class="keyword">else</span> <span class="string">&quot;1970-01-01&quot;</span></span><br><span class="line">                    existing_entries.append(&#123;</span><br><span class="line">                        <span class="string">&quot;date_obj&quot;</span>: datetime.strptime(date_str, <span class="string">&#x27;%Y-%m-%d&#x27;</span>),</span><br><span class="line">                        <span class="string">&quot;row&quot;</span>: line.strip()</span><br><span class="line">                    &#125;)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Warning: Failed to read README file: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> existing_entries</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse_source_file_metadata</span>(<span class="params">file_path</span>):</span><br><span class="line">    metadata = &#123;<span class="string">&#x27;platform&#x27;</span>: <span class="string">&#x27;unknown&#x27;</span>&#125;</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8-sig&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            content = f.read()</span><br><span class="line"></span><br><span class="line">        date_match = re.search(<span class="string">r&#x27;//\s*Date:\s*(\d&#123;4&#125;-\d&#123;2&#125;-\d&#123;2&#125;)&#x27;</span>, content)</span><br><span class="line">        <span class="keyword">if</span> date_match: metadata[<span class="string">&#x27;date&#x27;</span>] = date_match.group(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        link_match = re.search(<span class="string">r&#x27;//\s*Link:\s*(https?://[^\s]+)&#x27;</span>, content)</span><br><span class="line">        <span class="keyword">if</span> link_match: metadata[<span class="string">&#x27;link&#x27;</span>] = link_match.group(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        problem_match = re.search(<span class="string">r&#x27;//\s*Problem:\s*(.*)&#x27;</span>, content)</span><br><span class="line">        <span class="keyword">if</span> problem_match:</span><br><span class="line">            line_content = problem_match.group(<span class="number">1</span>).strip()</span><br><span class="line">            <span class="keyword">if</span> line_content.lower().startswith(<span class="string">&quot;luogu&quot;</span>):</span><br><span class="line">                metadata[<span class="string">&#x27;platform&#x27;</span>] = <span class="string">&#x27;luogu&#x27;</span></span><br><span class="line">                metadata[<span class="string">&#x27;details&#x27;</span>] = line_content[<span class="number">5</span>:].strip()</span><br><span class="line">            <span class="keyword">elif</span> line_content.lower().startswith(<span class="string">&quot;codeforces&quot;</span>):</span><br><span class="line">                metadata[<span class="string">&#x27;platform&#x27;</span>] = <span class="string">&#x27;codeforces&#x27;</span></span><br><span class="line">                metadata[<span class="string">&#x27;details&#x27;</span>] = line_content[<span class="number">10</span>:].strip()</span><br><span class="line">            <span class="keyword">elif</span> line_content.lower().startswith(<span class="string">&quot;opj&quot;</span>):</span><br><span class="line">                metadata[<span class="string">&#x27;platform&#x27;</span>] = <span class="string">&#x27;opj&#x27;</span></span><br><span class="line">                metadata[<span class="string">&#x27;details&#x27;</span>] = line_content[<span class="number">3</span>:].strip()</span><br><span class="line">        <span class="keyword">return</span> metadata</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;    - Error: Failed to parse file <span class="subst">&#123;os.path.basename(file_path)&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">build_markdown_row</span>(<span class="params">metadata, filename</span>):</span><br><span class="line">    date = metadata.get(<span class="string">&#x27;date&#x27;</span>, <span class="string">&#x27;N/A&#x27;</span>)</span><br><span class="line">    platform = metadata.get(<span class="string">&#x27;platform&#x27;</span>)</span><br><span class="line">    details = metadata.get(<span class="string">&#x27;details&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    link = metadata.get(<span class="string">&#x27;link&#x27;</span>, <span class="string">&#x27;#&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    problem_md, difficulty_badge = <span class="string">f&quot;[<span class="subst">&#123;platform&#125;</span>-<span class="subst">&#123;details&#125;</span>](<span class="subst">&#123;link&#125;</span>)&quot;</span>, <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> platform == <span class="string">&#x27;luogu&#x27;</span>:</span><br><span class="line">        pid_match = re.search(<span class="string">r&#x27;([PB]\d+)&#x27;</span>, details)</span><br><span class="line">        <span class="keyword">if</span> pid_match:</span><br><span class="line">            problem_id = pid_match.group(<span class="number">1</span>)</span><br><span class="line">            title = re.sub(<span class="string">r&#x27;「.*?」|\[.*?\]|【.*?】&#x27;</span>, <span class="string">&#x27;&#x27;</span>, details).replace(problem_id, <span class="string">&#x27;&#x27;</span>).strip()</span><br><span class="line">            problem_md = <span class="string">f&quot;[<span class="subst">&#123;<span class="string">&#x27;洛谷&#x27;</span>&#125;</span>-<span class="subst">&#123;problem_id&#125;</span>-<span class="subst">&#123;title&#125;</span>](<span class="subst">&#123;link&#125;</span>)&quot;</span></span><br><span class="line">            difficulty_text = DIFFICULTY_DATA.get(problem_id, <span class="string">&quot;未定义&quot;</span>)</span><br><span class="line">            difficulty_badge = BADGE_TEMPLATES.get(difficulty_text, BADGE_TEMPLATES[<span class="string">&quot;未定义&quot;</span>])</span><br><span class="line">    <span class="keyword">elif</span> platform == <span class="string">&#x27;codeforces&#x27;</span>:</span><br><span class="line">        id_letter_match = re.search(<span class="string">r&#x27;-([A-F]\d?)-&#x27;</span>, filename) <span class="keyword">or</span> re.search(<span class="string">r&#x27;\s+([A-F]\d?)\.&#x27;</span>, details)</span><br><span class="line">        <span class="keyword">if</span> id_letter_match:</span><br><span class="line">            id_letter = id_letter_match.group(<span class="number">1</span>)[<span class="number">0</span>]</span><br><span class="line">            badge_key = <span class="string">f&quot;Div.4 <span class="subst">&#123;id_letter&#125;</span>&quot;</span></span><br><span class="line">            difficulty_badge = BADGE_TEMPLATES.get(badge_key, <span class="string">&quot;**CF**&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            difficulty_badge = <span class="string">&quot;**CF**&quot;</span></span><br><span class="line">        problem_md = <span class="string">f&quot;[Codeforces-<span class="subst">&#123;details&#125;</span>](<span class="subst">&#123;link&#125;</span>)&quot;</span></span><br><span class="line">    <span class="keyword">elif</span> platform == <span class="string">&#x27;opj&#x27;</span>:</span><br><span class="line">        pid_match = re.search(<span class="string">r&#x27;(\d+)&#x27;</span>, details)</span><br><span class="line">        problem_id = pid_match.group(<span class="number">1</span>) <span class="keyword">if</span> pid_match <span class="keyword">else</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">        title = details.replace(problem_id, <span class="string">&#x27;&#x27;</span>).strip()</span><br><span class="line">        problem_md = <span class="string">f&quot;[opj-<span class="subst">&#123;problem_id&#125;</span>-<span class="subst">&#123;title&#125;</span>](<span class="subst">&#123;link&#125;</span>)&quot;</span></span><br><span class="line">        difficulty_badge = BADGE_TEMPLATES.get(<span class="string">&quot;基础&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">    safe_filename = filename.replace(<span class="string">&#x27;+&#x27;</span>, <span class="string">&#x27;%2B&#x27;</span>)</span><br><span class="line">    solution_md = <span class="string">f&quot;[View Code (C++)](https://github.com/<span class="subst">&#123;GITHUB_USERNAME&#125;</span>/<span class="subst">&#123;REPO_NAME&#125;</span>/blob/main/<span class="subst">&#123;safe_filename&#125;</span>)&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="string">&quot;date_obj&quot;</span>: datetime.strptime(date, <span class="string">&#x27;%Y-%m-%d&#x27;</span>),</span><br><span class="line">        <span class="string">&quot;row&quot;</span>: <span class="string">f&quot;| <span class="subst">&#123;date&#125;</span> | <span class="subst">&#123;problem_md&#125;</span> | <span class="subst">&#123;difficulty_badge&#125;</span> | <span class="subst">&#123;solution_md&#125;</span> |&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;--- Initializing README Generation ---&quot;</span>)</span><br><span class="line"></span><br><span class="line">    existing_entries = load_existing_entries(README_FILE_PATH)</span><br><span class="line">    existing_filenames = <span class="built_in">set</span>(unquote(re.search(<span class="string">r&#x27;/main/(.*)\)&#x27;</span>, entry[<span class="string">&#x27;row&#x27;</span>]).group(<span class="number">1</span>)) <span class="keyword">for</span> entry <span class="keyword">in</span> existing_entries <span class="keyword">if</span> re.search(<span class="string">r&#x27;/main/(.*)\)&#x27;</span>, entry[<span class="string">&#x27;row&#x27;</span>]))</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Found <span class="subst">&#123;<span class="built_in">len</span>(existing_entries)&#125;</span> existing entries in README.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    all_entries = existing_entries</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.isdir(SOURCE_CODE_PATH):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Error: Source code directory &#x27;<span class="subst">&#123;SOURCE_CODE_PATH&#125;</span>&#x27; not found.&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;\n--- Scanning for new source files in <span class="subst">&#123;SOURCE_CODE_PATH&#125;</span> ---&quot;</span>)</span><br><span class="line"></span><br><span class="line">    all_cpp_files = <span class="built_in">sorted</span>([f <span class="keyword">for</span> f <span class="keyword">in</span> os.listdir(SOURCE_CODE_PATH) <span class="keyword">if</span> f.endswith(<span class="string">&quot;.cpp&quot;</span>)])</span><br><span class="line">    new_files_processed = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> filename <span class="keyword">in</span> all_cpp_files:</span><br><span class="line">        <span class="keyword">if</span> filename <span class="keyword">in</span> existing_filenames:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;  - Processing new file: <span class="subst">&#123;filename&#125;</span>&quot;</span>)</span><br><span class="line">        new_files_processed += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        file_path = os.path.join(SOURCE_CODE_PATH, filename)</span><br><span class="line">        metadata = parse_source_file_metadata(file_path)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> metadata <span class="keyword">or</span> <span class="string">&#x27;date&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> metadata:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;    - Warning: Could not parse required metadata from <span class="subst">&#123;filename&#125;</span>. Skipping.&quot;</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        new_entry = build_markdown_row(metadata, filename)</span><br><span class="line">        all_entries.append(new_entry)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> new_files_processed == <span class="number">0</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n--- No new files to add. README is up to date. ---&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;\n--- Processed <span class="subst">&#123;new_files_processed&#125;</span> new files. Generating final table. ---&quot;</span>)</span><br><span class="line"></span><br><span class="line">    all_entries.sort(key=<span class="keyword">lambda</span> x: x[<span class="string">&#x27;date_obj&#x27;</span>], reverse=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(OUTPUT_FILENAME, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(<span class="string">&quot;| Date       | Problem                                                    | Difficulty                                                                                                   | Solution                                                                                  |\n&quot;</span>)</span><br><span class="line">            f.write(<span class="string">&quot;| :--------- | :--------------------------------------------------------- | :----------------------------------------------------------------------------------------------------------- | :---------------------------------------------------------------------------------------- |\n&quot;</span>)</span><br><span class="line">            <span class="keyword">for</span> entry <span class="keyword">in</span> all_entries:</span><br><span class="line">                f.write(entry[<span class="string">&#x27;row&#x27;</span>] + <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n&quot;</span> + <span class="string">&quot;=&quot;</span>*<span class="number">50</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Success! The complete and sorted table has been saved to:&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;os.path.abspath(OUTPUT_FILENAME)&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Please copy the entire content of this file and replace the old table in your README.&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span>*<span class="number">50</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\nError! Failed to write output file: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

</details>

<hr>
<h2 id="最终成果展示"><a href="#最终成果展示" class="headerlink" title="最终成果展示"></a>最终成果展示</h2><p>经过上述一系列的手动迁移、自动化脚本构建与 <code>README.md</code> 内容生成，我的 GitHub Profile 最终呈现为一个动态更新、信息丰富的个人技术档案。</p>
<p>它现在不仅包含了<strong>真实反映我学习时间的贡献图</strong>，还有一个<strong>内容详尽、格式统一、且能够通过自动化脚本持续更新的刷题记录面板</strong>。</p>
<img src="/2025/09/22/%E4%BB%8E4%E5%B0%8F%E6%97%B6%E5%88%B02%E5%88%86%E9%92%9F%EF%BC%9A%E6%88%91%E7%9A%84GitHub-Profile%E8%87%AA%E5%8A%A8%E5%8C%96%E6%9E%84%E5%BB%BA%E4%B9%8B%E8%B7%AF/5.png" class="" title="github主页">

<p>这个 Profile 将忠实地记录下我大学四年走的每一步。</p>
<p><strong>欢迎访问我的➡️ <strong><a target="_blank" rel="noopener" href="https://github.com/nine19een">GitHub 主页</a></strong> ⬅️以查看最新进展与项目源码，也欢迎各位大佬前来指点~</strong></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>





</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">nine19een</span>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
